[1mdiff --git a/application/api/controller/Userurl.php b/application/api/controller/Userurl.php[m
[1mindex a68e3a8..f0baa71 100755[m
[1m--- a/application/api/controller/Userurl.php[m
[1m+++ b/application/api/controller/Userurl.php[m
[36m@@ -35,7 +35,6 @@[m [muse app\index\model\MemberCert;[m
 use app\index\model\MemberNet;[m
 use app\index\model\Reimbur;[m
 use app\index\model\Appversion; [m
[31m-use app\index\model\Commission as Commissions; [m
 use app\index\model\SmsCode; [m
 use app\index\model\ArticleCategory;[m
 use app\index\model\Article;[m
[36m@@ -55,39 +54,40 @@[m [mclass Userurl extends Controller[m
        $this->param=request()->param();[m
         try{[m
              if(!isset($this->param['uid']) || empty($this->param['uid']) || !isset($this->param['token']) ||empty($this->param['token'])){[m
[31m-                echo '<li style="margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;">å½“å‰ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•</li>';die;[m
[32m+[m[41m             [m	[32mecho '<li style="margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;">å½“å‰ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•</li>';die;[m
              }[m
[31m-                 [m
[32m+[m[41m             	 [m
                    // $this->error=314;[m
              #æŸ¥æ‰¾åˆ°å½“å‰ç”¨æˆ·[m
              $member=Members::haswhere('memberLogin',['login_token'=>$this->param['token']])->where('member_id', $this->param['uid'])->find();[m
              if(!$member && !$this->error){[m
[31m-                echo '<li style="margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;">å½“å‰ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•</li>';die;[m
[32m+[m[41m             [m	[32mecho '<li style="margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;">å½“å‰ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•</li>';die;[m
              }[m
         }catch (\Exception $e) {[m
[31m-            echo '<li style="margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;">å½“å‰ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•</li>';die;[m
[31m-              $this->assign('msg','å½“å‰ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');[m
[32m+[m[41m        [m	[32mecho '<li style="margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;">å½“å‰ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•</li>';die;[m
[32m+[m[41m        [m	[32m  $this->assign('msg','å½“å‰ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');[m
              // $this->error=317;[m
         }[m
         if($this->error){[m
[31m-            $msg=Config::get('response.'.$this->error) ? Config::get('response.'.$this->error) : "ç³»ç»Ÿé”™è¯¯~";[m
[31m-                echo "<li style='margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;'>{$msg}}</li>";die;[m
[32m+[m			[32m$msg=Config::get('response.'.$this->error) ? Config::get('response.'.$this->error) : "ç³»ç»Ÿé”™è¯¯~";[m
[32m+[m				[32mecho "<li style='margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;'>{$msg}}</li>";die;[m
             // exit(json_encode(['code'=>$this->error, 'msg'=>$msg, 'data'=>[]]));[m
         }[m
[31m-        $this->assign('uid',$this->param['uid']);[m
[31m-        $this->assign('token',$this->param['token']);[m
[32m+[m		[32m$this->assign('uid',$this->param['uid']);[m
[32m+[m		[32m$this->assign('token',$this->param['token']);[m
       }[m
 [m
       #ä¸“å±äºŒç»´ç åˆ—è¡¨[m
[31m-    public function exclusive_code(){[m
[31m-        $this->assign("name",System::getName("sitename"));[m
[31m-        $list = Exclusive::all();[m
[31m-        $this->assign("list",$list);[m
[31m-        return view("api/logic/share_code_list");[m
[31m-    }[m
[31m-    #å–ç°ç°æˆåŠŸé¡µé¢[m
[31m-    public function calllback_success(){[m
[31m-        // $request = $this->param;[m
[32m+[m	[32mpublic function exclusive_code(){[m
[32m+[m		[32m$this->assign("name",System::getName("sitename"));[m
[32m+[m	[32m    $list = Exclusive::all();[m
[32m+[m	[32m    $this->assign("list",$list);[m
[32m+[m	[32m    return view("api/logic/share_code_list");[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32m#å–ç°ç°æˆåŠŸé¡µé¢[m
[32m+[m	[32mpublic function calllback_success(){[m
[32m+[m		[32m// $request = $this->param;[m
     $request=file_get_contents("php://input");[m
     if(empty($request)){[m
        $data['result'] = -1;[m
[36m@@ -106,191 +106,188 @@[m [mclass Userurl extends Controller[m
         }[m
 [m
       $this->assign('data',$data);[m
[31m-        return view("Userurl/calllback_success");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:01:55+0800[m
[31m-     * @version  [ä¸“å±äºŒç»´ç ][m
[31m-     * @return   [type][m
[31m-     */[m
[31m-    public function exclusive_code_detail(){[m
[31m-        $this->checkToken();[m
[31m-        //è·å–å½“å‰æ‰‹æœºå·[m
[31m-        $tel=Members::get($this->param['uid']);[m
[31m-        $tel=$tel->member_mobile;[m
[31m-        //æ¨å¹¿è¿æ¥[m
[31m-        $url='http://'.$_SERVER['HTTP_HOST'].'/api/userurl/register/recomment/'.$tel;[m
[31m-        //èƒŒæ™¯å›¾ç‰‡ID[m
[31m-        $exclusive_id=$this->param['exclusive_id'];[m
[31m-        //è°ƒå–æ•°æ®åº“url[m
[31m-        $img=db('qrcode')->where(['qrcode_member_id'=>$this->param['uid'],'qrcode_exclusive_id'=>$exclusive_id])->find();[m
[31m-            // dump($img);die;[m
[31m-        if(!$img || !$img['qrcode_url']){[m
[31m-            $imgurl='autoimg/qrcode_'.$exclusive_id.'_'.$tel.'.png';[m
[31m-            //è‹¥æœªç”Ÿæˆè¿‡[m
[31m-            if(!is_file($imgurl)){[m
[31m-                Vendor('phpqrcode.phpqrcode');[m
[31m-                $QRcode=new \QRcode();[m
[31m-                //ç”ŸæˆäºŒç»´ç [m
[31m-                $QRcode->png($url, 'autoimg/qrcode'.$tel.'.png','H',8,5);[m
[31m-                $qrurl=ROOT_PATH.'public/autoimg/qrcode'.$tel.'.png';[m
[31m-                $logourl=ROOT_PATH.'public/static/images/logo.png';[m
[31m-                // äºŒç»´ç åŠ å…¥logo[m
[31m-                 $QR = imagecreatefromstring(file_get_contents($qrurl)); [m
[31m-                 $logo = imagecreatefromstring(file_get_contents($logourl)); [m
[31m-                 $logo_width = imagesx($logo);[m
[31m-                 $logo_height = imagesy($logo);[m
[31m-                 #åŠ¨æ€è®¡ç®—å–ä¸­å¿ƒç‚¹ è®©ä½ ä¸«ä¸å±…ä¸­[m
[31m-                 $qr_width = imagesx($QR);[m
[31m-                 $scale=0.18;[m
[31m-                 $logo_line=$scale*$qr_width;[m
[31m-                 $xy=$qr_width*0.5-$logo_line*0.5;[m
[31m-                 imagecopyresampled( $QR,$logo, $xy, $xy, 0, 0, $logo_line, $logo_line, $logo_width, $logo_height); [m
[31m-                imagepng($QR, 'autoimg/qrcode'.$tel.'.png'); [m
[31m-                // èƒŒæ™¯[m
[31m-                $bg_url=Exclusive::get($exclusive_id);[m
[31m-                $bg_url=$bg_url->exclusive_thumb;[m
[31m-                $bg_url=preg_replace('/\\\\/', '/', $bg_url);[m
[31m-                $bg_url=ROOT_PATH.'public'.$bg_url;[m
[31m-                // $bg=ROOT_PATH.'public\static\images\exclusice_code_bg.png';[m
[31m-                //åˆæˆä¸“å±äºŒç»´ç [m
[31m-                 $bg = imagecreatefromstring(file_get_contents($bg_url)); [m
[31m-                 $QR_width = imagesx($QR);//äºŒç»´ç å›¾ç‰‡å®½åº¦ [m
[31m-                 $QR_height = imagesy($QR);//äºŒç»´ç å›¾ç‰‡é«˜åº¦ [m
[31m-                 imagecopyresampled( $bg,$QR, 240, 710, 0, 0, 280, 280, $QR_width, $QR_height); [m
[31m-                imagejpeg($bg, $imgurl,65); [m
[31m-            }[m
[31m-            if(!$img){[m
[31m-                db('qrcode')->insert(['qrcode_member_id'=>$this->param['uid'],'qrcode_exclusive_id'=>$exclusive_id,'qrcode_url'=>$imgurl]);[m
[31m-            }else{[m
[31m-                db('qrcode')->where(['qrcode_member_id'=>$this->param['uid'],'qrcode_exclusive_id'=>$exclusive_id])->update(['qrcode_url'=>$imgurl]);[m
[31m-            }[m
[31m-        }else{[m
[31m-            $imgurl=$img['qrcode_url'];[m
[31m-        }[m
[31m-        //è¿”å›å›¾ç‰‡åœ°å€[m
[31m-        $url='http://'.$_SERVER['HTTP_HOST'].'/'.$imgurl;[m
[31m-        $this->assign('url',$url);[m
[31m-        return view("Userurl/exclusive_code_detail");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [ç”¨æˆ·è¿˜æ¬¾è®¡åˆ’][m
[31m-     * @return   [type][m
[31m-     */[m
[32m+[m	[32m    return view("Userurl/calllback_success");[m
[32m+[m	[32m}[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:01:55+0800[m
[32m+[m	[32m * @version  [ä¸“å±äºŒç»´ç ][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m	[32mpublic function exclusive_code_detail(){[m
[32m+[m		[32m$this->checkToken();[m
[32m+[m		[32m//è·å–å½“å‰æ‰‹æœºå·[m
[32m+[m		[32m$tel=Members::get($this->param['uid']);[m
[32m+[m		[32m$tel=$tel->member_mobile;[m
[32m+[m		[32m//æ¨å¹¿è¿æ¥[m
[32m+[m		[32m$url='http://'.$_SERVER['HTTP_HOST'].'/api/userurl/register/recomment/'.$tel;[m
[32m+[m		[32m//èƒŒæ™¯å›¾ç‰‡ID[m
[32m+[m		[32m$exclusive_id=$this->param['exclusive_id'];[m
[32m+[m		[32m//è°ƒå–æ•°æ®åº“url[m
[32m+[m		[32m$img=db('qrcode')->where(['qrcode_member_id'=>$this->param['uid'],'qrcode_exclusive_id'=>$exclusive_id])->find();[m
[32m+[m			[32m// dump($img);die;[m
[32m+[m		[32mif(!$img || !$img['qrcode_url']){[m
[32m+[m			[32m$imgurl='autoimg/qrcode_'.$exclusive_id.'_'.$tel.'.png';[m
[32m+[m			[32m//è‹¥æœªç”Ÿæˆè¿‡[m
[32m+[m			[32mif(!is_file($imgurl)){[m
[32m+[m				[32mVendor('phpqrcode.phpqrcode');[m
[32m+[m				[32m$QRcode=new \QRcode();[m
[32m+[m				[32m//ç”ŸæˆäºŒç»´ç [m
[32m+[m				[32m$QRcode->png($url, 'autoimg/qrcode'.$tel.'.png','H',8,5);[m
[32m+[m				[32m$qrurl=ROOT_PATH.'public/autoimg/qrcode'.$tel.'.png';[m
[32m+[m				[32m$logourl=ROOT_PATH.'public/static/images/logo.png';[m
[32m+[m				[32m// äºŒç»´ç åŠ å…¥logo[m
[32m+[m				[32m $QR = imagecreatefromstring(file_get_contents($qrurl));[m[41m [m
[32m+[m				[32m $logo = imagecreatefromstring(file_get_contents($logourl));[m[41m [m
[32m+[m				[32m $logo_width = imagesx($logo);[m
[32m+[m				[32m $logo_height = imagesy($logo);[m
[32m+[m				[32m #åŠ¨æ€è®¡ç®—å–ä¸­å¿ƒç‚¹ è®©ä½ ä¸«ä¸å±…ä¸­[m
[32m+[m				[32m $qr_width = imagesx($QR);[m
[32m+[m				[32m $scale=0.18;[m
[32m+[m				[32m $logo_line=$scale*$qr_width;[m
[32m+[m				[32m $xy=$qr_width*0.5-$logo_line*0.5;[m
[32m+[m				[32m imagecopyresampled( $QR,$logo, $xy, $xy, 0, 0, $logo_line, $logo_line, $logo_width, $logo_height);[m[41m [m
[32m+[m				[32mimagepng($QR, 'autoimg/qrcode'.$tel.'.png');[m[41m [m
[32m+[m				[32m// èƒŒæ™¯[m
[32m+[m				[32m$bg_url=Exclusive::get($exclusive_id);[m
[32m+[m				[32m$bg_url=$bg_url->exclusive_thumb;[m
[32m+[m				[32m$bg_url=preg_replace('/\\\\/', '/', $bg_url);[m
[32m+[m				[32m$bg_url=ROOT_PATH.'public'.$bg_url;[m
[32m+[m				[32m// $bg=ROOT_PATH.'public\static\images\exclusice_code_bg.png';[m
[32m+[m				[32m//åˆæˆä¸“å±äºŒç»´ç [m
[32m+[m				[32m $bg = imagecreatefromstring(file_get_contents($bg_url));[m[41m [m
[32m+[m				[32m $QR_width = imagesx($QR);//äºŒç»´ç å›¾ç‰‡å®½åº¦[m[41m [m
[32m+[m				[32m $QR_height = imagesy($QR);//äºŒç»´ç å›¾ç‰‡é«˜åº¦[m[41m [m
[32m+[m				[32m imagecopyresampled( $bg,$QR, 240, 710, 0, 0, 280, 280, $QR_width, $QR_height);[m[41m [m
[32m+[m				[32mimagejpeg($bg, $imgurl,65);[m[41m [m
[32m+[m			[32m}[m
[32m+[m			[32mif(!$img){[m
[32m+[m				[32mdb('qrcode')->insert(['qrcode_member_id'=>$this->param['uid'],'qrcode_exclusive_id'=>$exclusive_id,'qrcode_url'=>$imgurl]);[m
[32m+[m			[32m}else{[m
[32m+[m				[32mdb('qrcode')->where(['qrcode_member_id'=>$this->param['uid'],'qrcode_exclusive_id'=>$exclusive_id])->update(['qrcode_url'=>$imgurl]);[m
[32m+[m			[32m}[m
[32m+[m		[32m}else{[m
[32m+[m			[32m$imgurl=$img['qrcode_url'];[m
[32m+[m		[32m}[m
[32m+[m		[32m//è¿”å›å›¾ç‰‡åœ°å€[m
[32m+[m		[32m$url='http://'.$_SERVER['HTTP_HOST'].'/'.$imgurl;[m
[32m+[m		[32m$this->assign('url',$url);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/exclusive_code_detail");[m
[32m+[m	[32m}[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [ç”¨æˆ·è¿˜æ¬¾è®¡åˆ’][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
 [m
[31m-    public function repayment_plan_list(){[m
[31m-        $this->checkToken();[m
[31m-        #å…¨éƒ¨[m
[31m-        $order=GenerationOrder::where(['order_member'=>$this->param['uid']])->select();[m
[32m+[m	[32mpublic function repayment_plan_list(){[m
[32m+[m		[32m$this->checkToken();[m
[32m+[m		[32m#å…¨éƒ¨[m
[32m+[m		[32m$order=GenerationOrder::where(['order_member'=>$this->param['uid']])->select();[m
 [m
[31m-        #å·²æ‰§è¡Œ[m
[31m-        $order2=GenerationOrder::where(['order_member'=>$this->param['uid'],'order_status'=>2])->select();[m
[32m+[m		[32m#å·²æ‰§è¡Œ[m
[32m+[m		[32m$order2=GenerationOrder::where(['order_member'=>$this->param['uid'],'order_status'=>2])->select();[m
 [m
[31m-        #æœªæ‰§è¡Œ[m
[31m-        $order1=GenerationOrder::where(['order_member'=>$this->param['uid'],'order_status'=>1])->select();[m
[31m-        [m
[31m-        $this->assign('order',$order);[m
[31m-        $this->assign('order2',$order2);[m
[31m-        $this->assign('order1',$order1);[m
[31m-        return view("Userurl/repayment_plan_list");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [è¿˜æ¬¾è®¡åˆ’å·²å®Œæˆåˆ—è¡¨][m
[31m-     * @return   [type][m
[31m-     */[m
[31m-    public function repayment_history(){[m
[31m-        $this->checkToken();[m
[31m-        #è¿›è¡Œä¸­[m
[31m-        // $this->param['uid']=16;[m
[31m-        $generation=Generation::with('creditcard')->where(['generation_member'=>$this->param['uid'],'generation_state'=>2])->order('generation_add_time','desc')->select();[m
[31m-        foreach ($generation as $key => $value) {[m
[31m-            //åˆ¤æ–­è‡ªåŠ¨æ‰§è¡Œè¡¨ æ˜¯å¦å…¨éƒ¨å®Œæˆæ‰§è¡Œ å–æœªæ‰§è¡Œçš„è®¡åˆ’[m
[31m-            $haventDone=GenerationOrder::where(['order_no'=>$value['generation_id'],'order_status'=>1])->find();[m
[31m-            if(!$haventDone){[m
[31m-                //è‹¥å…¨éƒ¨å®Œæˆæ‰§è¡Œ æ›´æ”¹ä¸»è¡¨è®¡åˆ’æ‰§è¡ŒçŠ¶æ€[m
[31m-                Generation::where(['generation_member'=>$this->param['uid'],'generation_id'=>$value['generation_id']])->update(['generation_state'=>3]);[m
[31m-                unset($generation['$key']);[m
[31m-                continue;[m
[31m-            }else{[m
[31m-                $generation[$key]['generation_card']=substr($value['generation_card'], -4);[m
[31m-                $generation[$key]['count']=GenerationOrder::where(['order_no'=>$value['generation_id']])->count();[m
[31m-            }[m
[31m-        }[m
[32m+[m		[32m#æœªæ‰§è¡Œ[m
[32m+[m		[32m$order1=GenerationOrder::where(['order_member'=>$this->param['uid'],'order_status'=>1])->select();[m
[32m+[m[41m		[m
[32m+[m		[32m$this->assign('order',$order);[m
[32m+[m		[32m$this->assign('order2',$order2);[m
[32m+[m		[32m$this->assign('order1',$order1);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/repayment_plan_list");[m
[32m+[m	[32m}[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [è¿˜æ¬¾è®¡åˆ’å·²å®Œæˆåˆ—è¡¨][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m	[32mpublic function repayment_history(){[m
[32m+[m		[32m$this->checkToken();[m
[32m+[m		[32m#è¿›è¡Œä¸­[m
[32m+[m		[32m// $this->param['uid']=16;[m
[32m+[m		[32m$generation=Generation::with('creditcard')->where(['generation_member'=>$this->param['uid'],'generation_state'=>2])->order('generation_add_time','desc')->select();[m
[32m+[m		[32mforeach ($generation as $key => $value) {[m
[32m+[m			[32m//åˆ¤æ–­è‡ªåŠ¨æ‰§è¡Œè¡¨ æ˜¯å¦å…¨éƒ¨å®Œæˆæ‰§è¡Œ å–æœªæ‰§è¡Œçš„è®¡åˆ’[m
[32m+[m			[32m$haventDone=GenerationOrder::where(['order_no'=>$value['generation_id'],'order_status'=>1])->find();[m
[32m+[m			[32mif(!$haventDone){[m
[32m+[m				[32m//è‹¥å…¨éƒ¨å®Œæˆæ‰§è¡Œ æ›´æ”¹ä¸»è¡¨è®¡åˆ’æ‰§è¡ŒçŠ¶æ€[m
[32m+[m				[32mGeneration::where(['generation_member'=>$this->param['uid'],'generation_id'=>$value['generation_id']])->update(['generation_state'=>3]);[m
[32m+[m				[32munset($generation['$key']);[m
[32m+[m				[32mcontinue;[m
[32m+[m			[32m}else{[m
[32m+[m				[32m$generation[$key]['generation_card']=substr($value['generation_card'], -4);[m
[32m+[m				[32m$generation[$key]['count']=GenerationOrder::where(['order_no'=>$value['generation_id']])->count();[m
[32m+[m			[32m}[m
[32m+[m		[32m}[m
 [m
[31m-        #å¾…ç¡®è®¤ ä¸éœ€è¦äº†[m
[31m-        // $generation1=Generation::with('creditcard')->where(['generation_member'=>$this->param['uid'],'generation_state'=>1])->select();[m
[31m-        // foreach ($generation1 as $key => $value) {[m
[31m-        //      $generation1[$key]['generation_card']=substr($value['generation_card'], -4);[m
[31m-        //      $generation1[$key]['count']=GenerationOrder::where(['order_no'=>$value['generation_id']])->count();[m
[31m-        // }[m
[32m+[m		[32m#å¾…ç¡®è®¤ ä¸éœ€è¦äº†[m
[32m+[m		[32m// $generation1=Generation::with('creditcard')->where(['generation_member'=>$this->param['uid'],'generation_state'=>1])->select();[m
[32m+[m		[32m// foreach ($generation1 as $key => $value) {[m
[32m+[m		[32m// 		$generation1[$key]['generation_card']=substr($value['generation_card'], -4);[m
[32m+[m		[32m// 		$generation1[$key]['count']=GenerationOrder::where(['order_no'=>$value['generation_id']])->count();[m
[32m+[m		[32m// }[m
 [m
[31m-        #å®Œæˆ[m
[31m-        $generation3=Generation::with('creditcard')->where(['generation_member'=>$this->param['uid'],'generation_state'=>['in','3,4']])->order('generation_add_time','desc')->select();[m
[31m-        foreach ($generation3 as $key => $value) {[m
[31m-                $generation3[$key]['generation_card']=substr($value['generation_card'], -4);[m
[31m-                $generation3[$key]['count']=GenerationOrder::where(['order_no'=>$value['generation_id']])->count();[m
[31m-        }[m
[31m-        // var_dump($generation);die;[m
[31m-        $this->assign('generation',$generation);[m
[31m-        $this->assign('generation3',$generation3);[m
[31m-        return view("Userurl/repayment_history");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [è¿˜æ¬¾è®¡åˆ’åˆ›å»º #1][m
[31m-     * @version  [è¿˜æ¬¾è®¡åˆ’åˆ›å»ºä¸‹ä¸€æ­¥åæ˜¾ç¤ºçš„è¯¦æƒ…é¡µ][m
[31m-     * @return   [type][m
[31m-     */[m
[31m-    public function repayment_plan_create_detail(){[m
[31m-        // $this->checkToken();[m
[31m-        // $order_no=$this->param['order_no'];[m
[31m-        $order_no=input('order_no');[m
[31m-        $data=explode('_', $order_no);[m
[31m-        // print_r($data);die;[m
[31m-        $this->param['uid']=$param['uid']=$data[0];[m
[32m+[m		[32m#å®Œæˆ[m
[32m+[m		[32m$generation3=Generation::with('creditcard')->where(['generation_member'=>$this->param['uid'],'generation_state'=>['in','3,4']])->order('generation_add_time','desc')->select();[m
[32m+[m		[32mforeach ($generation3 as $key => $value) {[m
[32m+[m				[32m$generation3[$key]['generation_card']=substr($value['generation_card'], -4);[m
[32m+[m				[32m$generation3[$key]['count']=GenerationOrder::where(['order_no'=>$value['generation_id']])->count();[m
[32m+[m		[32m}[m
[32m+[m		[32m// var_dump($generation);die;[m
[32m+[m
[32m+[m		[32m$this->assign('generation',$generation);[m
[32m+[m		[32m$this->assign('generation3',$generation3);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/repayment_history");[m
[32m+[m	[32m}[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [è¿˜æ¬¾è®¡åˆ’åˆ›å»º #1][m
[32m+[m	[32m * @version  [è¿˜æ¬¾è®¡åˆ’åˆ›å»ºä¸‹ä¸€æ­¥åæ˜¾ç¤ºçš„è¯¦æƒ…é¡µ][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m
[32m+[m	[32mpublic function repayment_plan_create_detail(){[m
[32m+[m[32m    // order_no=42_63_300_1_2018-02-28-15:00:00_2018-02-29-15:00:00_21[m
[32m+[m		[32m// $this->checkToken();[m
[32m+[m		[32m// $order_no=$this->param['order_no'];[m
[32m+[m		[32m$order_no=input('order_no');[m
[32m+[m		[32m$data=explode('_', $order_no);[m
[32m+[m		[32m// print_r($data);die;[m
[32m+[m		[32m$this->param['uid']=$param['uid']=$data[0];[m
         $this->param['cardId']=$param['cardId']=$data[1];[m
         $this->param['billMoney']=$param['billMoney']=$data[2];[m
         $this->param['payCount']=$param['payCount']=$data[3];[m
         $this->param['startDate']=$param['startDate']=$data[4];[m
         $this->param['endDate']=$param['endDate']=$data[5];[m
         $this->param['passageway']=$param['passageway']=$data[6];[m
[31m-        #1åˆ¤æ–­å½“å‰é€šé“å½“å‰å¡ç”¨æˆ·æœ‰æ²¡æœ‰å…¥ç½‘å’Œç­¾çº¦[m
[32m+[m		[32m   #1åˆ¤æ–­å½“å‰é€šé“å½“å‰å¡ç”¨æˆ·æœ‰æ²¡æœ‰å…¥ç½‘å’Œç­¾çº¦[m
         // è·å–é€šé“ä¿¡æ¯[m
        $passageway=Passageway::get($param['passageway']);[m
        $members=Members::haswhere('memberLogin','')->where(['member_id'=>$param['uid']])->find();[m
        if(!$passageway || !$members){[m
[31m-            $this->assign('data','è·å–æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');[m
[31m-            return view("Userurl/show_error");[m
[32m+[m[41m       [m		[32m$this->assign('data','è·å–æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');[m
[32m+[m[41m       [m		[32mreturn view("Userurl/show_error");[m
        }[m
[31m-       $passageway_rate=$passageway->passageway_rate;[m
[31m-       $passageway_income=$passageway->passageway_income;[m
[31m-       // var_dump($passageway->toArray());die;[m
[31m-       //åˆ¤æ–­æ˜¯å¦ç­¾çº¦[m
        $MemberCreditcard=MemberCreditcard::where(['card_id'=>$param['cardId']])->find();[m
        //åˆ¤æ–­å“ªä¸ªé€šé“[m
        if($passageway['passageway_method']=='income'){  //æš‚æ—¶è¿™ä¹ˆåˆ¤æ–­æ˜¯æ±‡è”é‡‘åˆ›è¿˜æ˜¯ç±³åˆ·[m
[31m-            if(!$MemberCreditcard['huilian_income']){[m
[32m+[m
[32m+[m[32m            $member_net=MemberNet::where(['net_member_id'=>$param['uid']])->find();[m
[32m+[m[32m            if(!$member_net[$passageway->passageway_no]){ //æ²¡æœ‰å…¥ç½‘[m
[32m+[m[32m               // é‡å®šå‘åˆ°ç­¾çº¦é¡µé¢[m
                 $huilian=new Huilianjinchuang();[m
                 $res=$huilian->income($this->param['passageway'],$this->param['cardId']);[m
[31m-                // var_dump($res);die;[m
[31m-                if($res['code']=="10000" && $res['respCode']==10000){[m
[31m-                    $merId=$res['merId'];[m
[31m-                    $update=MemberCreditcard::where(['card_id'=>$param['cardId']])->update(['huilian_income'=>$merId]);[m
[31m-                    if(!$update){[m
[31m-                        $this->assign('data',"å•†æˆ·å…¥ç½‘å¤±è´¥ï¼Œ{$res['respMessage']}è¯·é‡è¯•ã€‚");[m
[31m-                        return view("Userurl/show_error");[m
[31m-                    }[m
[31m-                }else{[m
[31m-                      $this->assign('data',"å•†æˆ·å…¥ç½‘å¤±è´¥ï¼Œ{$res['respMessage']}è¯·é‡è¯•ã€‚");[m
[31m-                      return view("Userurl/show_error");[m
[32m+[m[32m                if(!$res){[m
[32m+[m[32m                    $this->assign('data','å•†æˆ·å…¥ç½‘å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');[m
[32m+[m[32m                    return view("Userurl/show_error");die;[m
                 }[m
             }[m
[32m+[m[32m            if(!$MemberCreditcard['huilian_income']){[m
[32m+[m[32m                return redirect('Userurl/signed_huilian', ['passageway_id' =>$param['passageway'],'cardId'=>$param['cardId'],'order_no'=>$order_no]);[m
[32m+[m[32m            }[m
        }else{[m
            // åˆ¤æ–­æ˜¯å¦å…¥ç½‘[m
            $member_net=MemberNet::where(['net_member_id'=>$param['uid']])->find();[m
[36m@@ -310,7 +307,7 @@[m [mclass Userurl extends Controller[m
           $card_info=MemberCreditcard::where('card_id='.$this->param['cardId'])->find();[m
           if(!$card_info){[m
               $this->assign('data','è·å–æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');[m
[31m-              return view("Userurl/show_error");[m
[32m+[m[41m       [m		[32m  return view("Userurl/show_error");[m
           }[m
           #è·å–åå°è´¹ç‡[m
           $member_group_id=Members::where(['member_id'=>$this->param['uid']])->value('member_group_id');[m
[36m@@ -319,14 +316,11 @@[m [mclass Userurl extends Controller[m
            $also=($rate->item_also)/100;[m
            #å®šä¹‰ä»£æ‰£è´¹[m
            $daikou=($rate->item_charges)/100;[m
[31m-           #è·å–ä»£ä»˜è´¹ç‡[m
[31m-           $item_qfalso=($rate->item_qfalso)/100;[m
[31m-           #è·å–ä»£ä»˜å®šé¢[m
[31m-           $item_qffix=($rate->item_qffix)/100;[m
           //å¦‚æœè¿˜æ¬¾æ¬¡æ•°å°äºå¤©æ•°[m
           $days=days_between_dates($this->param['startDate'],$this->param['endDate'])+1;[m
           $date=prDates($this->param['startDate'],$this->param['endDate']);[m
           if($this->param['payCount']<$days){[m
[32m+[m[32m               shuffle($date);[m
                 #æ¶ˆè´¹å‡ æ¬¡å°±å–å‡ ä¸ªéšæœºæ—¥æœŸ[m
                $date=array_slice($date,0,$this->param['payCount']);[m
                $days=$this->param['payCount'];[m
[36m@@ -348,7 +342,7 @@[m [mclass Userurl extends Controller[m
           if($Generation_result->save()==false){[m
               Db::rollback();[m
                 $this->assign('data','ç”Ÿæˆè®¡åˆ’å¤±è´¥ï¼Œè¯·é‡è¯•');[m
[31m-                return view("Userurl/show_error");[m
[32m+[m[41m       [m			[32mreturn view("Userurl/show_error");[m
           }[m
           //å†™å…¥è¿˜æ¬¾å¡è¡¨[m
            $reimbur_result=new Reimbur([[m
[36m@@ -358,12 +352,11 @@[m [mclass Userurl extends Controller[m
            if(!$reimbur_result->save()){[m
                 Db::rollback();[m
                 $this->assign('data','ç”Ÿæˆè®¡åˆ’å¤±è´¥ï¼Œè¯·é‡è¯•');[m
[31m-                return view("Userurl/show_error");[m
[32m+[m[41m       [m			[32mreturn view("Userurl/show_error");[m
            }[m
           ####################################[m
[31m-          #3ç¡®å®šæ¯å¤©å®é™…è¿˜æ¬¾é‡‘é¢[m
[31m-          $day_pay_real_money=$this->get_random_money($days,$this->param['billMoney'],$is_int=1);[m
[31m-          // print_r($day_pay_real_money);[m
[32m+[m[32m          #3ç¡®å®šæ¯å¤©è¿˜æ¬¾é‡‘é¢[m
[32m+[m[32m          $day_pay_money=$this->get_random_money($days,$this->param['billMoney'],$is_int=1);[m
           #4ç¡®å®šæ¯å¤©è¿˜æ¬¾æ¬¡æ•°[m
           $day_pay_count=$this->get_day_count($this->param['payCount'],$days);[m
           #5è®¡ç®—å‡ºæ¯å¤©å®é™…åˆ·å¡é‡‘é¢ï¼Œå’Œå®é™…åˆ°è´¦é‡‘é¢[m
[36m@@ -373,9 +366,6 @@[m [mclass Userurl extends Controller[m
               $day_real_get_money=0;[m
               //åˆ·å¡ä¿¡æ¯[m
               #è®¡ç®—æ¯æ¬¡éœ€è¦åˆ·å¡çš„ç†è®ºé‡‘é¢[m
[31m-              #è¿˜æ¬¾ä¹Ÿæœ‰æ‰‹ç»­è´¹ï¼Œè®¡ç®—å‡ºæ¯æ¬¡éœ€è¦è¿˜æ¬¾é‡‘é¢,$passageway->passageway_qf_rate,$passageway->passageway_qf_rate[m
[31m-              $day_pay_money[$i]=$this->get_need_pay($item_qfalso,$item_qffix,$day_pay_real_money[$i]);[m
[31m-              // print_r($day_pay_money[$i]);die;[m
               $each_pay_money=$this->get_random_money($day_pay_count[$i],$day_pay_money[$i],$is_int=1);[m
               #è®¡ç®—æ¯æ¬¡åˆ·å¡çš„æ—¶é—´[m
               $each_pay_time=$this->get_random_time($date[$i],$day_pay_count[$i]);[m
[36m@@ -384,7 +374,7 @@[m [mclass Userurl extends Controller[m
                   //è·å–æ¯æ¬¡å®é™…éœ€è¦æ”¯ä»˜é‡‘é¢[m
                   $real_each_pay_money=$this->get_need_pay($also,$daikou,$each_money);[m
                   //è·å–æ¯æ¬¡å®é™…åˆ°è´¦é‡‘é¢[m
[31m-                  $real_each_get=$this->get_real_money($also,$daikou,$real_each_pay_money,$passageway_rate,$passageway_income);[m
[32m+[m[32m                  $real_each_get=$this->get_real_money($also,$daikou,$real_each_pay_money);[m
 [m
                   $plan[$i]['pay'][$k]=$Generation_order_insert[]=array([m
                       'order_no'       =>$Generation_result->generation_id,[m
[36m@@ -393,13 +383,7 @@[m [mclass Userurl extends Controller[m
                       'order_card'     =>$card_info->card_bankno,[m
                       'order_money'    =>$real_each_pay_money,[m
                       'order_pound'    =>$real_each_get['fee'],[m
[31m-                      'order_real_get' =>$real_each_get['money'],[m
[31m-                      'order_platform_fee'=>$real_each_get['plantform_fee'],[m
[31m-                      'order_passageway_fee'=>$real_each_get['passageway_fee'],[m
[31m-                      'passageway_rate'=>$passageway_rate,[m
[31m-                      'passageway_fix'=>$passageway_income,[m
[31m-                      'user_fix'=>$daikou,[m
[31m-                      'user_rate'=>$also*100,[m
[32m+[m[32m                      // 'real_each_get'  =>$real_each_get['money'],[m
                       'order_desc'     =>'è‡ªåŠ¨ä»£è¿˜æ¶ˆè´¹~',[m
                       'order_time'     =>$each_pay_time[$k],[m
                       'order_passageway'=>$this->param['passageway'],[m
[36m@@ -410,9 +394,6 @@[m [mclass Userurl extends Controller[m
                   $generation_pound += $real_each_get['fee'];[m
                 $day_real_get_money+=$real_each_get['money'];[m
               }[m
[31m-              //è·å–ä»£è¿˜æ¯æ¬¡å®é™…åˆ°è´¦é‡‘é¢[m
[31m-              $real_qf_get=$this->get_real_money($item_qfalso,$item_qffix,$day_real_get_money,$passageway->passageway_qf_rate,$passageway->passageway_qf_fix);[m
[31m-              // print_r($real_qf_get);die;[m
               //æç°ä¿¡æ¯[m
               $plan[$i]['cash']=$Generation_order_insert[]=array([m
                   'order_no'         =>$Generation_result->generation_id,[m
[36m@@ -420,15 +401,7 @@[m [mclass Userurl extends Controller[m
                   'order_type'       =>2,[m
                   'order_card'       =>$card_info->card_bankno,[m
                   'order_money'      =>$day_real_get_money,//æ¯å¤©å®é™…æ‰“å›çš„é‡‘é¢[m
[31m-                  'order_pound'      =>$real_qf_get['fee'],[m
[31m-[m
[31m-                  'order_real_get' =>$real_qf_get['money'],[m
[31m-                  'order_platform_fee'=>$real_qf_get['plantform_fee'],[m
[31m-                  'order_passageway_fee'=>$real_qf_get['passageway_fee'],[m
[31m-                  'passageway_rate'=>$passageway->passageway_qf_rate,[m
[31m-                  'passageway_fix'=> $passageway->passageway_qf_fix,[m
[31m-                  'user_fix'=>$item_qffix,[m
[31m-                  'user_rate'=>$item_qfalso*100,[m
[32m+[m[32m                  'order_pound'      =>0,[m
                   'order_desc'       =>'è‡ªåŠ¨ä»£è¿˜è¿˜æ¬¾~',[m
                   'order_time'       =>$date[$i]." ".get_hours(15,16).":".get_minites(0,59),[m
                   'order_passageway'=>$this->param['passageway'],[m
[36m@@ -452,146 +425,146 @@[m [mclass Userurl extends Controller[m
          }else{[m
                Db::rollback();[m
                $this->assign('data','ç”Ÿæˆè®¡åˆ’å¤±è´¥ï¼Œè¯·é‡è¯•');[m
[31m-               return view("Userurl/show_error");[m
[32m+[m[41m       [m		[32m   return view("Userurl/show_error");[m
          }[m
         $order_no=$Generation_result->generation_id;[m
         // *************************************å±•ç¤ºè®¡åˆ’****************************************************[m
[31m-        $order=array();[m
[31m-        //ä¸»è®¡åˆ’[m
[31m-        $generation=Generation::with('creditcard')->where(['generation_id'=>$order_no])->find();[m
[31m-        //æ‰§è¡Œè®¡åˆ’è¡¨[m
[31m-        $order=GenerationOrder::where(['order_no'=>$order_no])->order('order_time','asc')->select();[m
[31m-        foreach ($order as $key => $value) {[m
[31m-            $value=$value->toArray();[m
[31m-            // print_r($value);die;[m
[31m-            $list[$key]=$value;[m
[31m-            $list[$key]['day_time']=date("mæœˆdæ—¥",strtotime($value['order_time']));[m
[31m-            $list[$key]['current_time']=date("H:i",strtotime($value['order_time']));[m
[31m-        }[m
[31m-        $data=[];[m
[31m-        //ä»¥æ—¥æœŸä¸ºé”®[m
[31m-        foreach ($list as $key => $value) {[m
[31m-            $data[$value['day_time']][]=$value;[m
[31m-        }[m
[31m-        //æ‰‹ç»­è´¹[m
[31m-        $order_pound=0;[m
[31m-        // print_r($data);die;[m
[31m-        //å¤„ç†æ¯æ—¥ç´¯è®¡é‡‘é¢[m
[32m+[m		[32m$order=array();[m
[32m+[m		[32m//ä¸»è®¡åˆ’[m
[32m+[m		[32m$generation=Generation::with('creditcard')->where(['generation_id'=>$order_no])->find();[m
[32m+[m		[32m//æ‰§è¡Œè®¡åˆ’è¡¨[m
[32m+[m		[32m$order=GenerationOrder::where(['order_no'=>$order_no])->order('order_time','asc')->select();[m
[32m+[m		[32mforeach ($order as $key => $value) {[m
[32m+[m			[32m$value=$value->toArray();[m
[32m+[m			[32m// print_r($value);die;[m
[32m+[m			[32m$list[$key]=$value;[m
[32m+[m			[32m$list[$key]['day_time']=date("mæœˆdæ—¥",strtotime($value['order_time']));[m
[32m+[m			[32m$list[$key]['current_time']=date("H:i",strtotime($value['order_time']));[m
[32m+[m		[32m}[m
[32m+[m		[32m$data=[];[m
[32m+[m		[32m//ä»¥æ—¥æœŸä¸ºé”®[m
[32m+[m		[32mforeach ($list as $key => $value) {[m
[32m+[m			[32m$data[$value['day_time']][]=$value;[m
[32m+[m		[32m}[m
[32m+[m		[32m//æ‰‹ç»­è´¹[m
[32m+[m		[32m$order_pound=0;[m
[32m+[m		[32m// print_r($data);die;[m
[32m+[m		[32m//å¤„ç†æ¯æ—¥ç´¯è®¡é‡‘é¢[m
         foreach($data as $k=>$v){[m
[31m-                $data[$k]['pay']=0;[m
[31m-                $data[$k]['get']=0;[m
[31m-            foreach ($v as $key => $vv) {[m
[31m-                if($vv['order_type']==1){[m
[31m-                  $data[$k]['pay']+=$vv['order_money'];[m
[31m-                }else if($vv['order_type']==2){[m
[31m-                  $data[$k]['get']+=$vv['order_real_get'];[m
[31m-                }[m
[31m-                $order_pound+=$vv['order_pound'];[m
[31m-            }[m
[32m+[m[41m        [m		[32m$data[$k]['pay']=0;[m
[32m+[m[41m        [m		[32m$data[$k]['get']=0;[m
[32m+[m[41m        [m	[32mforeach ($v as $key => $vv) {[m
[32m+[m[41m        [m		[32mif($vv['order_type']==1){[m
[32m+[m[41m        [m		[32m  $data[$k]['pay']+=$vv['order_money'];[m
[32m+[m[41m        [m		[32m}else if($vv['order_type']==2){[m
[32m+[m[41m        [m		[32m  $data[$k]['get']+=$vv['order_money'];[m
[32m+[m[41m        [m		[32m}[m
[32m+[m[41m        [m		[32m$order_pound+=$vv['order_pound'];[m
[32m+[m[41m        [m	[32m}[m
         }[m
         $this->assign('uid',$param['uid']);[m
         $this->assign('token',$members['memberLogin']['login_token']);[m
[31m-        $this->assign('order_pound',$order_pound);[m
[31m-        $this->assign('generation',$generation);[m
[31m-        $this->assign('order',$data);[m
[31m-        return view("Userurl/repayment_plan_create_detail");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [è¿˜æ¬¾è®¡åˆ’åˆ›å»º #2][m
[31m-     * @version  [ç”¨æˆ·è¿˜æ¬¾è®¡åˆ’ç¡®è®¤æäº¤é¡µ][m
[31m-     * param   $id  ä¸ºgenerationè¡¨ä¸»é”® generation_id[m
[31m-     * @return   [type][m
[31m-     */[m
[31m-    public function repayment_plan_confirm($id){[m
[31m-        $this->checkToken();[m
[31m-        $GenerationOrder=GenerationOrder::order('order_money desc')->where('order_no',$id)->find();[m
[31m-        $creaditcard=MemberCreditcard::where('card_bankno',$GenerationOrder->order_card)->find();[m
[31m-        $this->assign('generationorder',$GenerationOrder);[m
[31m-        $this->assign('creaditcard',$creaditcard);[m
[31m-        return view("Userurl/repayment_plan_confirm");[m
[31m-    }[m
[31m-      //ç¡®è®¤æ‰§è¡Œè¿˜æ¬¾è®¡åˆ’[m
[31m-      //$id  ä¸ºgenerationè¡¨ä¸»é”® generation_id[m
[31m-      public function confirmPlan($id){[m
[31m-        $this->checkToken();[m
[31m-        $res=Generation::update(['generation_id'=>$id,'generation_state'=>2]);[m
[31m-        return json_encode($res ? ['code'=>200] : ['code'=>472,'msg'=>get_status_text(472)]);[m
[31m-      }[m
[31m-      #è¿˜æ¬¾è®¡åˆ’æäº¤æˆåŠŸæç¤ºé¡µ[m
[31m-      #@version  [è¿˜æ¬¾è®¡åˆ’åˆ›å»º #3][m
[31m-      #[m
[31m-      public function repayment_plan_success(){[m
[31m-        return view("Userurl/repayment_plan_success");[m
[31m-      }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [è¿˜æ¬¾è®¡åˆ’è¯¦æƒ…][m
[31m-     * @return   [type][m
[31m-     */[m
[32m+[m		[32m$this->assign('order_pound',$order_pound);[m
[32m+[m		[32m$this->assign('generation',$generation);[m
[32m+[m		[32m$this->assign('order',$data);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/repayment_plan_create_detail");[m
[32m+[m	[32m}[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [è¿˜æ¬¾è®¡åˆ’åˆ›å»º #2][m
[32m+[m	[32m * @version  [ç”¨æˆ·è¿˜æ¬¾è®¡åˆ’ç¡®è®¤æäº¤é¡µ][m
[32m+[m	[32m * param   $id  ä¸ºgenerationè¡¨ä¸»é”® generation_id[m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m	[32mpublic function repayment_plan_confirm($id){[m
[32m+[m		[32m$this->checkToken();[m
[32m+[m		[32m$GenerationOrder=GenerationOrder::order('order_money desc')->where('order_no',$id)->find();[m
[32m+[m		[32m$creaditcard=MemberCreditcard::where('card_bankno',$GenerationOrder->order_card)->find();[m
[32m+[m		[32m$this->assign('generationorder',$GenerationOrder);[m
[32m+[m		[32m$this->assign('creaditcard',$creaditcard);[m
[32m+[m		[32mreturn view("Userurl/repayment_plan_confirm");[m
[32m+[m	[32m}[m
[32m+[m	[32m  //ç¡®è®¤æ‰§è¡Œè¿˜æ¬¾è®¡åˆ’[m
[32m+[m	[32m  //$id  ä¸ºgenerationè¡¨ä¸»é”® generation_id[m
[32m+[m	[32m  public function confirmPlan($id){[m
[32m+[m		[32m$this->checkToken();[m
[32m+[m		[32m$res=Generation::update(['generation_id'=>$id,'generation_state'=>2]);[m
[32m+[m		[32mreturn json_encode($res ? ['code'=>200] : ['code'=>472,'msg'=>get_status_text(472)]);[m
[32m+[m	[32m  }[m
[32m+[m	[32m  #è¿˜æ¬¾è®¡åˆ’æäº¤æˆåŠŸæç¤ºé¡µ[m
[32m+[m	[32m  #@version  [è¿˜æ¬¾è®¡åˆ’åˆ›å»º #3][m
[32m+[m	[32m  #[m
[32m+[m	[32m  public function repayment_plan_success(){[m
[32m+[m		[32mreturn view("Userurl/repayment_plan_success");[m
[32m+[m	[32m  }[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [è¿˜æ¬¾è®¡åˆ’è¯¦æƒ…][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
 [m
[31m-    public function repayment_plan_detail(){[m
[31m-        #1è·å–å‚æ•°åˆ¤æ–­éœ€ä¸éœ€è¦å»ç­¾çº¦[m
[31m-        // $this->checkToken();[m
[31m-        $order_no=input('order_no');[m
[32m+[m	[32mpublic function repayment_plan_detail(){[m
[32m+[m		[32m#1è·å–å‚æ•°åˆ¤æ–­éœ€ä¸éœ€è¦å»ç­¾çº¦[m
[32m+[m		[32m// $this->checkToken();[m
[32m+[m		[32m$order_no=input('order_no');[m
        #33å±•ç¤ºè®¡åˆ’é¡µé¢[m
[31m-        $order=array();[m
[31m-        //ä¸»è®¡åˆ’[m
[31m-        $generation=Generation::with('creditcard')->where(['generation_id'=>$order_no])->find();[m
[31m-        //æ‰§è¡Œè®¡åˆ’è¡¨[m
[31m-        $order=GenerationOrder::where(['order_no'=>$order_no])->order('order_time','asc')->select();[m
[31m-        if(!$order){[m
[31m-            echo '<li style="margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;">æš‚æ— è®¡åˆ’è¯¦æƒ…</li>';die;[m
[31m-        }[m
[31m-        $is_first=0;[m
[31m-        foreach ($order as $key => $value) {[m
[31m-            $value=$value->toArray();[m
[31m-            $list[$key]=$value;[m
[31m-            $list[$key]['day_time']=date("mæœˆdæ—¥",strtotime($value['order_time']));[m
[31m-            $list[$key]['current_time']=date("H:i",strtotime($value['order_time']));[m
[31m-            if($value['order_status']=='-1' && $is_first==0 && $generation['generation_state']==2){//å¤±è´¥[m
[31m-                $list[$key]['is_first']=1;[m
[31m-                $is_first=1;[m
[31m-            }[m
[31m-            [m
[31m-        }[m
[31m-        // print_r($list);die;[m
[31m-        $data=[];[m
[31m-        //ä»¥æ—¥æœŸä¸ºé”®[m
[31m-        foreach ($list as $key => $value) {[m
[31m-            $data[$value['day_time']][]=$value;[m
[31m-        }[m
[31m-        //æ‰‹ç»­è´¹[m
[31m-        $order_pound=0;[m
[31m-        // print_r($data);die;[m
[31m-        //å¤„ç†æ¯æ—¥ç´¯è®¡é‡‘é¢[m
[32m+[m		[32m$order=array();[m
[32m+[m		[32m//ä¸»è®¡åˆ’[m
[32m+[m		[32m$generation=Generation::with('creditcard')->where(['generation_id'=>$order_no])->find();[m
[32m+[m		[32m//æ‰§è¡Œè®¡åˆ’è¡¨[m
[32m+[m		[32m$order=GenerationOrder::where(['order_no'=>$order_no])->order('order_time','asc')->select();[m
[32m+[m		[32mif(!$order){[m
[32m+[m			[32mecho '<li style="margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;">æš‚æ— è®¡åˆ’è¯¦æƒ…</li>';die;[m
[32m+[m		[32m}[m
[32m+[m		[32m$is_first=0;[m
[32m+[m		[32mforeach ($order as $key => $value) {[m
[32m+[m			[32m$value=$value->toArray();[m
[32m+[m			[32m$list[$key]=$value;[m
[32m+[m			[32m$list[$key]['day_time']=date("mæœˆdæ—¥",strtotime($value['order_time']));[m
[32m+[m			[32m$list[$key]['current_time']=date("H:i",strtotime($value['order_time']));[m
[32m+[m			[32mif($value['order_status']=='-1' && $is_first==0 && $generation['generation_state']==2){//å¤±è´¥[m
[32m+[m				[32m$list[$key]['is_first']=1;[m
[32m+[m				[32m$is_first=1;[m
[32m+[m			[32m}[m
[32m+[m[41m			[m
[32m+[m		[32m}[m
[32m+[m		[32m// print_r($list);die;[m
[32m+[m		[32m$data=[];[m
[32m+[m		[32m//ä»¥æ—¥æœŸä¸ºé”®[m
[32m+[m		[32mforeach ($list as $key => $value) {[m
[32m+[m			[32m$data[$value['day_time']][]=$value;[m
[32m+[m		[32m}[m
[32m+[m		[32m//æ‰‹ç»­è´¹[m
[32m+[m		[32m$order_pound=0;[m
[32m+[m		[32m// print_r($data);die;[m
[32m+[m		[32m//å¤„ç†æ¯æ—¥ç´¯è®¡é‡‘é¢[m
         foreach($data as $k=>$v){[m
[31m-                $data[$k]['pay']=0;[m
[31m-                $data[$k]['get']=0;[m
[31m-            foreach ($v as $key => $vv) {[m
[31m-                if($vv['order_type']==1){[m
[31m-                  $data[$k]['pay']+=$vv['order_money'];[m
[31m-                }else if($vv['order_type']==2){[m
[31m-                  $data[$k]['get']+=$vv['order_real_get'];[m
[31m-                }[m
[31m-                $order_pound+=$vv['order_pound'];[m
[31m-            }[m
[32m+[m[41m        [m		[32m$data[$k]['pay']=0;[m
[32m+[m[41m        [m		[32m$data[$k]['get']=0;[m
[32m+[m[41m        [m	[32mforeach ($v as $key => $vv) {[m
[32m+[m[41m        [m		[32mif($vv['order_type']==1){[m
[32m+[m[41m        [m		[32m  $data[$k]['pay']+=$vv['order_money'];[m
[32m+[m[41m        [m		[32m}else if($vv['order_type']==2){[m
[32m+[m[41m        [m		[32m  $data[$k]['get']+=$vv['order_money'];[m
[32m+[m[41m        [m		[32m}[m
[32m+[m[41m        [m		[32m$order_pound+=$vv['order_pound'];[m
[32m+[m[41m        [m	[32m}[m
         }[m
         // print_r($data);die;[m
[31m-        $this->assign('order_pound',$order_pound);[m
[31m-        $this->assign('generation',$generation);[m
[31m-        $this->assign('order',$data);[m
[31m-        return view("Userurl/repayment_plan_detail");[m
[31m-    }[m
[31m-    //æ ¹æ®å¼€å§‹æ—¶é—´ç»“æŸæ—¶é—´éšæœºæ¯å¤©åˆ·å¡æ—¶é—´---æœ‰é—®é¢˜[m
[31m-      public function get_random_time($day,$count,$begin=8,$end=12){[m
[32m+[m		[32m$this->assign('order_pound',$order_pound);[m
[32m+[m		[32m$this->assign('generation',$generation);[m
[32m+[m		[32m$this->assign('order',$data);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/repayment_plan_detail");[m
[32m+[m	[32m}[m
[32m+[m	[32m//æ ¹æ®å¼€å§‹æ—¶é—´ç»“æŸæ—¶é—´éšæœºæ¯å¤©åˆ·å¡æ—¶é—´---æœ‰é—®é¢˜[m
[32m+[m[32m      public function get_random_time($day,$count,$begin=5,$end=10){[m
         //å¦‚æœæ—¥æœŸä¸ºä»Šå¤©ï¼Œåˆ·å¡æ—¶é—´å¤§äºå½“å‰å°æ—¶[m
         $now_h=date('Y-m-d',time());[m
         if($day==$now_h){[m
[31m-           if($now_h<8){[m
[31m-               $begin =8;[m
[32m+[m[32m           if($now_h<6){[m
[32m+[m[32m               $begin =6;[m
            }else{[m
                $begin=date('H',time())+1;[m
            }[m
[36m@@ -599,14 +572,12 @@[m [mclass Userurl extends Controller[m
         $last=$begin;[m
          $step=floor(($end-$begin)/$count)-1;[m
          for ($i=0; $i <$count ; $i++) { [m
[31m-            // $time[$i]=$day.' '.get_hours($last,$last+$step).':'.get_minites();[m
[31m-               $time[$i]=$day.' '.get_hours($begin,$end).':'.get_minites();[m
[32m+[m[32m            $time[$i]=$day.' '.get_hours($last,$last+$step).':'.get_minites();[m
             // $time[$i]['time']=$day.' '.get_hours($last,$last+$step).':'.get_minites();[m
             // $time[$i]['begin']=$last;[m
             // $time[$i]['end']=$last+$step;[m
             $last=$last+$step+1;[m
          }[m
[31m-         sort($time);[m
          // print_r($time);die;[m
          return $time;[m
       }[m
[36m@@ -619,11 +590,9 @@[m [mclass Userurl extends Controller[m
       }[m
       //æ ¹æ®æ”¯ä»˜çš„é‡‘é¢è·å–å®é™…åˆ°è´¦é‡‘é¢[m
        //ä¼ å…¥å•ä½å…ƒï¼Œè½¬æˆåˆ†è®¡ç®—ï¼Œå†è¿”å›å•ä½å…ƒ[m
[31m-      public function get_real_money($rate,$fix,$pay,$passageway_rate,$passageway_income){[m
[31m-         //è´¹ç‡å‘ä¸Šå–æ•´  0,1  0 [m
[32m+[m[32m      public function get_real_money($rate,$fix,$pay){[m
[32m+[m[32m         //è´¹ç‡å‘ä¸Šå–æ•´[m
           $return['fee']=ceil($pay*100*$rate+$fix*100)/100;[m
[31m-          $return['passageway_fee']=ceil($pay*100*$passageway_rate/100+$passageway_income*100)/100;[m
[31m-          $return['plantform_fee']=$return['fee']-$return['passageway_fee'];[m
           $return['money']=$pay-$return['fee'];[m
           return $return;[m
       }[m
[36m@@ -694,140 +663,143 @@[m [mclass Userurl extends Controller[m
            }[m
            return $arr;[m
       }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [æ¶ˆæ¯][m
[31m-     * @return   [type][m
[31m-     */[m
[31m-     public function notify(){[m
[31m-         $this->checkToken();[m
[31m-        $count=Notice::where(['notice_recieve'=>$this->param['uid'],'notice_status'=>0])->count();[m
[31m-        $this->assign('count',$count);[m
[31m-        return view("Userurl/notify");[m
[31m-     }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [å¹³å°å…¬å‘Šåˆ—è¡¨][m
[31m-     * @return   [type][m
[31m-     */[m
[31m-    public function notify_list(){[m
[31m-        $this->checkToken();[m
[31m-        $notice=Notice::where(['notice_recieve'=>$this->param['uid']])->order('notice_createtime desc')->select();[m
[31m-        if(!$notice){[m
[31m-            return view("Userurl/no_data");[m
[31m-        }[m
[31m-        $this->assign('notice',$notice);[m
[31m-        return view("Userurl/notify_list");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-26T16:29:39+0800[m
[31m-     * @version  [version][m
[31m-     * @param    [type]                   $id [announcement_id][m
[31m-     * @return   [type]                       [å¹³å°å…¬å‘Šè¯¦æƒ…][m
[31m-     */[m
[31m-    public function notify_list_detail($id){[m
[31m-        $this->checkToken();[m
[31m-        $notice=Notice::get($id);[m
[31m-        $notice->save(['notice_status'=>1]);[m
[31m-        $this->assign('notice',$notice);[m
[31m-        return view("Userurl/notify_list_detail");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [åŠ¨è´¦äº¤æ˜“åˆ—è¡¨][m
[31m-     * @return   [type][m
[31m-     */[m
[31m-    public function deal_list(){[m
[31m-        // $this->checkToken();[m
[31m-        $this->param['uid']=input("uid");[m
[31m-        $page = empty(input("page"))?1:input("page");[m
[31m-        if($_POST){[m
[31m-            $start = ($page-1)*10;[m
[31m-            $CashOrder=CashOrder::with("passageway")->where(['order_member'=>$this->param['uid'],'order_money' => ['<>' , 0]])->order('order_id desc')->limit($start,10)->select();[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [æ¶ˆæ¯][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m	[32m public function notify(){[m
[32m+[m		[32m $this->checkToken();[m
[32m+[m	[41m [m	[32m$count=Notice::where(['notice_recieve'=>$this->param['uid'],'notice_status'=>0])->count();[m
[32m+[m		[32m$this->assign('count',$count);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/notify");[m
[32m+[m	[32m }[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [å¹³å°å…¬å‘Šåˆ—è¡¨][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m	[32mpublic function notify_list(){[m
[32m+[m		[32m$this->checkToken();[m
[32m+[m		[32m$notice=Notice::where(['notice_recieve'=>$this->param['uid']])->order('notice_createtime desc')->select();[m
[32m+[m		[32mif(!$notice){[m
[32m+[m			[32mreturn view("Userurl/no_data");[m
[32m+[m		[32m}[m
[32m+[m		[32m$this->assign('notice',$notice);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/notify_list");[m
[32m+[m	[32m}[m
[32m+[m[32m  public function no_data(){[m
[32m+[m[32m    return view("Userurl/no_data");[m
[32m+[m[32m  }[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-26T16:29:39+0800[m
[32m+[m	[32m * @version  [version][m
[32m+[m	[32m * @param    [type]                   $id [announcement_id][m
[32m+[m	[32m * @return   [type]                       [å¹³å°å…¬å‘Šè¯¦æƒ…][m
[32m+[m	[32m */[m
[32m+[m	[32mpublic function notify_list_detail($id){[m
[32m+[m		[32m$this->checkToken();[m
[32m+[m		[32m$notice=Notice::get($id);[m
[32m+[m		[32m$notice->save(['notice_status'=>1]);[m
[32m+[m		[32m$this->assign('notice',$notice);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/notify_list_detail");[m
[32m+[m	[32m}[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [åŠ¨è´¦äº¤æ˜“åˆ—è¡¨][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m	[32mpublic function deal_list(){[m
[32m+[m		[32m// $this->checkToken();[m
[32m+[m		[32m$this->param['uid']=input("uid");[m
[32m+[m		[32m$page = empty(input("page"))?1:input("page");[m
[32m+[m		[32mif($_POST){[m
[32m+[m			[32m$start = ($page-1)*10;[m
[32m+[m			[32m$CashOrder=CashOrder::with("passageway")->where(['order_member'=>$this->param['uid'],'order_money' => ['<>' , 0]])->order('order_id desc')->limit($start,10)->select();[m
 [m
[31m-            foreach ($CashOrder as $key => $value) {[m
[31m-                $CashOrder[$key]["bank_ons"] = substr($value['order_creditcard'], -4);[m
[31m-                $CashOrder[$key]['add_time'] = date("m-d H:s",strtotime($value['order_add_time']));[m
[31m-            }[m
[31m-            echo json_encode(["data" => $CashOrder, "page" => $page+1]);die;[m
[31m-        }[m
[31m-        $CashOrder=CashOrder::with("passageway")->where(['order_member'=>$this->param['uid'],'order_money' => ['<>' , 0]])->order('order_id desc')->limit(0,10)->select();[m
[31m-        $count = CashOrder::where(['order_member'=>$this->param['uid'],'order_money' => ['<>' , 0]])->order('order_id desc')->count();[m
[31m-            $pages = ceil($count/10);[m
[31m-            #æˆªå–é“¶è¡Œå¡å·[m
[31m-        foreach ($CashOrder as $key => $value) {[m
[31m-            $CashOrder[$key]["bank_ons"] = substr($value['order_creditcard'], -4);[m
[31m-            $CashOrder[$key]['add_time'] = date("m-d H:s",strtotime($value['order_add_time']));[m
[31m-        }[m
[31m-        if(!$CashOrder){[m
[31m-            return view("Userurl/no_data");[m
[31m-        }[m
[31m-        $this->assign("pages",$pages);[m
[31m-        $this->assign('data',$CashOrder);[m
[31m-        return view("Userurl/deal_list");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [å¹³å°ç¦åˆ©åˆ—è¡¨][m
[31m-     * @return   [type][m
[31m-     */[m
[31m-    public function welfare_list(){[m
[31m-        $this->checkToken();[m
[31m-        //å–Recommentå†…å®¹[m
[31m-        $Recomment=Recomment::all(['recomment_member_id'=>$this->param['uid']]);[m
[31m-        $data=[];[m
[31m-        //è½¬å­˜[m
[31m-        foreach ($Recomment as $k => $v) {[m
[31m-            $data[$k]['recomment_money']=$v['recomment_money'];[m
[31m-            $data[$k]['recomment_desc']=$v['recomment_desc'];[m
[31m-            $data[$k]['recomment_creat_time']=$v['recomment_creat_time'];[m
[31m-        }[m
[31m-        if(!$data){[m
[31m-            return view("Userurl/no_data");[m
[31m-        }[m
[31m-        //Todo å¯¹åº”äº‹ä»¶æ•°æ® è¢«æ¨èç”¨æˆ·  æ“ä½œ[m
[31m-        $this->assign('data',$data);[m
[31m-        return view("Userurl/welfare_list");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [æ³¨å†Œé¡µé¢][m
[31m-     * @return   [type][m
[31m-     */[m
[31m-    public function register(){[m
[31m-        $this->param=request()->param();[m
[31m-        //æ˜¯å¦æºå¸¦æ‰‹æœºå·[m
[31m-        if(!isset($this->param['recomment']))[m
[31m-            return 'miss telephone number';[m
[31m-        $recomment=$this->param['recomment'];[m
[31m-        //æ‰‹æœºå·æ ¼å¼[m
[31m-        if(!preg_match('/1\d{10}/', $recomment))[m
[31m-            return 'incorrect telephone number';[m
[31m-        $recommentid=Members::get(['member_mobile'=>$recomment]);[m
[31m-        //è¯¥æ‰‹æœºå·æ˜¯å¦å­˜åœ¨[m
[31m-        if(!$recommentid)[m
[31m-            return 'recomment telephone isnt exist';[m
[31m-        $this->assign('tel',$recomment);[m
[31m-        return view("Userurl/register");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [ä¸‹è½½é¡µé¢][m
[31m-     * @return   [type][m
[31m-     */[m
[31m-    public function download(){[m
[31m-        $data['android_url']=Appversion::where(['version_type'=>'android','version_state'=>1])->value('version_link');[m
[31m-        $data['ios_url']=Appversion::where(['version_type'=>'ios','version_state'=>1])->value('version_link');[m
[31m-        $this->assign('data',$data);[m
[31m-        return view("Userurl/download");[m
[31m-    }[m
[32m+[m			[32mforeach ($CashOrder as $key => $value) {[m
[32m+[m			[41m [m	[32m$CashOrder[$key]["bank_ons"] = substr($value['order_creditcard'], -4);[m
[32m+[m			[41m [m	[32m$CashOrder[$key]['add_time'] = date("m-d H:s",strtotime($value['order_add_time']));[m
[32m+[m			[32m}[m
[32m+[m			[32mecho json_encode(["data" => $CashOrder, "page" => $page+1]);die;[m
[32m+[m		[32m}[m
[32m+[m		[32m$CashOrder=CashOrder::with("passageway")->where(['order_member'=>$this->param['uid'],'order_money' => ['<>' , 0]])->order('order_id desc')->limit(0,10)->select();[m
[32m+[m		[32m$count = CashOrder::where(['order_member'=>$this->param['uid'],'order_money' => ['<>' , 0]])->order('order_id desc')->count();[m
[32m+[m			[32m$pages = ceil($count/10);[m
[32m+[m			[32m#æˆªå–é“¶è¡Œå¡å·[m
[32m+[m		[32mforeach ($CashOrder as $key => $value) {[m
[32m+[m			[32m$CashOrder[$key]["bank_ons"] = substr($value['order_creditcard'], -4);[m
[32m+[m			[32m$CashOrder[$key]['add_time'] = date("m-d H:s",strtotime($value['order_add_time']));[m
[32m+[m		[32m}[m
[32m+[m		[32mif(!$CashOrder){[m
[32m+[m			[32mreturn view("Userurl/no_data");[m
[32m+[m		[32m}[m
[32m+[m		[32m$this->assign("pages",$pages);[m
[32m+[m		[32m$this->assign('data',$CashOrder);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/deal_list");[m
[32m+[m	[32m}[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [å¹³å°ç¦åˆ©åˆ—è¡¨][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m	[32mpublic function welfare_list(){[m
[32m+[m		[32m$this->checkToken();[m
[32m+[m		[32m//å–Recommentå†…å®¹[m
[32m+[m		[32m$Recomment=Recomment::all(['recomment_member_id'=>$this->param['uid']]);[m
[32m+[m		[32m$data=[];[m
[32m+[m		[32m//è½¬å­˜[m
[32m+[m		[32mforeach ($Recomment as $k => $v) {[m
[32m+[m			[32m$data[$k]['recomment_money']=$v['recomment_money'];[m
[32m+[m			[32m$data[$k]['recomment_desc']=$v['recomment_desc'];[m
[32m+[m			[32m$data[$k]['recomment_creat_time']=$v['recomment_creat_time'];[m
[32m+[m		[32m}[m
[32m+[m		[32mif(!$data){[m
[32m+[m			[32mreturn view("Userurl/no_data");[m
[32m+[m		[32m}[m
[32m+[m		[32m//Todo å¯¹åº”äº‹ä»¶æ•°æ® è¢«æ¨èç”¨æˆ·  æ“ä½œ[m
[32m+[m		[32m$this->assign('data',$data);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/welfare_list");[m
[32m+[m	[32m}[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [æ³¨å†Œé¡µé¢][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m	[32mpublic function register(){[m
[32m+[m		[32m$this->param=request()->param();[m
[32m+[m		[32m//æ˜¯å¦æºå¸¦æ‰‹æœºå·[m
[32m+[m		[32mif(!isset($this->param['recomment']))[m
[32m+[m			[32mreturn 'miss telephone number';[m
[32m+[m		[32m$recomment=$this->param['recomment'];[m
[32m+[m		[32m//æ‰‹æœºå·æ ¼å¼[m
[32m+[m		[32mif(!preg_match('/1\d{10}/', $recomment))[m
[32m+[m			[32mreturn 'incorrect telephone number';[m
[32m+[m		[32m$recommentid=Members::get(['member_mobile'=>$recomment]);[m
[32m+[m		[32m//è¯¥æ‰‹æœºå·æ˜¯å¦å­˜åœ¨[m
[32m+[m		[32mif(!$recommentid)[m
[32m+[m			[32mreturn 'recomment telephone isnt exist';[m
[32m+[m		[32m$this->assign('tel',$recomment);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/register");[m
[32m+[m	[32m}[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [ä¸‹è½½é¡µé¢][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m	[32mpublic function download(){[m
[32m+[m		[32m$data['android_url']=Appversion::where(['version_type'=>'android','version_state'=>1])->value('version_link');[m
[32m+[m		[32m$data['ios_url']=Appversion::where(['version_type'=>'ios','version_state'=>1])->value('version_link');[m
[32m+[m		[32m$this->assign('data',$data);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/download");[m
[32m+[m	[32m}[m
 [m
   /**[m
    * @Author   æ¨æˆå¿—(3115317085@qq.com)[m
[36m@@ -848,7 +820,7 @@[m [mclass Userurl extends Controller[m
    * @return   [type][m
    */[m
   public function web_marketing_media_library(){[m
[31m-    $this->assign("name",System::getName("sitename"));[m
[32m+[m[41m  [m	[32m$this->assign("name",System::getName("sitename"));[m
     $generalizelist =  Generalize::generalizelist();[m
     $this->assign("generalizelist",$generalizelist);[m
     return view("api/logic/web_marketing_media_library");[m
[36m@@ -870,10 +842,10 @@[m [mclass Userurl extends Controller[m
     $phoneInfo = CustomerService::customerinfo("ç”µè¯");[m
     $this->assign("phoneInfo",$phoneInfo);[m
 [m
[31m-    [m
[31m-    $server['working_hours'] =  System::getName('working_hours');[m
[31m-    $server['phone'] = System::getName('contact_tel');//å…¬å¸è”ç³»ç”µè¯[m
[31m-    $this->assign("server",$server);[m
[32m+[m[41m  	[m
[32m+[m[41m  [m	[32m$server['working_hours'] =  System::getName('working_hours');[m
[32m+[m[41m  [m	[32m$server['phone'] = System::getName('contact_tel');//å…¬å¸è”ç³»ç”µè¯[m
[32m+[m[41m  [m	[32m$this->assign("server",$server);[m
     return $this->fetch("api/logic/web_contact_us");[m
   }[m
   /**[m
[36m@@ -897,11 +869,11 @@[m [mclass Userurl extends Controller[m
    * @return [type] [description][m
    */[m
   public function share_link_list(){[m
[31m-    $this->checkToken();[m
[31m-    $phone=Members::get($this->param['uid']);[m
[31m-    $phone=$phone->member_mobile;[m
[31m-    $url='http://'.$_SERVER['HTTP_HOST'].'/api/userurl/gotoregister/recomment/'.$phone;[m
[31m-    $this->assign('url',$url);[m
[32m+[m	[32m$this->checkToken();[m
[32m+[m	[32m$phone=Members::get($this->param['uid']);[m
[32m+[m	[32m$phone=$phone->member_mobile;[m
[32m+[m	[32m$url='http://'.$_SERVER['HTTP_HOST'].'/api/userurl/gotoregister/recomment/'.$phone;[m
[32m+[m	[32m$this->assign('url',$url);[m
     $list = Share::all();[m
     $this->assign("name",System::getName("sitename"));[m
     $this->assign("list",$list);[m
[36m@@ -913,345 +885,351 @@[m [mclass Userurl extends Controller[m
    * @return [type] [description][m
    */[m
   public function share_link(){[m
[31m-    $this->checkToken();[m
[31m-    $phone=Members::get($this->param['uid']);[m
[31m-    $phone=$phone->member_mobile;[m
[31m-    $url='http://'.$_SERVER['HTTP_HOST'].'/api/userurl/register/recomment/'.$phone;[m
[31m-    $this->assign('url',$url);[m
[32m+[m	[32m$this->checkToken();[m
[32m+[m	[32m$phone=Members::get($this->param['uid']);[m
[32m+[m	[32m$phone=$phone->member_mobile;[m
[32m+[m	[32m$url='http://'.$_SERVER['HTTP_HOST'].'/api/userurl/register/recomment/'.$phone;[m
[32m+[m	[32m$this->assign('url',$url);[m
     return view("Userurl/share_link");[m
   }[m
   #åˆ†äº«çš„æ³¨å†Œé¡µ åªæœ‰ä¸€ä¸ªæŒ‰é’®çš„é‚£ä¸ª[m
   public function gotoregister(){[m
[31m-    $this->param=request()->param();[m
[31m-    #é‘«é‘«é’±æŸœngixæŠ¥é”™ æ”¹ç”¨idæŸ¥è¯¢src å…¼å®¹ä»¥å‰é“¾æ¥[m
[31m-    if(isset($this->param['share_thumb'])){[m
[31m-        $share_thumb=preg_replace('/~/', '/', $this->param['share_thumb']);[m
[31m-    }else{[m
[31m-        $Share=Share::get($this->param['share_id']);[m
[31m-        $share_thumb=$Share->share_thumb;[m
[31m-    }[m
[31m-    $url='http://'.$_SERVER['HTTP_HOST'].'/api/userurl/register/recomment/'.$this->param['recomment'];[m
[31m-    $this->assign('url',$url);[m
[31m-    $this->assign('share_thumb',$share_thumb);[m
[31m-    return view("Userurl/gotoregister");[m
[32m+[m[41m  [m	[32m$this->param=request()->param();[m
[32m+[m[41m  [m	[32m#é‘«é‘«é’±æŸœngixæŠ¥é”™ æ”¹ç”¨idæŸ¥è¯¢src å…¼å®¹ä»¥å‰é“¾æ¥[m
[32m+[m[41m  [m	[32mif(isset($this->param['share_thumb'])){[m
[32m+[m	[41m  [m	[32m$share_thumb=preg_replace('/~/', '/', $this->param['share_thumb']);[m
[32m+[m[41m  [m	[32m}else{[m
[32m+[m	[41m  [m	[32m$Share=Share::get($this->param['share_id']);[m
[32m+[m	[41m  [m	[32m$share_thumb=$Share->share_thumb;[m
[32m+[m[41m  [m	[32m}[m
[32m+[m[41m  [m	[32m$url='http://'.$_SERVER['HTTP_HOST'].'/api/userurl/register/recomment/'.$this->param['recomment'];[m
[32m+[m	[32m$this->assign('url',$url);[m
[32m+[m	[32m$this->assign('share_thumb',$share_thumb);[m
[32m+[m[41m  [m	[32mreturn view("Userurl/gotoregister");[m
   }[m
   #è´¹ç‡è¯´æ˜[m
   public function my_rates(){[m
[31m-    // $this->param['uid']=26;[m
[32m+[m[41m  [m	[32m// $this->param['uid']=26;[m
 [m
[31m-    // $passageway=Passageway::where(['passageway_state'=>1,'passageway_also'=>1])->select();[m
[31m-    // var_dump($passageway);die;[m
[31m-     #è·å–æ‰€æœ‰é€šé“[m
[31m-    #è·å–æ‰€æœ‰ç¨ç‡[m
[31m-    // $also=PassagewayItem::haswhere('passageway',['passageway_state'=>1])->select();[m
[31m-    $also=db('passageway')->where(['passageway_state'=>1])->order('passageway_also')->select();[m
[31m-    foreach ($also as $k => $v) {[m
[31m-        $also[$k]['details']=db('passageway_item')->alias('i')[m
[31m-            ->join('member_group g','i.item_group=g.group_id')[m
[31m-            ->where('i.item_passageway',$v['passageway_id'])->select();[m
[31m-    }[m
[31m-    $this->assign('also',$also);[m
[31m-    return view("Userurl/my_rates");[m
[32m+[m[41m  [m	[32m// $passageway=Passageway::where(['passageway_state'=>1,'passageway_also'=>1])->select();[m
[32m+[m[41m  [m	[32m// var_dump($passageway);die;[m
[32m+[m[41m  [m	[32m #è·å–æ‰€æœ‰é€šé“[m
[32m+[m[41m  [m	[32m#è·å–æ‰€æœ‰ç¨ç‡[m
[32m+[m[41m  [m	[32m// $also=PassagewayItem::haswhere('passageway',['passageway_state'=>1])->select();[m
[32m+[m[41m  [m	[32m$also=db('passageway')->where(['passageway_state'=>1])->order('passageway_also')->select();[m
[32m+[m[41m  [m	[32mforeach ($also as $k => $v) {[m
[32m+[m[41m  [m		[32m$also[$k]['details']=db('passageway_item')->alias('i')[m
[32m+[m[41m  [m			[32m->join('member_group g','i.item_group=g.group_id')[m
[32m+[m[41m  [m			[32m->where('i.item_passageway',$v['passageway_id'])->select();[m
[32m+[m[41m  [m	[32m}[m
[32m+[m[41m  [m	[32m$this->assign('also',$also);[m
[32m+[m[41m  [m	[32mreturn view("Userurl/my_rates");[m
   }[m
   #ç›ˆåˆ©æ¨¡å¼è¯´æ˜[m
   public function explain(){[m
[31m-        $description=Article::hasWhere('articleCategorys',['category_name'=>'ç›ˆåˆ©æ¨¡å¼è¯´æ˜'])->join("wt_article_data","data_article=article_id")->field("data_text")->find();[m
[31m-        $this->assign('data',$description);[m
[31m-        return view("Userurl/explain");[m
[32m+[m[41m  [m		[32m$description=Article::hasWhere('articleCategorys',['category_name'=>'ç›ˆåˆ©æ¨¡å¼è¯´æ˜'])->join("wt_article_data","data_article=article_id")->field("data_text")->find();[m
[32m+[m[41m  [m		[32m$this->assign('data',$description);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/explain");[m
   }[m
   #å…³äºæˆ‘ä»¬[m
   public function about_us(){[m
[31m-    $data=Page::get(1);[m
[31m-    $server['weixin']=CustomerService::where('service_title','å¾®ä¿¡')->find();[m
[31m-    #èµ„æ ¼è¯ä¹¦[m
[31m-    $datas = Page::get(4);[m
[31m-    $this->assign("datas",$datas);[m
[31m-    $server['qq']=CustomerService::where('service_title','QQ')->find();[m
[32m+[m[41m  [m	[32m$data=Page::get(1);[m
[32m+[m[41m  [m	[32m$server['weixin']=CustomerService::where('service_title','å¾®ä¿¡')->find();[m
[32m+[m[41m  [m	[32m#èµ„æ ¼è¯ä¹¦[m
[32m+[m[41m  [m	[32m$datas = Page::get(4);[m
[32m+[m[41m  [m	[32m$this->assign("datas",$datas);[m
[32m+[m[41m  [m	[32m$server['qq']=CustomerService::where('service_title','QQ')->find();[m
 [m
[31m-    $server['tel']=CustomerService::where('service_title','ç”µè¯')->find();[m
[31m-    $server['company_address'] = System::getName('company_address');[m
[31m-    $server['working_hours'] = System::getName('working_hours');[m
[31m-    $server['phone'] = System::getName('contact_tel');//å…¬å¸è”ç³»ç”µè¯[m
[31m-    $this->assign('data', $data);[m
[31m-    $this->assign('server', $server);[m
[31m-    return view("Userurl/about_us");[m
[32m+[m[41m  [m	[32m$server['tel']=CustomerService::where('service_title','ç”µè¯')->find();[m
[32m+[m[41m  [m	[32m$server['company_address'] = System::getName('company_address');[m
[32m+[m[41m  [m	[32m$server['working_hours'] = System::getName('working_hours');[m
[32m+[m[41m  [m	[32m$server['phone'] = System::getName('contact_tel');//å…¬å¸è”ç³»ç”µè¯[m
[32m+[m[41m  [m	[32m$this->assign('data', $data);[m
[32m+[m[41m  [m	[32m$this->assign('server', $server);[m
[32m+[m[41m  [m	[32mreturn view("Userurl/about_us");[m
   }[m
   /**[m
    * [web_freshman_guide æ–°æ‰‹æŒ‡å¼•][m
    * @return [type] [description][m
    */[m
    public function web_freshman_guide(){[m
[31m-        // $class = NoviceClasss::all();[m
[31m-        // #è¿˜æ¬¾åˆ—è¡¨[m
[31m-        // foreach ($class as $key => $value) {[m
[31m-        //  $class[$key]['repaymentList'] = MemberNovice::lists($value['novice_class_id']);[m
[31m-        // }[m
[31m-        // $this->assign("class",$class);[m
[31m-        return view("api/logic/web_freshman_guide");[m
[32m+[m[41m   [m		[32m// $class = NoviceClasss::all();[m
[32m+[m[41m   [m		[32m// #è¿˜æ¬¾åˆ—è¡¨[m
[32m+[m[41m   [m		[32m// foreach ($class as $key => $value) {[m
[32m+[m[41m   [m		[32m// 	$class[$key]['repaymentList'] = MemberNovice::lists($value['novice_class_id']);[m
[32m+[m[41m   [m		[32m// }[m
[32m+[m[41m   [m		[32m// $this->assign("class",$class);[m
[32m+[m[41m    [m	[32mreturn view("api/logic/web_freshman_guide");[m
   }[m
   /**[m
   *@version [instructicons_detail æ–°æ‰‹æŒ‡å¼•è¯¦æƒ…é¡µé¢][m
   *@author æ¨æˆå¿— ã€3115317085@qq.comã€‘[m
   */[m
   public function instructions_detail(){[m
[31m-    $title = input('title');[m
[31m-    $this->assign("title",$title);[m
[31m-    $info = MemberNovice::where(['novice_name' => $title])->find();[m
[31m-    $this->assign("info",$info);[m
[31m-    return view('api/logic/instructions_detail');[m
[32m+[m[41m  [m	[32m$title = input('title');[m
[32m+[m[41m  [m	[32m$this->assign("title",$title);[m
[32m+[m[41m  [m	[32m$info = MemberNovice::where(['novice_name' => $title])->find();[m
[32m+[m[41m  [m	[32m$this->assign("info",$info);[m
[32m+[m[41m  [m	[32mreturn view('api/logic/instructions_detail');[m
   }[m
   #ä¿¡ç”¨å¡è¯´æ˜[m
   public function card_description(){[m
[31m-    $CreditCard = new CreditCard();[m
[31m-    $list = $CreditCard->where(['bank_passageway_id'=>Request::instance()->param('id')])->select();[m
[31m-    $this->assign('list',$list);[m
[31m-    return view("api/logic/card_description");[m
[32m+[m[41m  [m	[32m$CreditCard = new CreditCard();[m
[32m+[m[41m  [m	[32m$list = $CreditCard->where(['bank_passageway_id'=>Request::instance()->param('id')])->select();[m
[32m+[m[41m  [m	[32m$this->assign('list',$list);[m
[32m+[m[41m  [m	[32mreturn view("api/logic/card_description");[m
   }[m
   /**[m
   *@version particulars æ”¶æ”¯æ˜ç»†[m
   *@author æ¨æˆå¿— ï¼ˆ3115317085@qq.comï¼‰[m
   */[m
   public function particulars($month=null){[m
[31m-        if(!$month)$month=date('Y-m');[m
[32m+[m[41m    [m	[32mif(!$month)$month=date('Y-m');[m
       //æœˆåˆ[m
       $monthstart=strtotime($month);[m
       //æœˆæœ«[m
       $monthend=strtotime(date('Y-m',strtotime('+1 month',strtotime($month))));[m
[31m-      $data=[];[m
[31m-        $data['in']=0;[m
[31m-        $data['out']=0;[m
[31m-        //æ‰‹åŠ¨ä¸‹æ»‘è·å–æ•°æ®[m
[31m-        if($_POST){[m
[31m-            $page = isset($_POST['page'])?$_POST['page']:1;[m
[31m-            #è·å–æ”¶æ”¯æ˜ç»†æ•°æ®[m
[31m-            $result = WalletLog::pages(input('uid'),$page,$data,$month,$monthstart,$monthend);[m
[31m-            $list = $result['list'];[m
[31m-            exit(json_encode($list));[m
[31m-        }[m
[31m-       $this->checkToken();[m
[31m-      #è·å–æ”¶æ”¯æ˜ç»†æ•°æ®[m
[31m-        $result = WalletLog::pages($this->param['uid'],1,$data,$month,$monthstart,$monthend);[m
[31m-        //ç”¨æˆ·id[m
[31m-        $this->assign("uid",$this->param['uid']);[m
[31m-        #å½“å‰æ€»å…±å¤šå°‘é¡µ[m
[31m-        $this->assign("allpage" , $result['allpage']);[m
[31m-        $this->assign('data' , $result['data']);[m
[31m-        $this->assign('list' , $result['list']);[m
[31m-        return view("Userurl/particulars");[m
[32m+[m[41m  [m	[32m  $data=[];[m
[32m+[m[41m    [m	[32m$data['in']=0;[m
[32m+[m[41m    [m	[32m$data['out']=0;[m
[32m+[m[41m    [m	[32m//æ‰‹åŠ¨ä¸‹æ»‘è·å–æ•°æ®[m
[32m+[m[41m    [m	[32mif($_POST){[m
[32m+[m[41m    [m		[32m$page = isset($_POST['page'])?$_POST['page']:1;[m
[32m+[m[41m    [m		[32m#è·å–æ”¶æ”¯æ˜ç»†æ•°æ®[m
[32m+[m[41m    [m		[32m$result = WalletLog::pages(input('uid'),$page,$data,$month,$monthstart,$monthend);[m
[32m+[m[41m    [m		[32m$list = $result['list'];[m
[32m+[m[41m    [m		[32mexit(json_encode($list));[m
[32m+[m[41m    [m	[32m}[m
[32m+[m[41m  [m	[32m   $this->checkToken();[m
[32m+[m[41m   [m	[32m  #è·å–æ”¶æ”¯æ˜ç»†æ•°æ®[m
[32m+[m[41m    [m	[32m$result = WalletLog::pages($this->param['uid'],1,$data,$month,$monthstart,$monthend);[m
[32m+[m[41m    [m	[32m//ç”¨æˆ·id[m
[32m+[m[41m    [m	[32m$this->assign("uid",$this->param['uid']);[m
[32m+[m[41m    [m	[32m#å½“å‰æ€»å…±å¤šå°‘é¡µ[m
[32m+[m[41m    [m	[32m$this->assign("allpage" , $result['allpage']);[m
[32m+[m[41m    [m	[32m$this->assign('data' , $result['data']);[m
[32m+[m[41m    [m	[32m$this->assign('list' , $result['list']);[m
[32m+[m[41m    [m	[32mreturn view("Userurl/particulars");[m
   }[m
   #è´¦å•è¯¦æƒ…[m
   # log_id  wallet_log_id[m
   public function bills_detail($log_id){[m
[31m-    $this->checkToken();[m
[31m-    $wallet_log=db('wallet_log')->where('log_id',$log_id)->find();[m
[31m-    switch ($wallet_log['log_relation_type']){[m
[31m-        //åˆ†æ¶¦åˆ†ä½£[m
[31m-        case 1:[m
[31m-            $commission=db('commission')->alias('c')[m
[31m-                ->join('member m','c.commission_childen_member=m.member_id')[m
[31m-                ->where('c.commission_id',$wallet_log['log_relation_id'])[m
[31m-                ->find();[m
[31m-            if($commission){[m
[31m-                $tel=$commission['member_mobile'];[m
[31m-                $commission['member_mobile']=substr($tel,0,3).'****'.substr($tel,7);[m
[31m-                $this->assign('commission',$commission);[m
[31m-            }[m
[31m-            break;[m
[31m-        //æç°æ“ä½œ[m
[31m-        case 2:[m
[31m-            $withdraw=db('withdraw')->where('withdraw_id',$wallet_log['log_relation_id'])->find();[m
[31m-            if($withdraw)$withdraw['info']=state_info($withdraw['withdraw_state']);[m
[31m-            $this->assign('withdraw',$withdraw);[m
[31m-            break;[m
[31m-            //æ¨èçº¢åŒ…[m
[31m-        case 5:[m
[31m-            $recomment=db('recomment')->alias('r')[m
[31m-                ->join('member m','r.recomment_children_member=m.member_id')[m
[31m-                ->where('r.recomment_id',$wallet_log['log_relation_id'])[m
[31m-                ->find();[m
[31m-            if($recomment){[m
[31m-                $tel=$recomment['member_mobile'];[m
[31m-                $recomment['member_mobile']=substr($tel,0,3).'****'.substr($tel,7);[m
[31m-                $this->assign('recomment',$recomment);[m
[31m-            }[m
[31m-        default:[m
[31m-            # code...[m
[31m-            break;[m
[31m-    }[m
[31m-    $this->assign('wallet_log',$wallet_log);[m
[31m-    return view("Userurl/bills_detail");[m
[32m+[m[41m  [m	[32m$this->checkToken();[m
[32m+[m[41m  [m	[32m$wallet_log=db('wallet_log')->where('log_id',$log_id)->find();[m
[32m+[m[41m  [m	[32mswitch ($wallet_log['log_relation_type']){[m
[32m+[m[41m  [m		[32m//åˆ†æ¶¦åˆ†ä½£[m
[32m+[m[41m  [m		[32mcase 1:[m
[32m+[m[41m  [m			[32m$commission=db('commission')->alias('c')[m
[32m+[m[41m  [m				[32m->join('member m','c.commission_childen_member=m.member_id')[m
[32m+[m[41m  [m				[32m->where('c.commission_id',$wallet_log['log_relation_id'])[m
[32m+[m[41m  [m				[32m->find();[m
[32m+[m[41m  [m			[32mif($commission){[m
[32m+[m	[41m  [m			[32m$tel=$commission['member_mobile'];[m
[32m+[m	[41m  [m			[32m$commission['member_mobile']=substr($tel,0,3).'****'.substr($tel,7);[m
[32m+[m	[41m  [m			[32m$this->assign('commission',$commission);[m
[32m+[m[41m  [m			[32m}[m
[32m+[m[41m  [m			[32mbreak;[m
[32m+[m[41m  [m		[32m//æç°æ“ä½œ[m
[32m+[m[41m  [m		[32mcase 2:[m
[32m+[m[41m  [m			[32m$withdraw=db('withdraw')->where('withdraw_id',$wallet_log['log_relation_id'])->find();[m
[32m+[m[41m  [m			[32mif($withdraw)$withdraw['info']=state_info($withdraw['withdraw_state']);[m
[32m+[m[41m  [m			[32m$this->assign('withdraw',$withdraw);[m
[32m+[m[41m  [m			[32mbreak;[m
[32m+[m[41m  [m			[32m//æ¨èçº¢åŒ…[m
[32m+[m[41m  [m		[32mcase 5:[m
[32m+[m[41m  [m			[32m$recomment=db('recomment')->alias('r')[m
[32m+[m[41m  [m				[32m->join('member m','r.recomment_children_member=m.member_id')[m
[32m+[m[41m  [m				[32m->where('r.recomment_id',$wallet_log['log_relation_id'])[m
[32m+[m[41m  [m				[32m->find();[m
[32m+[m[41m  [m			[32mif($recomment){[m
[32m+[m	[41m  [m			[32m$tel=$recomment['member_mobile'];[m
[32m+[m	[41m  [m			[32m$recomment['member_mobile']=substr($tel,0,3).'****'.substr($tel,7);[m
[32m+[m	[41m [m			[32m$this->assign('recomment',$recomment);[m
[32m+[m[41m  [m			[32m}[m
[32m+[m[41m  [m		[32mdefault:[m
[32m+[m[41m  [m			[32m# code...[m
[32m+[m[41m  [m			[32mbreak;[m
[32m+[m[41m  [m	[32m}[m
[32m+[m[41m  [m	[32m$this->assign('wallet_log',$wallet_log);[m
[32m+[m[41m  [m	[32mreturn view("Userurl/bills_detail");[m
   }[m
   # è£é‚¦ å¼€é€šå¿«æ·æ”¯ä»˜ä¸è¿”å›htmlæ—¶ è°ƒç”¨æœ¬é¡µé¢ [m
   # memberId ç”¨æˆ·id passwayId é€šé“id[m
   # treatycode åè®®å· smsseq çŸ­ä¿¡éªŒè¯ç æµæ°´å·[m
   public function passway_rongbang_openpay($memberId,$passwayId,$treatycode,$smsseq){[m
[31m-    if(request()->ispost()){[m
[31m-        $authcode=request()->param()['authcode'];[m
[31m-        if($authcode){[m
[31m-            $Membernets=new con\Membernets($memberId,$passwayId);[m
[31m-            $result=$Membernets->rongbang_confirm_openpay($treatycode,$smsseq,$authcode);[m
[31m-            return is_array($result) ? 1 : $result;[m
[31m-          }else{[m
[31m-            return 2;[m
[31m-          }[m
[31m-    }[m
[31m-    $this->assign('memberId',$memberId);[m
[31m-    $this->assign('passwayId',$passwayId);[m
[31m-    $this->assign('treatycode',$treatycode);[m
[31m-    $this->assign('smsseq',$smsseq);[m
[31m-    return view("Userurl/passway_rongbang_openpay");[m
[32m+[m[41m  [m	[32mif(request()->ispost()){[m
[32m+[m[41m  [m		[32m$authcode=request()->param()['authcode'];[m
[32m+[m[41m  [m		[32mif($authcode){[m
[32m+[m		[41m  [m	[32m$Membernets=new con\Membernets($memberId,$passwayId);[m
[32m+[m		[41m  [m	[32m$result=$Membernets->rongbang_confirm_openpay($treatycode,$smsseq,$authcode);[m
[32m+[m		[41m  [m	[32mreturn $result ? 1 : 3;[m
[32m+[m		[32m  }else{[m
[32m+[m		[41m  [m	[32mreturn 2;[m
[32m+[m		[32m  }[m
[32m+[m[41m  [m	[32m}[m
[32m+[m[41m  [m	[32m$this->assign('memberId',$memberId);[m
[32m+[m[41m  [m	[32m$this->assign('passwayId',$passwayId);[m
[32m+[m[41m  [m	[32m$this->assign('treatycode',$treatycode);[m
[32m+[m[41m  [m	[32m$this->assign('smsseq',$smsseq);[m
[32m+[m[41m  [m	[32mreturn view("Userurl/passway_rongbang_openpay");[m
   }[m
   # è£é‚¦ ç”³è¯·å¿«æ·æ”¯ä»˜è®¢å•ä¸è¿”å›htmlæ—¶ è°ƒç”¨æœ¬é¡µé¢ [m
   # memberId ç”¨æˆ·id passwayId é€šé“id[m
   # ordercode è®¢å•å· card_id å¡å·[m
 [m
   public function passway_rongbang_pay($memberId,$passwayId,$ordercode,$card_id){[m
[31m-    if(request()->ispost()){[m
[31m-        $authcode=request()->param()['authcode'];[m
[31m-        if($authcode){[m
[31m-            $Membernets=new con\Membernets($memberId,$passwayId);[m
[31m-            $result=$Membernets->rongbang_confirm_pay($ordercode,$card_id,$authcode);[m
[31m-            return is_array($result) ? 1 : $result;[m
[31m-          }else{[m
[31m-            return 2;[m
[31m-          }[m
[31m-    }[m
[31m-    #ç”¨æˆ·ä¿¡æ¯[m
[31m-    $info = Members::with("memberCashcard")->where(['member_id' => $memberId])->find();[m
[31m-    $money=db('cash_order')->where('order_thead_no',$ordercode)->value('order_money');[m
[31m-    $creditcard = MemberCreditcard::where(['card_id' => $card_id])->find();[m
[31m-    $this->assign("creditcard",$creditcard);[m
[31m-    $this->assign("member_info",$info);[m
[31m-    $this->assign('memberId',$memberId);[m
[31m-    $this->assign('money',$money);[m
[31m-    $this->assign('passwayId',$passwayId);[m
[31m-    $this->assign('ordercode',$ordercode);[m
[31m-    $this->assign('card_id',$card_id);[m
[31m-    return view("Userurl/passway_rongbang_pay");[m
[32m+[m[41m  [m	[32mif(request()->ispost()){[m
[32m+[m[41m  [m		[32m$authcode=request()->param()['authcode'];[m
[32m+[m[41m  [m		[32mif($authcode){[m
[32m+[m		[41m  [m	[32m$Membernets=new con\Membernets($memberId,$passwayId);[m
[32m+[m		[41m  [m	[32m$result=$Membernets->rongbang_confirm_pay($ordercode,$card_id,$authcode);[m
[32m+[m		[41m  [m	[32mreturn is_array($result) ? 1 : $result;[m
[32m+[m		[32m  }else{[m
[32m+[m		[41m  [m	[32mreturn 2;[m
[32m+[m		[32m  }[m
[32m+[m[41m  [m	[32m}[m
[32m+[m[41m  [m	[32m#ç”¨æˆ·ä¿¡æ¯[m
[32m+[m[41m  [m	[32m$info = Members::with("memberCashcard")->where(['member_id' => $memberId])->find();[m
[32m+[m[41m  [m	[32m$money=db('cash_order')->where('order_thead_no',$ordercode)->value('order_money');[m
[32m+[m[41m  [m	[32m$creditcard = MemberCreditcard::where(['card_id' => $card_id])->find();[m
[32m+[m[41m  [m	[32m$this->assign("creditcard",$creditcard);[m
[32m+[m[41m  [m	[32m$this->assign("member_info",$info);[m
[32m+[m[41m  [m	[32m$this->assign('memberId',$memberId);[m
[32m+[m[41m  [m	[32m$this->assign('money',$money);[m
[32m+[m[41m  [m	[32m$this->assign('passwayId',$passwayId);[m
[32m+[m[41m  [m	[32m$this->assign('ordercode',$ordercode);[m
[32m+[m[41m  [m	[32m$this->assign('card_id',$card_id);[m
[32m+[m[41m  [m	[32mreturn view("Userurl/passway_rongbang_pay");[m
   }[m
 [m
   #è£é‚¦æ”¯ä»˜å›è°ƒ[m
   public function passway_rongbang_paycallback(){[m
[31m-    $param=request()->param();[m
[31m-    #è£é‚¦é€šé“é”®ä½[m
[31m-    $passageway_no=db('passageway')->column("passageway_id,passageway_no");[m
[31m-    $userinfo=db('member_net')->where('net_member_id',$param['member_id'])[m
[31m-        ->value($passageway_no[$param['passageway_id']]);[m
[31m-    // $userinfo="402628739,1756961550411722,9abphqw0bcz2vr3r,zeo3qvxb0nwuobk5619hss25h1dsremg,è®¸æˆæˆ11599";[m
[31m-    #ä¿¡æ¯é¡ºåº 0ã€appid 1ã€companycode 2ã€secretkey 3ã€session 4ã€companyname[m
[31m-      $userinfo=explode(',', $userinfo);[m
[31m-    $key=$userinfo[2];[m
[31m-    // return rongbang_aes_decode($key,rongbang_aes($key,$param['test']));[m
[31m-    $data = rongbang_aes_decode($key,$param['Data']);[m
[31m-    // var_dump($data);die;[m
[31m-    if($data=='err'){[m
[31m-        #å¤±è´¥æ—¥å¿—[m
[31m-        trace("rongbang_aes_decode_err");[m
[31m-    }else{[m
[31m-        $data=json_decode($data,1);[m
[31m-            $cash_order=CashOrder::where('order_no',$param['order_no'])->find();[m
[31m-        if($data['respcode']==2){[m
[31m-          #æŸ¥çœ‹æ˜¯å¦æœ‰è¯¥è®¢å•çš„åˆ†æ¶¦è®°å½•[m
[31m-          $hasCommission=db('commission')->where(['commission_from'=>$cash_order->order_id,'commission_type'=>1])->count();[m
[31m-            #ä»…å¯¹å¾…æ”¯ä»˜çŠ¶æ€ä¸‹çš„è®¢å•è¿›è¡Œæ›´æ–°å¹¶åˆ†æ¶¦[m
[31m-            if($cash_order->order_state!=2 && $hasCommission == 0){[m
[31m-                $cash_order->order_state=2;[m
[31m-                //åˆ†æ¶¦[m
[31m-                $fenrun= new con\Commission();[m
[31m-                $fenrun_result=$fenrun->MemberFenRun($param['member_id'],$cash_order->order_money,$param['passageway_id'],1,'å¿«æ·æ”¯ä»˜æ‰‹ç»­è´¹åˆ†æ¶¦',$cash_order->order_id);[m
[31m-            $member=Members::get($param['member_id']);[m
[31m-            $passway=Passageway::get($param['passageway_id']);[m
[31m-            $passwayitem=PassagewayItem::get(['item_group'=>$member->member_group_id,'item_passageway'=>$passway->passageway_id]);[m
[31m-          if($fenrun_result['code']=="200"){[m
[31m-            $cash_order->order_fen=$fenrun_result['leftmoney'];[m
[31m-            $cash_order->order_buckle=$passwayitem->item_charges/100;[m
[31m-            $cash_order->order_platform=$cash_order->order_charge-($cash_order->order_money*$passway->passageway_rate/100)+$passwayitem->item_charges/100-$passway->passageway_income;[m
[31m-          }else{[m
[31m-            $cash_order->order_fen=-1;[m
[31m-            $cash_order->order_buckle=$passwayitem->item_charges/100;[m
[31m-            $cash_order->order_platform=$cash_order->order_charge-($cash_order->order_money*$passway->passageway_rate/100)+$passwayitem->item_charges/100-$passway->passageway_income;[m
[31m-          }[m
[31m-          $cash_order->save();[m
[31m-            }else{[m
[31m-                trace("rongbang_repeat_request,not fenrun");[m
[31m-            }[m
[31m-        }else{[m
[31m-            $cash_order->order_state=-1;[m
[31m-            $cash_order->order_desc.=$data['respmsg'];[m
[31m-            $cash_order->save();[m
[31m-        }[m
[31m-    }[m
[31m-    //æŒ‰æ–‡æ¡£è¦æ±‚è¿”å›[m
[31m-    return json_encode(['message'=>'ok','response'=>'00']);[m
[32m+[m[41m  [m	[32m$param=request()->param();[m
[32m+[m[41m  [m	[32m#è£é‚¦é€šé“é”®ä½[m
[32m+[m[41m  [m	[32m$passageway_no=db('passageway')->column("passageway_id,passageway_no");[m
[32m+[m[41m  [m	[32m$userinfo=db('member_net')->where('net_member_id',$param['member_id'])[m
[32m+[m[41m  [m		[32m->value($passageway_no[$param['passageway_id']]);[m
[32m+[m[41m  [m	[32m// $userinfo="402628739,1756961550411722,9abphqw0bcz2vr3r,zeo3qvxb0nwuobk5619hss25h1dsremg,è®¸æˆæˆ11599";[m
[32m+[m	[32m#ä¿¡æ¯é¡ºåº 0ã€appid 1ã€companycode 2ã€secretkey 3ã€session 4ã€companyname[m
[32m+[m	[32m  $userinfo=explode(',', $userinfo);[m
[32m+[m[41m  [m	[32m$key=$userinfo[2];[m
[32m+[m[41m  [m	[32m// return rongbang_aes_decode($key,rongbang_aes($key,$param['test']));[m
[32m+[m[41m  [m	[32m$data = rongbang_aes_decode($key,$param['Data']);[m
[32m+[m[41m  [m	[32m// var_dump($data);die;[m
[32m+[m[41m  [m	[32mif($data=='err'){[m
[32m+[m[41m  [m		[32m#å¤±è´¥æ—¥å¿—[m
[32m+[m[41m  [m		[32mtrace("rongbang_aes_decode_err");[m
[32m+[m[41m  [m	[32m}else{[m
[32m+[m[41m  [m		[32m$data=json_decode($data,1);[m
[32m+[m[41m  [m		[32mif($data['respcode']==2){[m
[32m+[m[41m  [m			[32m$cash_order=CashOrder::where('order_no',$param['order_no'])->find();[m
[32m+[m[41m  [m			[32m#ä»…å¯¹å¾…æ”¯ä»˜çŠ¶æ€ä¸‹çš„è®¢å•è¿›è¡Œæ›´æ–°å¹¶åˆ†æ¶¦[m
[32m+[m[41m  [m			[32mif($cash_order->order_state==1){[m
[32m+[m[41m  [m				[32m$cash_order->order_state=2;[m
[32m+[m[41m  [m				[32m$cash_order->save();[m
[32m+[m				[32m//åˆ†æ¶¦[m
[32m+[m			[32m    $fenrun= new con\Commission();[m
[32m+[m			[32m    $fenrun_result=$fenrun->MemberFenRun($param['member_id'],$data['amount'],$param['passageway_id'],1,'äº¤æ˜“æ‰‹ç»­è´¹åˆ†æ¶¦',$cash_order->order_id);[m
[32m+[m[41m  [m			[32m}else{[m
[32m+[m[41m  [m				[32mtrace("rongbang_repeat_request,not fenrun");[m
[32m+[m[41m  [m			[32m}[m
[32m+[m[41m  [m		[32m}else{[m
[32m+[m			[32m$cash_order->order_state=-1;[m
[32m+[m			[32m$cash_order->order_desc.=$data['respmsg'];[m
[32m+[m			[32m$cash_order->save();[m
[32m+[m[41m  [m		[32m}[m
[32m+[m[41m  [m	[32m}[m
[32m+[m[41m  [m	[32m//æŒ‰æ–‡æ¡£è¦æ±‚è¿”å›[m
[32m+[m[41m  [m	[32mreturn json_encode(['message'=>'ok','response'=>'00']);[m
   }[m
   #ä¸ºæ— éœ€çŸ­ä¿¡ç¡®è®¤çš„æƒ…å†µ ç›´æ¥æ˜¾ç¤ºä¸€ä¸ªæˆåŠŸé¡µé¢[m
   public function passway_success(){[m
[31m-    return view("Userurl/passway_success");[m
[32m+[m[41m  [m	[32mreturn view("Userurl/passway_success");[m
   }[m
   # å¼€é€šå¿«æ·æ”¯ä»˜ å‰å°å›è°ƒæˆåŠŸé¡µé¢[m
   public function passway_open_success(){[m
[31m-    return view("Userurl/passway_open_success");[m
[32m+[m[41m  [m	[32mreturn view("Userurl/passway_open_success");[m
   }[m
   #å–æ¶ˆè¿˜æ¬¾è®¡åˆ’ã€æ•´ä½“ã€‘[m
   public function cancel_repayment($generation_id){[m
[31m-    $membernet=new con\Membernet();[m
[31m-    return json_encode($membernet->cancle_plan($generation_id));[m
[32m+[m[41m  [m	[32m$membernet=new con\Membernet();[m
[32m+[m[41m  [m	[32mreturn json_encode($membernet->cancle_plan($generation_id));[m
   }[m
   //é‡æ–°æ‰§è¡ŒæŸä¸ªè®¡åˆ’[m
   public function reset_one_repayment($plan_id){[m
[31m-        $membernet=new con\Membernet();[m
[31m-        $res=$membernet->action_single_plan($plan_id);[m
[31m-        echo $res;die;[m
[32m+[m[41m  [m		[32m$membernet=new con\Membernet();[m
[32m+[m[41m  [m		[32m$res=$membernet->action_single_plan($plan_id);[m
[32m+[m[41m  [m		[32mreturn $res;die;[m
   }[m
   //ä»£è¿˜ï¼Œç”¨æˆ·ç­¾çº¦ç•Œé¢[m
   public function signed($passageway_id,$cardId,$order_no){[m
[31m-        #ä¿¡ç”¨å¡ä¿¡æ¯[m
[31m-        $data['MemberCreditcard']=$MemberCreditcard=MemberCreditcard::where(['card_id'=>$cardId])->find();[m
[31m-        #é€šé“ä¿¡æ¯[m
[31m-        $data['passageway']=$passageway=Passageway::get($passageway_id);[m
[31m-        #é€šé“å…¥ç½‘ä¿¡æ¯[m
[31m-        $member_net=MemberNet::where(['net_member_id'=>$MemberCreditcard['card_member_id']])->find();[m
[31m-        #ç”¨æˆ·åŸºæœ¬ä¿¡æ¯[m
[31m-        $data['Members']=$Members=Members::haswhere('memberLogin','')->where(['member_id'=>$MemberCreditcard['card_member_id']])->find();[m
[31m-        #ç™»å½•ä¿¡æ¯[m
[31m-        // if(!$MemberCreditcard || !$passageway || $member_net){[m
[31m-        //  exit('è·å–ä¿¡æ¯å¤±è´¥');[m
[31m-        // }[m
[31m-        $this->assign('order_no',$order_no);[m
[31m-        $this->assign('passageway_id',$passageway_id);[m
[31m-        $this->assign('data',$data);[m
[31m-        return view("Userurl/signed");[m
[32m+[m[41m  [m		[32m#ä¿¡ç”¨å¡ä¿¡æ¯[m
[32m+[m[41m  [m		[32m$data['MemberCreditcard']=$MemberCreditcard=MemberCreditcard::where(['card_id'=>$cardId])->find();[m
[32m+[m[41m  [m		[32m#é€šé“ä¿¡æ¯[m
[32m+[m[41m  [m		[32m$data['passageway']=$passageway=Passageway::get($passageway_id);[m
[32m+[m[41m  [m		[32m#é€šé“å…¥ç½‘ä¿¡æ¯[m
[32m+[m[41m  [m		[32m$member_net=MemberNet::where(['net_member_id'=>$MemberCreditcard['card_member_id']])->find();[m
[32m+[m[41m  [m		[32m#ç”¨æˆ·åŸºæœ¬ä¿¡æ¯[m
[32m+[m[41m  [m		[32m$data['Members']=$Members=Members::haswhere('memberLogin','')->where(['member_id'=>$MemberCreditcard['card_member_id']])->find();[m
[32m+[m[41m  [m		[32m#ç™»å½•ä¿¡æ¯[m
[32m+[m[41m  [m		[32m// if(!$MemberCreditcard || !$passageway || $member_net){[m
[32m+[m[41m  [m		[32m// 	exit('è·å–ä¿¡æ¯å¤±è´¥');[m
[32m+[m[41m  [m		[32m// }[m
[32m+[m[41m  [m		[32m$this->assign('order_no',$order_no);[m
[32m+[m[41m  [m		[32m$this->assign('passageway_id',$passageway_id);[m
[32m+[m[41m  [m		[32m$this->assign('data',$data);[m
[32m+[m[41m  [m		[32mreturn view("Userurl/signed");[m
[32m+[m[32m  }[m
[32m+[m[32m  public function signed_huilian($passageway_id,$cardId,$order_no){[m
[32m+[m[32m      #ä¿¡ç”¨å¡ä¿¡æ¯[m
[32m+[m[32m      $data['MemberCreditcard']=$MemberCreditcard=MemberCreditcard::where(['card_id'=>$cardId])->find();[m
[32m+[m[32m      #é€šé“ä¿¡æ¯[m
[32m+[m[32m      $data['passageway']=$passageway=Passageway::get($passageway_id);[m
[32m+[m[32m      #é€šé“å…¥ç½‘ä¿¡æ¯[m
[32m+[m[32m      $member_net=MemberNet::where(['net_member_id'=>$MemberCreditcard['card_member_id']])->find();[m
[32m+[m[32m      #ç”¨æˆ·åŸºæœ¬ä¿¡æ¯[m
[32m+[m[32m      $data['Members']=$Members=Members::haswhere('memberLogin','')->where(['member_id'=>$MemberCreditcard['card_member_id']])->find();[m
[32m+[m[32m      $data['merId']=$data['Members']['memberNet'][$data['passageway']['passageway_no']];[m
[32m+[m[32m      var_dump($data['merId']);die;[m
[32m+[m[32m      #ç™»å½•ä¿¡æ¯[m
[32m+[m[32m      // if(!$MemberCreditcard || !$passageway || $member_net){[m
[32m+[m[32m      //  exit('è·å–ä¿¡æ¯å¤±è´¥');[m
[32m+[m[32m      // }[m
[32m+[m[32m      $this->assign('order_no',$order_no);[m
[32m+[m[32m      $this->assign('passageway_id',$passageway_id);[m
[32m+[m[32m      $this->assign('data',$data);[m
[32m+[m[32m      return view("Userurl/signed_huilian");[m
   }[m
   #é‡‘æ˜“ä»˜éªŒè¯ç é¡µé¢[m
   public function jinyifu($memberId,$passagewayId,$cardId,$price){[m
 [m
[31m-    if(request()->ispost()){[m
[31m-        // var_dump(Request::instance()->post('passagewayId'));die;[m
[31m-        $jinyifu=new \app\index\controller\CashOut(Request::instance()->post('memberId'),Request::instance()->post('passwayId'),Request::instance()->post('cardId'));[m
[31m-        $res=$jinyifu->jinyifu_pay(Request::instance()->post());[m
[32m+[m[41m  [m	[32mif(request()->ispost()){[m
[32m+[m[41m  [m		[32m// var_dump(Request::instance()->post('passagewayId'));die;[m
[32m+[m[41m  [m		[32m$jinyifu=new \app\index\controller\CashOut(Request::instance()->post('memberId'),Request::instance()->post('passwayId'),Request::instance()->post('cardId'));[m
[32m+[m[41m  [m		[32m$res=$jinyifu->jinyifu_pay(Request::instance()->post());[m
 [m
[31m-        return $res;[m
[31m-    }[m
[31m-    //$member=Members::with('memberCashcard,memberCreditcard')->where(['member_id'=>$memberId,'card_id'])->find();[m
[31m-    $info=Members::haswhere('memberCreditcard',['card_id'=>$cardId])->where(['member_id'=>$memberId])->find();[m
[31m-    // //var_dump($info::getLastSql());[m
[31m-    // dump($info->memberCreditcard->card_bankname);[m
[31m-    // dump($info->memberCashcard->card_bankname);[m
[31m-    // die;[m
[32m+[m[41m  [m		[32mreturn $res;[m
[32m+[m[41m  [m	[32m}[m
[32m+[m[41m  [m	[32m//$member=Members::with('memberCashcard,memberCreditcard')->where(['member_id'=>$memberId,'card_id'])->find();[m
[32m+[m[41m  [m	[32m$info=Members::haswhere('memberCreditcard',['card_id'=>$cardId])->where(['member_id'=>$memberId])->find();[m
[32m+[m[41m  [m	[32m// //var_dump($info::getLastSql());[m
[32m+[m[41m  [m	[32m// dump($info->memberCreditcard->card_bankname);[m
[32m+[m[41m  [m	[32m// dump($info->memberCashcard->card_bankname);[m
[32m+[m[41m  [m	[32m// die;[m
 [m
[31m-    $this->assign('info',$info);[m
[31m-    $this->assign('price',$price);[m
[31m-    $this->assign('passagewayId',$passagewayId);[m
[32m+[m[41m  [m	[32m$this->assign('info',$info);[m
[32m+[m[41m  [m	[32m$this->assign('price',$price);[m
[32m+[m[41m  [m	[32m$this->assign('passagewayId',$passagewayId);[m
 [m
[31m-    return view("Userurl/jinyifu");[m
[32m+[m[41m  [m	[32mreturn view("Userurl/jinyifu");[m
   }[m
 [m
   #é‡‘æ˜“ä»˜å‘é€éªŒè¯ç [m
   public function jinyifu_sms(){[m
[31m-    // var_dump(Request::instance()->param('phone'));die;[m
[31m-     #éªŒè¯æ‰‹æœº/å‘é€å¯¹è±¡æ˜¯å¦å­˜åœ¨[m
[31m-         if(!phone_check(Request::instance()->param('phone')))[m
[31m-             return ['code'=>401];[m
[32m+[m[41m  [m	[32m// var_dump(Request::instance()->param('phone'));die;[m
[32m+[m[41m  [m	[32m #éªŒè¯æ‰‹æœº/å‘é€å¯¹è±¡æ˜¯å¦å­˜åœ¨[m
[32m+[m[41m      [m	[32m if(!phone_check(Request::instance()->param('phone')))[m
[32m+[m[41m      [m	[41m [m	[32m return ['code'=>401];[m
            #éšæœºä¸€ä¸ªéªŒè¯ç [m
            $code=verify_code(System::getName('code_number'));[m
            // var_dump($code);die;[m
[36m@@ -1275,73 +1253,34 @@[m [mclass Userurl extends Controller[m
 [m
   #H5æœ‰ç§¯åˆ†å‰å°é€šçŸ¥åœ°å€[m
   public function H5youjifen($tradeNo){[m
[31m-[m
[31m-    //   echo "666";[m
[31m-    //   // echo str_pad("",4096);[m
[31m-    // {//æ–­å¼€è¿æ¥çš„ä»£ç     [m
[31m-    //     $size=ob_get_length();    [m
[31m-    //     header("Content-Length: $size");  //å‘Šè¯‰æµè§ˆå™¨æ•°æ®é•¿åº¦,æµè§ˆå™¨æ¥æ”¶åˆ°æ­¤é•¿åº¦æ•°æ®åå°±ä¸å†æ¥æ”¶æ•°æ®  [m
[31m-    //     header("Connection: Close");      //å‘Šè¯‰æµè§ˆå™¨å…³é—­å½“å‰è¿æ¥,å³ä¸ºçŸ­è¿æ¥  [m
[31m-    //     ob_flush();    [m
[31m-    //     flush();    [m
[31m-    // }    [m
[31m-      sleep(3);[m
[31m-      // var_dump(132);die;[m
[31m-    $order=CashOrder::get(['order_no'=>$tradeNo]);[m
[31m-    $passway=Passageway::get($order->order_passway);[m
[31m-    $member=Members::get($order->order_member);[m
[31m-[m
[31m-    #æŸ¥è¯¢è®¢å•æ˜¯å¦æˆåŠŸ[m
[31m-    $url="http://kjnq.jct8.com/quickpay/Query/".$passway->passageway_mech."/".$tradeNo;[m
[31m-    $curl = curl_init(); // å¯åŠ¨ä¸€ä¸ªCURLä¼šè¯[m
[31m-    curl_setopt($curl, CURLOPT_URL, $url);[m
[31m-    curl_setopt($curl, CURLOPT_HEADER, 0);[m
[31m-    curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);[m
[31m-    curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false); // è·³è¿‡è¯ä¹¦æ£€æŸ¥[m
[31m-    $data = curl_exec($curl);     //è¿”å›apiçš„jsonå¯¹è±¡[m
[31m-    //å…³é—­URLè¯·æ±‚[m
[31m-    curl_close($curl);[m
[31m-    $return=json_decode($data,true);[m
[31m-    // var_dump($return);die;[m
[31m-    if($return['code']=='00'){[m
[31m-      if(isset($return['payStatus']) && $return['payStatus']=='Y'){[m
[31m-         $passwayitem=PassagewayItem::get(['item_group'=>$member->member_group_id,'item_passageway'=>$passway->passageway_id]);[m
[31m-         $Commission_info=Commissions::where(['commission_from'=>$order->order_id,'commission_type'=>1])->find();[m
[31m-         if(!$Commission_info){[m
[31m-                $fenrun= new \app\api\controller\Commission();[m
[31m-                $fenrun_result=$fenrun->MemberFenRun($order->order_member,$order->order_money,$order->order_passway,1,'å¥—ç°æ‰‹ç»­è´¹åˆ†æ¶¦',$order->order_id);[m
[31m-         }else{[m
[31m-            $fenrun_result['code']=-1;[m
[31m-         }[m
[31m-         $order->order_state=2;[m
[31m-[m
[31m-      }else{[m
[31m-        $order->order_state=-1;[m
[31m-         $fenrun_result['code']=-1;[m
[31m-      }[m
[31m-[m
[31m-    }elseif($return['code']=='01'){[m
[31m-      $order->order_state=-1;[m
[31m-       $fenrun_result['code']=-1;[m
[31m-    }[m
[32m+[m[41m  [m	[32m$order=CashOrder::get(['order_no'=>$tradeNo]);[m
[32m+[m[41m  [m	[32m$passway=Passageway::get($order->order_passway);[m
[32m+[m[41m  [m	[32m$member=Member::get($order->order_member);[m
[32m+[m[41m  [m	[32m#é€šé“è´¹ç‡[m
[32m+[m[32m     $passwayitem=PassagewayItem::get(['item_group'=>$member->member_group_id,'item_passageway'=>$passway->passageway_id]);[m
[32m+[m[41m  [m	[32m $Commission_info=Commissions::where(['commission_from'=>$order->order_id,'commission_type'=>1])->find();[m
[32m+[m[32m     if(!$Commission_info){[m
[32m+[m[32m            $fenrun= new \app\api\controller\Commission();[m
[32m+[m[32m            $fenrun_result=$fenrun->MemberFenRun($order->order_member,$order->order_money,$order->order_passway,1,'å¥—ç°æ‰‹ç»­è´¹åˆ†æ¶¦',$order->order_id);[m
[32m+[m[32m     }else{[m
[32m+[m[32m        $fenrun_result['code']=-1;[m
[32m+[m[32m     }[m
 [m
      if($fenrun_result['code']=="200")[m
      {[m
[31m-         $order->order_fen=$fenrun_result['leftmoney'];[m
[32m+[m		[32m $order->order_fen=$fenrun_result['leftmoney'];[m
          $order->order_buckle=$passwayitem->item_charges/100;[m
          $order->order_platform=$order->order_charge-($order->order_money*$passway->passageway_rate/100)+$passwayitem->item_charges-$passway->passageway_income;[m
      }[m
[31m-        else    [m
[32m+[m		[32melse[m[41m	[m
      {[m
[31m-             $order->order_fen=-1;[m
[32m+[m			[32m $order->order_fen=-1;[m
      }[m
 [m
       $res = $order->save();[m
[31m-     if ($res) {[m
[31m-      $this->assign('data',$fenrun_result);[m
[31m-      $this->assign('url',$url);[m
[31m-        return view("Userurl/H5youjifen");[m
[31m-     }[m
[32m+[m	[32m if ($res) {[m
[32m+[m	[41m [m	[32mreturn view("Userurl/H5youjifen");[m
[32m+[m	[32m }[m
   }[m
 [m
   public function parents($phone){[m
[36m@@ -1382,48 +1321,4 @@[m [mclass Userurl extends Controller[m
     $this->assign("list",$list);[m
     return view("Userurl/credit_card");[m
   }[m
[31m-[m
[31m-[m
[31m-    public function get_team($id){[m
[31m-      $parent=$this->get($id);[m
[31m-        // è¾“å‡ºExcelæ–‡ä»¶å¤´ï¼Œå¯æŠŠuser.csvæ¢æˆä½ è¦çš„æ–‡ä»¶å  [m
[31m-  header('Content-Type: application/vnd.ms-excel');  [m
[31m-  header('Content-Disposition: attachment;filename="user.csv"');  [m
[31m-  header('Cache-Control: max-age=0');     [m
[31m-  // ä»æ•°æ®åº“ä¸­è·å–æ•°æ®ï¼Œä¸ºäº†èŠ‚çœå†…å­˜ï¼Œä¸è¦æŠŠæ•°æ®ä¸€æ¬¡æ€§è¯»åˆ°å†…å­˜ï¼Œä»å¥æŸ„ä¸­ä¸€è¡Œä¸€è¡Œè¯»å³å¯      [m
[31m-  // æ‰“å¼€PHPæ–‡ä»¶å¥æŸ„ï¼Œphp://output è¡¨ç¤ºç›´æ¥è¾“å‡ºåˆ°æµè§ˆå™¨  [m
[31m- $fp = fopen('php://output', 'a');    [m
[31m- // è¾“å‡ºExcelåˆ—åä¿¡æ¯  [m
[31m- $head = array('å§“å');  [m
[31m- // foreach ($head as $i => $v) {  [m
[31m-     // CSVçš„Excelæ”¯æŒGBKç¼–ç ï¼Œä¸€å®šè¦è½¬æ¢ï¼Œå¦åˆ™ä¹±ç   [m
[31m-     $head[0] = iconv('utf-8', 'gbk', $head[0]);  [m
[31m- // }    [m
[31m- // å°†æ•°æ®é€šè¿‡fputcsvå†™åˆ°æ–‡ä»¶å¥æŸ„  [m
[31m- fputcsv($fp, $head);   [m
[31m- // è®¡æ•°å™¨   [m
[31m- // æ¯éš”$limitè¡Œï¼Œåˆ·æ–°ä¸€ä¸‹è¾“å‡ºbufferï¼Œä¸è¦å¤ªå¤§ï¼Œä¹Ÿä¸è¦å¤ªå°  [m
[31m-   [m
[31m- // é€è¡Œå–å‡ºæ•°æ®ï¼Œä¸æµªè´¹å†…å­˜  [m
[31m- foreach ($parent as $key => $value) {[m
[31m-         ob_flush();  [m
[31m-         flush();  [m
[31m-         $row[0] = iconv('utf-8', 'gbk', $value['member_nick']);  [m
[31m-     fputcsv($fp, $row);  [m
[31m- }[m
[31m-[m
[31m-      [m
[31m-    }[m
[31m-    public function get($id){[m
[31m-        $parent=MemberRelation::with('member')->where(['relation_parent_id'=>$id])->select();[m
[31m-        $data=[];[m
[31m-        foreach ($parent as $key => $value) {[m
[31m-            $re=$this->get($value['relation_member_id']);[m
[31m-[m
[31m-              $data=array_merge($data,$re);[m
[31m-[m
[31m-        }[m
[31m-              $data=array_merge($data,$parent);[m
[31m-        return $data;[m
[31m-      }[m
 }[m
\ No newline at end of file[m
