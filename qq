[1mdiff --git a/application/api/controller/Userurl.php b/application/api/controller/Userurl.php[m
[1mindex a68e3a8..f0baa71 100755[m
[1m--- a/application/api/controller/Userurl.php[m
[1m+++ b/application/api/controller/Userurl.php[m
[36m@@ -35,7 +35,6 @@[m [muse app\index\model\MemberCert;[m
 use app\index\model\MemberNet;[m
 use app\index\model\Reimbur;[m
 use app\index\model\Appversion; [m
[31m-use app\index\model\Commission as Commissions; [m
 use app\index\model\SmsCode; [m
 use app\index\model\ArticleCategory;[m
 use app\index\model\Article;[m
[36m@@ -55,39 +54,40 @@[m [mclass Userurl extends Controller[m
        $this->param=request()->param();[m
         try{[m
              if(!isset($this->param['uid']) || empty($this->param['uid']) || !isset($this->param['token']) ||empty($this->param['token'])){[m
[31m-                echo '<li style="margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;">当前登录已过期，请重新登录</li>';die;[m
[32m+[m[41m             [m	[32mecho '<li style="margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;">当前登录已过期，请重新登录</li>';die;[m
              }[m
[31m-                 [m
[32m+[m[41m             	 [m
                    // $this->error=314;[m
              #查找到当前用户[m
              $member=Members::haswhere('memberLogin',['login_token'=>$this->param['token']])->where('member_id', $this->param['uid'])->find();[m
              if(!$member && !$this->error){[m
[31m-                echo '<li style="margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;">当前登录已过期，请重新登录</li>';die;[m
[32m+[m[41m             [m	[32mecho '<li style="margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;">当前登录已过期，请重新登录</li>';die;[m
              }[m
         }catch (\Exception $e) {[m
[31m-            echo '<li style="margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;">当前登录已过期，请重新登录</li>';die;[m
[31m-              $this->assign('msg','当前登录已过期，请重新登录');[m
[32m+[m[41m        [m	[32mecho '<li style="margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;">当前登录已过期，请重新登录</li>';die;[m
[32m+[m[41m        [m	[32m  $this->assign('msg','当前登录已过期，请重新登录');[m
              // $this->error=317;[m
         }[m
         if($this->error){[m
[31m-            $msg=Config::get('response.'.$this->error) ? Config::get('response.'.$this->error) : "系统错误~";[m
[31m-                echo "<li style='margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;'>{$msg}}</li>";die;[m
[32m+[m			[32m$msg=Config::get('response.'.$this->error) ? Config::get('response.'.$this->error) : "系统错误~";[m
[32m+[m				[32mecho "<li style='margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;'>{$msg}}</li>";die;[m
             // exit(json_encode(['code'=>$this->error, 'msg'=>$msg, 'data'=>[]]));[m
         }[m
[31m-        $this->assign('uid',$this->param['uid']);[m
[31m-        $this->assign('token',$this->param['token']);[m
[32m+[m		[32m$this->assign('uid',$this->param['uid']);[m
[32m+[m		[32m$this->assign('token',$this->param['token']);[m
       }[m
 [m
       #专属二维码列表[m
[31m-    public function exclusive_code(){[m
[31m-        $this->assign("name",System::getName("sitename"));[m
[31m-        $list = Exclusive::all();[m
[31m-        $this->assign("list",$list);[m
[31m-        return view("api/logic/share_code_list");[m
[31m-    }[m
[31m-    #取现现成功页面[m
[31m-    public function calllback_success(){[m
[31m-        // $request = $this->param;[m
[32m+[m	[32mpublic function exclusive_code(){[m
[32m+[m		[32m$this->assign("name",System::getName("sitename"));[m
[32m+[m	[32m    $list = Exclusive::all();[m
[32m+[m	[32m    $this->assign("list",$list);[m
[32m+[m	[32m    return view("api/logic/share_code_list");[m
[32m+[m	[32m}[m
[32m+[m
[32m+[m	[32m#取现现成功页面[m
[32m+[m	[32mpublic function calllback_success(){[m
[32m+[m		[32m// $request = $this->param;[m
     $request=file_get_contents("php://input");[m
     if(empty($request)){[m
        $data['result'] = -1;[m
[36m@@ -106,191 +106,188 @@[m [mclass Userurl extends Controller[m
         }[m
 [m
       $this->assign('data',$data);[m
[31m-        return view("Userurl/calllback_success");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:01:55+0800[m
[31m-     * @version  [专属二维码][m
[31m-     * @return   [type][m
[31m-     */[m
[31m-    public function exclusive_code_detail(){[m
[31m-        $this->checkToken();[m
[31m-        //获取当前手机号[m
[31m-        $tel=Members::get($this->param['uid']);[m
[31m-        $tel=$tel->member_mobile;[m
[31m-        //推广连接[m
[31m-        $url='http://'.$_SERVER['HTTP_HOST'].'/api/userurl/register/recomment/'.$tel;[m
[31m-        //背景图片ID[m
[31m-        $exclusive_id=$this->param['exclusive_id'];[m
[31m-        //调取数据库url[m
[31m-        $img=db('qrcode')->where(['qrcode_member_id'=>$this->param['uid'],'qrcode_exclusive_id'=>$exclusive_id])->find();[m
[31m-            // dump($img);die;[m
[31m-        if(!$img || !$img['qrcode_url']){[m
[31m-            $imgurl='autoimg/qrcode_'.$exclusive_id.'_'.$tel.'.png';[m
[31m-            //若未生成过[m
[31m-            if(!is_file($imgurl)){[m
[31m-                Vendor('phpqrcode.phpqrcode');[m
[31m-                $QRcode=new \QRcode();[m
[31m-                //生成二维码[m
[31m-                $QRcode->png($url, 'autoimg/qrcode'.$tel.'.png','H',8,5);[m
[31m-                $qrurl=ROOT_PATH.'public/autoimg/qrcode'.$tel.'.png';[m
[31m-                $logourl=ROOT_PATH.'public/static/images/logo.png';[m
[31m-                // 二维码加入logo[m
[31m-                 $QR = imagecreatefromstring(file_get_contents($qrurl)); [m
[31m-                 $logo = imagecreatefromstring(file_get_contents($logourl)); [m
[31m-                 $logo_width = imagesx($logo);[m
[31m-                 $logo_height = imagesy($logo);[m
[31m-                 #动态计算取中心点 让你丫不居中[m
[31m-                 $qr_width = imagesx($QR);[m
[31m-                 $scale=0.18;[m
[31m-                 $logo_line=$scale*$qr_width;[m
[31m-                 $xy=$qr_width*0.5-$logo_line*0.5;[m
[31m-                 imagecopyresampled( $QR,$logo, $xy, $xy, 0, 0, $logo_line, $logo_line, $logo_width, $logo_height); [m
[31m-                imagepng($QR, 'autoimg/qrcode'.$tel.'.png'); [m
[31m-                // 背景[m
[31m-                $bg_url=Exclusive::get($exclusive_id);[m
[31m-                $bg_url=$bg_url->exclusive_thumb;[m
[31m-                $bg_url=preg_replace('/\\\\/', '/', $bg_url);[m
[31m-                $bg_url=ROOT_PATH.'public'.$bg_url;[m
[31m-                // $bg=ROOT_PATH.'public\static\images\exclusice_code_bg.png';[m
[31m-                //合成专属二维码[m
[31m-                 $bg = imagecreatefromstring(file_get_contents($bg_url)); [m
[31m-                 $QR_width = imagesx($QR);//二维码图片宽度 [m
[31m-                 $QR_height = imagesy($QR);//二维码图片高度 [m
[31m-                 imagecopyresampled( $bg,$QR, 240, 710, 0, 0, 280, 280, $QR_width, $QR_height); [m
[31m-                imagejpeg($bg, $imgurl,65); [m
[31m-            }[m
[31m-            if(!$img){[m
[31m-                db('qrcode')->insert(['qrcode_member_id'=>$this->param['uid'],'qrcode_exclusive_id'=>$exclusive_id,'qrcode_url'=>$imgurl]);[m
[31m-            }else{[m
[31m-                db('qrcode')->where(['qrcode_member_id'=>$this->param['uid'],'qrcode_exclusive_id'=>$exclusive_id])->update(['qrcode_url'=>$imgurl]);[m
[31m-            }[m
[31m-        }else{[m
[31m-            $imgurl=$img['qrcode_url'];[m
[31m-        }[m
[31m-        //返回图片地址[m
[31m-        $url='http://'.$_SERVER['HTTP_HOST'].'/'.$imgurl;[m
[31m-        $this->assign('url',$url);[m
[31m-        return view("Userurl/exclusive_code_detail");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [用户还款计划][m
[31m-     * @return   [type][m
[31m-     */[m
[32m+[m	[32m    return view("Userurl/calllback_success");[m
[32m+[m	[32m}[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:01:55+0800[m
[32m+[m	[32m * @version  [专属二维码][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m	[32mpublic function exclusive_code_detail(){[m
[32m+[m		[32m$this->checkToken();[m
[32m+[m		[32m//获取当前手机号[m
[32m+[m		[32m$tel=Members::get($this->param['uid']);[m
[32m+[m		[32m$tel=$tel->member_mobile;[m
[32m+[m		[32m//推广连接[m
[32m+[m		[32m$url='http://'.$_SERVER['HTTP_HOST'].'/api/userurl/register/recomment/'.$tel;[m
[32m+[m		[32m//背景图片ID[m
[32m+[m		[32m$exclusive_id=$this->param['exclusive_id'];[m
[32m+[m		[32m//调取数据库url[m
[32m+[m		[32m$img=db('qrcode')->where(['qrcode_member_id'=>$this->param['uid'],'qrcode_exclusive_id'=>$exclusive_id])->find();[m
[32m+[m			[32m// dump($img);die;[m
[32m+[m		[32mif(!$img || !$img['qrcode_url']){[m
[32m+[m			[32m$imgurl='autoimg/qrcode_'.$exclusive_id.'_'.$tel.'.png';[m
[32m+[m			[32m//若未生成过[m
[32m+[m			[32mif(!is_file($imgurl)){[m
[32m+[m				[32mVendor('phpqrcode.phpqrcode');[m
[32m+[m				[32m$QRcode=new \QRcode();[m
[32m+[m				[32m//生成二维码[m
[32m+[m				[32m$QRcode->png($url, 'autoimg/qrcode'.$tel.'.png','H',8,5);[m
[32m+[m				[32m$qrurl=ROOT_PATH.'public/autoimg/qrcode'.$tel.'.png';[m
[32m+[m				[32m$logourl=ROOT_PATH.'public/static/images/logo.png';[m
[32m+[m				[32m// 二维码加入logo[m
[32m+[m				[32m $QR = imagecreatefromstring(file_get_contents($qrurl));[m[41m [m
[32m+[m				[32m $logo = imagecreatefromstring(file_get_contents($logourl));[m[41m [m
[32m+[m				[32m $logo_width = imagesx($logo);[m
[32m+[m				[32m $logo_height = imagesy($logo);[m
[32m+[m				[32m #动态计算取中心点 让你丫不居中[m
[32m+[m				[32m $qr_width = imagesx($QR);[m
[32m+[m				[32m $scale=0.18;[m
[32m+[m				[32m $logo_line=$scale*$qr_width;[m
[32m+[m				[32m $xy=$qr_width*0.5-$logo_line*0.5;[m
[32m+[m				[32m imagecopyresampled( $QR,$logo, $xy, $xy, 0, 0, $logo_line, $logo_line, $logo_width, $logo_height);[m[41m [m
[32m+[m				[32mimagepng($QR, 'autoimg/qrcode'.$tel.'.png');[m[41m [m
[32m+[m				[32m// 背景[m
[32m+[m				[32m$bg_url=Exclusive::get($exclusive_id);[m
[32m+[m				[32m$bg_url=$bg_url->exclusive_thumb;[m
[32m+[m				[32m$bg_url=preg_replace('/\\\\/', '/', $bg_url);[m
[32m+[m				[32m$bg_url=ROOT_PATH.'public'.$bg_url;[m
[32m+[m				[32m// $bg=ROOT_PATH.'public\static\images\exclusice_code_bg.png';[m
[32m+[m				[32m//合成专属二维码[m
[32m+[m				[32m $bg = imagecreatefromstring(file_get_contents($bg_url));[m[41m [m
[32m+[m				[32m $QR_width = imagesx($QR);//二维码图片宽度[m[41m [m
[32m+[m				[32m $QR_height = imagesy($QR);//二维码图片高度[m[41m [m
[32m+[m				[32m imagecopyresampled( $bg,$QR, 240, 710, 0, 0, 280, 280, $QR_width, $QR_height);[m[41m [m
[32m+[m				[32mimagejpeg($bg, $imgurl,65);[m[41m [m
[32m+[m			[32m}[m
[32m+[m			[32mif(!$img){[m
[32m+[m				[32mdb('qrcode')->insert(['qrcode_member_id'=>$this->param['uid'],'qrcode_exclusive_id'=>$exclusive_id,'qrcode_url'=>$imgurl]);[m
[32m+[m			[32m}else{[m
[32m+[m				[32mdb('qrcode')->where(['qrcode_member_id'=>$this->param['uid'],'qrcode_exclusive_id'=>$exclusive_id])->update(['qrcode_url'=>$imgurl]);[m
[32m+[m			[32m}[m
[32m+[m		[32m}else{[m
[32m+[m			[32m$imgurl=$img['qrcode_url'];[m
[32m+[m		[32m}[m
[32m+[m		[32m//返回图片地址[m
[32m+[m		[32m$url='http://'.$_SERVER['HTTP_HOST'].'/'.$imgurl;[m
[32m+[m		[32m$this->assign('url',$url);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/exclusive_code_detail");[m
[32m+[m	[32m}[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [用户还款计划][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
 [m
[31m-    public function repayment_plan_list(){[m
[31m-        $this->checkToken();[m
[31m-        #全部[m
[31m-        $order=GenerationOrder::where(['order_member'=>$this->param['uid']])->select();[m
[32m+[m	[32mpublic function repayment_plan_list(){[m
[32m+[m		[32m$this->checkToken();[m
[32m+[m		[32m#全部[m
[32m+[m		[32m$order=GenerationOrder::where(['order_member'=>$this->param['uid']])->select();[m
 [m
[31m-        #已执行[m
[31m-        $order2=GenerationOrder::where(['order_member'=>$this->param['uid'],'order_status'=>2])->select();[m
[32m+[m		[32m#已执行[m
[32m+[m		[32m$order2=GenerationOrder::where(['order_member'=>$this->param['uid'],'order_status'=>2])->select();[m
 [m
[31m-        #未执行[m
[31m-        $order1=GenerationOrder::where(['order_member'=>$this->param['uid'],'order_status'=>1])->select();[m
[31m-        [m
[31m-        $this->assign('order',$order);[m
[31m-        $this->assign('order2',$order2);[m
[31m-        $this->assign('order1',$order1);[m
[31m-        return view("Userurl/repayment_plan_list");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [还款计划已完成列表][m
[31m-     * @return   [type][m
[31m-     */[m
[31m-    public function repayment_history(){[m
[31m-        $this->checkToken();[m
[31m-        #进行中[m
[31m-        // $this->param['uid']=16;[m
[31m-        $generation=Generation::with('creditcard')->where(['generation_member'=>$this->param['uid'],'generation_state'=>2])->order('generation_add_time','desc')->select();[m
[31m-        foreach ($generation as $key => $value) {[m
[31m-            //判断自动执行表 是否全部完成执行 取未执行的计划[m
[31m-            $haventDone=GenerationOrder::where(['order_no'=>$value['generation_id'],'order_status'=>1])->find();[m
[31m-            if(!$haventDone){[m
[31m-                //若全部完成执行 更改主表计划执行状态[m
[31m-                Generation::where(['generation_member'=>$this->param['uid'],'generation_id'=>$value['generation_id']])->update(['generation_state'=>3]);[m
[31m-                unset($generation['$key']);[m
[31m-                continue;[m
[31m-            }else{[m
[31m-                $generation[$key]['generation_card']=substr($value['generation_card'], -4);[m
[31m-                $generation[$key]['count']=GenerationOrder::where(['order_no'=>$value['generation_id']])->count();[m
[31m-            }[m
[31m-        }[m
[32m+[m		[32m#未执行[m
[32m+[m		[32m$order1=GenerationOrder::where(['order_member'=>$this->param['uid'],'order_status'=>1])->select();[m
[32m+[m[41m		[m
[32m+[m		[32m$this->assign('order',$order);[m
[32m+[m		[32m$this->assign('order2',$order2);[m
[32m+[m		[32m$this->assign('order1',$order1);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/repayment_plan_list");[m
[32m+[m	[32m}[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [还款计划已完成列表][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m	[32mpublic function repayment_history(){[m
[32m+[m		[32m$this->checkToken();[m
[32m+[m		[32m#进行中[m
[32m+[m		[32m// $this->param['uid']=16;[m
[32m+[m		[32m$generation=Generation::with('creditcard')->where(['generation_member'=>$this->param['uid'],'generation_state'=>2])->order('generation_add_time','desc')->select();[m
[32m+[m		[32mforeach ($generation as $key => $value) {[m
[32m+[m			[32m//判断自动执行表 是否全部完成执行 取未执行的计划[m
[32m+[m			[32m$haventDone=GenerationOrder::where(['order_no'=>$value['generation_id'],'order_status'=>1])->find();[m
[32m+[m			[32mif(!$haventDone){[m
[32m+[m				[32m//若全部完成执行 更改主表计划执行状态[m
[32m+[m				[32mGeneration::where(['generation_member'=>$this->param['uid'],'generation_id'=>$value['generation_id']])->update(['generation_state'=>3]);[m
[32m+[m				[32munset($generation['$key']);[m
[32m+[m				[32mcontinue;[m
[32m+[m			[32m}else{[m
[32m+[m				[32m$generation[$key]['generation_card']=substr($value['generation_card'], -4);[m
[32m+[m				[32m$generation[$key]['count']=GenerationOrder::where(['order_no'=>$value['generation_id']])->count();[m
[32m+[m			[32m}[m
[32m+[m		[32m}[m
 [m
[31m-        #待确认 不需要了[m
[31m-        // $generation1=Generation::with('creditcard')->where(['generation_member'=>$this->param['uid'],'generation_state'=>1])->select();[m
[31m-        // foreach ($generation1 as $key => $value) {[m
[31m-        //      $generation1[$key]['generation_card']=substr($value['generation_card'], -4);[m
[31m-        //      $generation1[$key]['count']=GenerationOrder::where(['order_no'=>$value['generation_id']])->count();[m
[31m-        // }[m
[32m+[m		[32m#待确认 不需要了[m
[32m+[m		[32m// $generation1=Generation::with('creditcard')->where(['generation_member'=>$this->param['uid'],'generation_state'=>1])->select();[m
[32m+[m		[32m// foreach ($generation1 as $key => $value) {[m
[32m+[m		[32m// 		$generation1[$key]['generation_card']=substr($value['generation_card'], -4);[m
[32m+[m		[32m// 		$generation1[$key]['count']=GenerationOrder::where(['order_no'=>$value['generation_id']])->count();[m
[32m+[m		[32m// }[m
 [m
[31m-        #完成[m
[31m-        $generation3=Generation::with('creditcard')->where(['generation_member'=>$this->param['uid'],'generation_state'=>['in','3,4']])->order('generation_add_time','desc')->select();[m
[31m-        foreach ($generation3 as $key => $value) {[m
[31m-                $generation3[$key]['generation_card']=substr($value['generation_card'], -4);[m
[31m-                $generation3[$key]['count']=GenerationOrder::where(['order_no'=>$value['generation_id']])->count();[m
[31m-        }[m
[31m-        // var_dump($generation);die;[m
[31m-        $this->assign('generation',$generation);[m
[31m-        $this->assign('generation3',$generation3);[m
[31m-        return view("Userurl/repayment_history");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [还款计划创建 #1][m
[31m-     * @version  [还款计划创建下一步后显示的详情页][m
[31m-     * @return   [type][m
[31m-     */[m
[31m-    public function repayment_plan_create_detail(){[m
[31m-        // $this->checkToken();[m
[31m-        // $order_no=$this->param['order_no'];[m
[31m-        $order_no=input('order_no');[m
[31m-        $data=explode('_', $order_no);[m
[31m-        // print_r($data);die;[m
[31m-        $this->param['uid']=$param['uid']=$data[0];[m
[32m+[m		[32m#完成[m
[32m+[m		[32m$generation3=Generation::with('creditcard')->where(['generation_member'=>$this->param['uid'],'generation_state'=>['in','3,4']])->order('generation_add_time','desc')->select();[m
[32m+[m		[32mforeach ($generation3 as $key => $value) {[m
[32m+[m				[32m$generation3[$key]['generation_card']=substr($value['generation_card'], -4);[m
[32m+[m				[32m$generation3[$key]['count']=GenerationOrder::where(['order_no'=>$value['generation_id']])->count();[m
[32m+[m		[32m}[m
[32m+[m		[32m// var_dump($generation);die;[m
[32m+[m
[32m+[m		[32m$this->assign('generation',$generation);[m
[32m+[m		[32m$this->assign('generation3',$generation3);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/repayment_history");[m
[32m+[m	[32m}[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [还款计划创建 #1][m
[32m+[m	[32m * @version  [还款计划创建下一步后显示的详情页][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m
[32m+[m	[32mpublic function repayment_plan_create_detail(){[m
[32m+[m[32m    // order_no=42_63_300_1_2018-02-28-15:00:00_2018-02-29-15:00:00_21[m
[32m+[m		[32m// $this->checkToken();[m
[32m+[m		[32m// $order_no=$this->param['order_no'];[m
[32m+[m		[32m$order_no=input('order_no');[m
[32m+[m		[32m$data=explode('_', $order_no);[m
[32m+[m		[32m// print_r($data);die;[m
[32m+[m		[32m$this->param['uid']=$param['uid']=$data[0];[m
         $this->param['cardId']=$param['cardId']=$data[1];[m
         $this->param['billMoney']=$param['billMoney']=$data[2];[m
         $this->param['payCount']=$param['payCount']=$data[3];[m
         $this->param['startDate']=$param['startDate']=$data[4];[m
         $this->param['endDate']=$param['endDate']=$data[5];[m
         $this->param['passageway']=$param['passageway']=$data[6];[m
[31m-        #1判断当前通道当前卡用户有没有入网和签约[m
[32m+[m		[32m   #1判断当前通道当前卡用户有没有入网和签约[m
         // 获取通道信息[m
        $passageway=Passageway::get($param['passageway']);[m
        $members=Members::haswhere('memberLogin','')->where(['member_id'=>$param['uid']])->find();[m
        if(!$passageway || !$members){[m
[31m-            $this->assign('data','获取数据失败，请重试。');[m
[31m-            return view("Userurl/show_error");[m
[32m+[m[41m       [m		[32m$this->assign('data','获取数据失败，请重试。');[m
[32m+[m[41m       [m		[32mreturn view("Userurl/show_error");[m
        }[m
[31m-       $passageway_rate=$passageway->passageway_rate;[m
[31m-       $passageway_income=$passageway->passageway_income;[m
[31m-       // var_dump($passageway->toArray());die;[m
[31m-       //判断是否签约[m
        $MemberCreditcard=MemberCreditcard::where(['card_id'=>$param['cardId']])->find();[m
        //判断哪个通道[m
        if($passageway['passageway_method']=='income'){  //暂时这么判断是汇联金创还是米刷[m
[31m-            if(!$MemberCreditcard['huilian_income']){[m
[32m+[m
[32m+[m[32m            $member_net=MemberNet::where(['net_member_id'=>$param['uid']])->find();[m
[32m+[m[32m            if(!$member_net[$passageway->passageway_no]){ //没有入网[m
[32m+[m[32m               // 重定向到签约页面[m
                 $huilian=new Huilianjinchuang();[m
                 $res=$huilian->income($this->param['passageway'],$this->param['cardId']);[m
[31m-                // var_dump($res);die;[m
[31m-                if($res['code']=="10000" && $res['respCode']==10000){[m
[31m-                    $merId=$res['merId'];[m
[31m-                    $update=MemberCreditcard::where(['card_id'=>$param['cardId']])->update(['huilian_income'=>$merId]);[m
[31m-                    if(!$update){[m
[31m-                        $this->assign('data',"商户入网失败，{$res['respMessage']}请重试。");[m
[31m-                        return view("Userurl/show_error");[m
[31m-                    }[m
[31m-                }else{[m
[31m-                      $this->assign('data',"商户入网失败，{$res['respMessage']}请重试。");[m
[31m-                      return view("Userurl/show_error");[m
[32m+[m[32m                if(!$res){[m
[32m+[m[32m                    $this->assign('data','商户入网失败，请重试。');[m
[32m+[m[32m                    return view("Userurl/show_error");die;[m
                 }[m
             }[m
[32m+[m[32m            if(!$MemberCreditcard['huilian_income']){[m
[32m+[m[32m                return redirect('Userurl/signed_huilian', ['passageway_id' =>$param['passageway'],'cardId'=>$param['cardId'],'order_no'=>$order_no]);[m
[32m+[m[32m            }[m
        }else{[m
            // 判断是否入网[m
            $member_net=MemberNet::where(['net_member_id'=>$param['uid']])->find();[m
[36m@@ -310,7 +307,7 @@[m [mclass Userurl extends Controller[m
           $card_info=MemberCreditcard::where('card_id='.$this->param['cardId'])->find();[m
           if(!$card_info){[m
               $this->assign('data','获取数据失败，请重试。');[m
[31m-              return view("Userurl/show_error");[m
[32m+[m[41m       [m		[32m  return view("Userurl/show_error");[m
           }[m
           #获取后台费率[m
           $member_group_id=Members::where(['member_id'=>$this->param['uid']])->value('member_group_id');[m
[36m@@ -319,14 +316,11 @@[m [mclass Userurl extends Controller[m
            $also=($rate->item_also)/100;[m
            #定义代扣费[m
            $daikou=($rate->item_charges)/100;[m
[31m-           #获取代付费率[m
[31m-           $item_qfalso=($rate->item_qfalso)/100;[m
[31m-           #获取代付定额[m
[31m-           $item_qffix=($rate->item_qffix)/100;[m
           //如果还款次数小于天数[m
           $days=days_between_dates($this->param['startDate'],$this->param['endDate'])+1;[m
           $date=prDates($this->param['startDate'],$this->param['endDate']);[m
           if($this->param['payCount']<$days){[m
[32m+[m[32m               shuffle($date);[m
                 #消费几次就取几个随机日期[m
                $date=array_slice($date,0,$this->param['payCount']);[m
                $days=$this->param['payCount'];[m
[36m@@ -348,7 +342,7 @@[m [mclass Userurl extends Controller[m
           if($Generation_result->save()==false){[m
               Db::rollback();[m
                 $this->assign('data','生成计划失败，请重试');[m
[31m-                return view("Userurl/show_error");[m
[32m+[m[41m       [m			[32mreturn view("Userurl/show_error");[m
           }[m
           //写入还款卡表[m
            $reimbur_result=new Reimbur([[m
[36m@@ -358,12 +352,11 @@[m [mclass Userurl extends Controller[m
            if(!$reimbur_result->save()){[m
                 Db::rollback();[m
                 $this->assign('data','生成计划失败，请重试');[m
[31m-                return view("Userurl/show_error");[m
[32m+[m[41m       [m			[32mreturn view("Userurl/show_error");[m
            }[m
           ####################################[m
[31m-          #3确定每天实际还款金额[m
[31m-          $day_pay_real_money=$this->get_random_money($days,$this->param['billMoney'],$is_int=1);[m
[31m-          // print_r($day_pay_real_money);[m
[32m+[m[32m          #3确定每天还款金额[m
[32m+[m[32m          $day_pay_money=$this->get_random_money($days,$this->param['billMoney'],$is_int=1);[m
           #4确定每天还款次数[m
           $day_pay_count=$this->get_day_count($this->param['payCount'],$days);[m
           #5计算出每天实际刷卡金额，和实际到账金额[m
[36m@@ -373,9 +366,6 @@[m [mclass Userurl extends Controller[m
               $day_real_get_money=0;[m
               //刷卡信息[m
               #计算每次需要刷卡的理论金额[m
[31m-              #还款也有手续费，计算出每次需要还款金额,$passageway->passageway_qf_rate,$passageway->passageway_qf_rate[m
[31m-              $day_pay_money[$i]=$this->get_need_pay($item_qfalso,$item_qffix,$day_pay_real_money[$i]);[m
[31m-              // print_r($day_pay_money[$i]);die;[m
               $each_pay_money=$this->get_random_money($day_pay_count[$i],$day_pay_money[$i],$is_int=1);[m
               #计算每次刷卡的时间[m
               $each_pay_time=$this->get_random_time($date[$i],$day_pay_count[$i]);[m
[36m@@ -384,7 +374,7 @@[m [mclass Userurl extends Controller[m
                   //获取每次实际需要支付金额[m
                   $real_each_pay_money=$this->get_need_pay($also,$daikou,$each_money);[m
                   //获取每次实际到账金额[m
[31m-                  $real_each_get=$this->get_real_money($also,$daikou,$real_each_pay_money,$passageway_rate,$passageway_income);[m
[32m+[m[32m                  $real_each_get=$this->get_real_money($also,$daikou,$real_each_pay_money);[m
 [m
                   $plan[$i]['pay'][$k]=$Generation_order_insert[]=array([m
                       'order_no'       =>$Generation_result->generation_id,[m
[36m@@ -393,13 +383,7 @@[m [mclass Userurl extends Controller[m
                       'order_card'     =>$card_info->card_bankno,[m
                       'order_money'    =>$real_each_pay_money,[m
                       'order_pound'    =>$real_each_get['fee'],[m
[31m-                      'order_real_get' =>$real_each_get['money'],[m
[31m-                      'order_platform_fee'=>$real_each_get['plantform_fee'],[m
[31m-                      'order_passageway_fee'=>$real_each_get['passageway_fee'],[m
[31m-                      'passageway_rate'=>$passageway_rate,[m
[31m-                      'passageway_fix'=>$passageway_income,[m
[31m-                      'user_fix'=>$daikou,[m
[31m-                      'user_rate'=>$also*100,[m
[32m+[m[32m                      // 'real_each_get'  =>$real_each_get['money'],[m
                       'order_desc'     =>'自动代还消费~',[m
                       'order_time'     =>$each_pay_time[$k],[m
                       'order_passageway'=>$this->param['passageway'],[m
[36m@@ -410,9 +394,6 @@[m [mclass Userurl extends Controller[m
                   $generation_pound += $real_each_get['fee'];[m
                 $day_real_get_money+=$real_each_get['money'];[m
               }[m
[31m-              //获取代还每次实际到账金额[m
[31m-              $real_qf_get=$this->get_real_money($item_qfalso,$item_qffix,$day_real_get_money,$passageway->passageway_qf_rate,$passageway->passageway_qf_fix);[m
[31m-              // print_r($real_qf_get);die;[m
               //提现信息[m
               $plan[$i]['cash']=$Generation_order_insert[]=array([m
                   'order_no'         =>$Generation_result->generation_id,[m
[36m@@ -420,15 +401,7 @@[m [mclass Userurl extends Controller[m
                   'order_type'       =>2,[m
                   'order_card'       =>$card_info->card_bankno,[m
                   'order_money'      =>$day_real_get_money,//每天实际打回的金额[m
[31m-                  'order_pound'      =>$real_qf_get['fee'],[m
[31m-[m
[31m-                  'order_real_get' =>$real_qf_get['money'],[m
[31m-                  'order_platform_fee'=>$real_qf_get['plantform_fee'],[m
[31m-                  'order_passageway_fee'=>$real_qf_get['passageway_fee'],[m
[31m-                  'passageway_rate'=>$passageway->passageway_qf_rate,[m
[31m-                  'passageway_fix'=> $passageway->passageway_qf_fix,[m
[31m-                  'user_fix'=>$item_qffix,[m
[31m-                  'user_rate'=>$item_qfalso*100,[m
[32m+[m[32m                  'order_pound'      =>0,[m
                   'order_desc'       =>'自动代还还款~',[m
                   'order_time'       =>$date[$i]." ".get_hours(15,16).":".get_minites(0,59),[m
                   'order_passageway'=>$this->param['passageway'],[m
[36m@@ -452,146 +425,146 @@[m [mclass Userurl extends Controller[m
          }else{[m
                Db::rollback();[m
                $this->assign('data','生成计划失败，请重试');[m
[31m-               return view("Userurl/show_error");[m
[32m+[m[41m       [m		[32m   return view("Userurl/show_error");[m
          }[m
         $order_no=$Generation_result->generation_id;[m
         // *************************************展示计划****************************************************[m
[31m-        $order=array();[m
[31m-        //主计划[m
[31m-        $generation=Generation::with('creditcard')->where(['generation_id'=>$order_no])->find();[m
[31m-        //执行计划表[m
[31m-        $order=GenerationOrder::where(['order_no'=>$order_no])->order('order_time','asc')->select();[m
[31m-        foreach ($order as $key => $value) {[m
[31m-            $value=$value->toArray();[m
[31m-            // print_r($value);die;[m
[31m-            $list[$key]=$value;[m
[31m-            $list[$key]['day_time']=date("m月d日",strtotime($value['order_time']));[m
[31m-            $list[$key]['current_time']=date("H:i",strtotime($value['order_time']));[m
[31m-        }[m
[31m-        $data=[];[m
[31m-        //以日期为键[m
[31m-        foreach ($list as $key => $value) {[m
[31m-            $data[$value['day_time']][]=$value;[m
[31m-        }[m
[31m-        //手续费[m
[31m-        $order_pound=0;[m
[31m-        // print_r($data);die;[m
[31m-        //处理每日累计金额[m
[32m+[m		[32m$order=array();[m
[32m+[m		[32m//主计划[m
[32m+[m		[32m$generation=Generation::with('creditcard')->where(['generation_id'=>$order_no])->find();[m
[32m+[m		[32m//执行计划表[m
[32m+[m		[32m$order=GenerationOrder::where(['order_no'=>$order_no])->order('order_time','asc')->select();[m
[32m+[m		[32mforeach ($order as $key => $value) {[m
[32m+[m			[32m$value=$value->toArray();[m
[32m+[m			[32m// print_r($value);die;[m
[32m+[m			[32m$list[$key]=$value;[m
[32m+[m			[32m$list[$key]['day_time']=date("m月d日",strtotime($value['order_time']));[m
[32m+[m			[32m$list[$key]['current_time']=date("H:i",strtotime($value['order_time']));[m
[32m+[m		[32m}[m
[32m+[m		[32m$data=[];[m
[32m+[m		[32m//以日期为键[m
[32m+[m		[32mforeach ($list as $key => $value) {[m
[32m+[m			[32m$data[$value['day_time']][]=$value;[m
[32m+[m		[32m}[m
[32m+[m		[32m//手续费[m
[32m+[m		[32m$order_pound=0;[m
[32m+[m		[32m// print_r($data);die;[m
[32m+[m		[32m//处理每日累计金额[m
         foreach($data as $k=>$v){[m
[31m-                $data[$k]['pay']=0;[m
[31m-                $data[$k]['get']=0;[m
[31m-            foreach ($v as $key => $vv) {[m
[31m-                if($vv['order_type']==1){[m
[31m-                  $data[$k]['pay']+=$vv['order_money'];[m
[31m-                }else if($vv['order_type']==2){[m
[31m-                  $data[$k]['get']+=$vv['order_real_get'];[m
[31m-                }[m
[31m-                $order_pound+=$vv['order_pound'];[m
[31m-            }[m
[32m+[m[41m        [m		[32m$data[$k]['pay']=0;[m
[32m+[m[41m        [m		[32m$data[$k]['get']=0;[m
[32m+[m[41m        [m	[32mforeach ($v as $key => $vv) {[m
[32m+[m[41m        [m		[32mif($vv['order_type']==1){[m
[32m+[m[41m        [m		[32m  $data[$k]['pay']+=$vv['order_money'];[m
[32m+[m[41m        [m		[32m}else if($vv['order_type']==2){[m
[32m+[m[41m        [m		[32m  $data[$k]['get']+=$vv['order_money'];[m
[32m+[m[41m        [m		[32m}[m
[32m+[m[41m        [m		[32m$order_pound+=$vv['order_pound'];[m
[32m+[m[41m        [m	[32m}[m
         }[m
         $this->assign('uid',$param['uid']);[m
         $this->assign('token',$members['memberLogin']['login_token']);[m
[31m-        $this->assign('order_pound',$order_pound);[m
[31m-        $this->assign('generation',$generation);[m
[31m-        $this->assign('order',$data);[m
[31m-        return view("Userurl/repayment_plan_create_detail");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [还款计划创建 #2][m
[31m-     * @version  [用户还款计划确认提交页][m
[31m-     * param   $id  为generation表主键 generation_id[m
[31m-     * @return   [type][m
[31m-     */[m
[31m-    public function repayment_plan_confirm($id){[m
[31m-        $this->checkToken();[m
[31m-        $GenerationOrder=GenerationOrder::order('order_money desc')->where('order_no',$id)->find();[m
[31m-        $creaditcard=MemberCreditcard::where('card_bankno',$GenerationOrder->order_card)->find();[m
[31m-        $this->assign('generationorder',$GenerationOrder);[m
[31m-        $this->assign('creaditcard',$creaditcard);[m
[31m-        return view("Userurl/repayment_plan_confirm");[m
[31m-    }[m
[31m-      //确认执行还款计划[m
[31m-      //$id  为generation表主键 generation_id[m
[31m-      public function confirmPlan($id){[m
[31m-        $this->checkToken();[m
[31m-        $res=Generation::update(['generation_id'=>$id,'generation_state'=>2]);[m
[31m-        return json_encode($res ? ['code'=>200] : ['code'=>472,'msg'=>get_status_text(472)]);[m
[31m-      }[m
[31m-      #还款计划提交成功提示页[m
[31m-      #@version  [还款计划创建 #3][m
[31m-      #[m
[31m-      public function repayment_plan_success(){[m
[31m-        return view("Userurl/repayment_plan_success");[m
[31m-      }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [还款计划详情][m
[31m-     * @return   [type][m
[31m-     */[m
[32m+[m		[32m$this->assign('order_pound',$order_pound);[m
[32m+[m		[32m$this->assign('generation',$generation);[m
[32m+[m		[32m$this->assign('order',$data);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/repayment_plan_create_detail");[m
[32m+[m	[32m}[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [还款计划创建 #2][m
[32m+[m	[32m * @version  [用户还款计划确认提交页][m
[32m+[m	[32m * param   $id  为generation表主键 generation_id[m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m	[32mpublic function repayment_plan_confirm($id){[m
[32m+[m		[32m$this->checkToken();[m
[32m+[m		[32m$GenerationOrder=GenerationOrder::order('order_money desc')->where('order_no',$id)->find();[m
[32m+[m		[32m$creaditcard=MemberCreditcard::where('card_bankno',$GenerationOrder->order_card)->find();[m
[32m+[m		[32m$this->assign('generationorder',$GenerationOrder);[m
[32m+[m		[32m$this->assign('creaditcard',$creaditcard);[m
[32m+[m		[32mreturn view("Userurl/repayment_plan_confirm");[m
[32m+[m	[32m}[m
[32m+[m	[32m  //确认执行还款计划[m
[32m+[m	[32m  //$id  为generation表主键 generation_id[m
[32m+[m	[32m  public function confirmPlan($id){[m
[32m+[m		[32m$this->checkToken();[m
[32m+[m		[32m$res=Generation::update(['generation_id'=>$id,'generation_state'=>2]);[m
[32m+[m		[32mreturn json_encode($res ? ['code'=>200] : ['code'=>472,'msg'=>get_status_text(472)]);[m
[32m+[m	[32m  }[m
[32m+[m	[32m  #还款计划提交成功提示页[m
[32m+[m	[32m  #@version  [还款计划创建 #3][m
[32m+[m	[32m  #[m
[32m+[m	[32m  public function repayment_plan_success(){[m
[32m+[m		[32mreturn view("Userurl/repayment_plan_success");[m
[32m+[m	[32m  }[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [还款计划详情][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
 [m
[31m-    public function repayment_plan_detail(){[m
[31m-        #1获取参数判断需不需要去签约[m
[31m-        // $this->checkToken();[m
[31m-        $order_no=input('order_no');[m
[32m+[m	[32mpublic function repayment_plan_detail(){[m
[32m+[m		[32m#1获取参数判断需不需要去签约[m
[32m+[m		[32m// $this->checkToken();[m
[32m+[m		[32m$order_no=input('order_no');[m
        #33展示计划页面[m
[31m-        $order=array();[m
[31m-        //主计划[m
[31m-        $generation=Generation::with('creditcard')->where(['generation_id'=>$order_no])->find();[m
[31m-        //执行计划表[m
[31m-        $order=GenerationOrder::where(['order_no'=>$order_no])->order('order_time','asc')->select();[m
[31m-        if(!$order){[m
[31m-            echo '<li style="margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;">暂无计划详情</li>';die;[m
[31m-        }[m
[31m-        $is_first=0;[m
[31m-        foreach ($order as $key => $value) {[m
[31m-            $value=$value->toArray();[m
[31m-            $list[$key]=$value;[m
[31m-            $list[$key]['day_time']=date("m月d日",strtotime($value['order_time']));[m
[31m-            $list[$key]['current_time']=date("H:i",strtotime($value['order_time']));[m
[31m-            if($value['order_status']=='-1' && $is_first==0 && $generation['generation_state']==2){//失败[m
[31m-                $list[$key]['is_first']=1;[m
[31m-                $is_first=1;[m
[31m-            }[m
[31m-            [m
[31m-        }[m
[31m-        // print_r($list);die;[m
[31m-        $data=[];[m
[31m-        //以日期为键[m
[31m-        foreach ($list as $key => $value) {[m
[31m-            $data[$value['day_time']][]=$value;[m
[31m-        }[m
[31m-        //手续费[m
[31m-        $order_pound=0;[m
[31m-        // print_r($data);die;[m
[31m-        //处理每日累计金额[m
[32m+[m		[32m$order=array();[m
[32m+[m		[32m//主计划[m
[32m+[m		[32m$generation=Generation::with('creditcard')->where(['generation_id'=>$order_no])->find();[m
[32m+[m		[32m//执行计划表[m
[32m+[m		[32m$order=GenerationOrder::where(['order_no'=>$order_no])->order('order_time','asc')->select();[m
[32m+[m		[32mif(!$order){[m
[32m+[m			[32mecho '<li style="margin-top:13rem;text-align:center;list-style:none;font-size:1.4rem;color:#999;">暂无计划详情</li>';die;[m
[32m+[m		[32m}[m
[32m+[m		[32m$is_first=0;[m
[32m+[m		[32mforeach ($order as $key => $value) {[m
[32m+[m			[32m$value=$value->toArray();[m
[32m+[m			[32m$list[$key]=$value;[m
[32m+[m			[32m$list[$key]['day_time']=date("m月d日",strtotime($value['order_time']));[m
[32m+[m			[32m$list[$key]['current_time']=date("H:i",strtotime($value['order_time']));[m
[32m+[m			[32mif($value['order_status']=='-1' && $is_first==0 && $generation['generation_state']==2){//失败[m
[32m+[m				[32m$list[$key]['is_first']=1;[m
[32m+[m				[32m$is_first=1;[m
[32m+[m			[32m}[m
[32m+[m[41m			[m
[32m+[m		[32m}[m
[32m+[m		[32m// print_r($list);die;[m
[32m+[m		[32m$data=[];[m
[32m+[m		[32m//以日期为键[m
[32m+[m		[32mforeach ($list as $key => $value) {[m
[32m+[m			[32m$data[$value['day_time']][]=$value;[m
[32m+[m		[32m}[m
[32m+[m		[32m//手续费[m
[32m+[m		[32m$order_pound=0;[m
[32m+[m		[32m// print_r($data);die;[m
[32m+[m		[32m//处理每日累计金额[m
         foreach($data as $k=>$v){[m
[31m-                $data[$k]['pay']=0;[m
[31m-                $data[$k]['get']=0;[m
[31m-            foreach ($v as $key => $vv) {[m
[31m-                if($vv['order_type']==1){[m
[31m-                  $data[$k]['pay']+=$vv['order_money'];[m
[31m-                }else if($vv['order_type']==2){[m
[31m-                  $data[$k]['get']+=$vv['order_real_get'];[m
[31m-                }[m
[31m-                $order_pound+=$vv['order_pound'];[m
[31m-            }[m
[32m+[m[41m        [m		[32m$data[$k]['pay']=0;[m
[32m+[m[41m        [m		[32m$data[$k]['get']=0;[m
[32m+[m[41m        [m	[32mforeach ($v as $key => $vv) {[m
[32m+[m[41m        [m		[32mif($vv['order_type']==1){[m
[32m+[m[41m        [m		[32m  $data[$k]['pay']+=$vv['order_money'];[m
[32m+[m[41m        [m		[32m}else if($vv['order_type']==2){[m
[32m+[m[41m        [m		[32m  $data[$k]['get']+=$vv['order_money'];[m
[32m+[m[41m        [m		[32m}[m
[32m+[m[41m        [m		[32m$order_pound+=$vv['order_pound'];[m
[32m+[m[41m        [m	[32m}[m
         }[m
         // print_r($data);die;[m
[31m-        $this->assign('order_pound',$order_pound);[m
[31m-        $this->assign('generation',$generation);[m
[31m-        $this->assign('order',$data);[m
[31m-        return view("Userurl/repayment_plan_detail");[m
[31m-    }[m
[31m-    //根据开始时间结束时间随机每天刷卡时间---有问题[m
[31m-      public function get_random_time($day,$count,$begin=8,$end=12){[m
[32m+[m		[32m$this->assign('order_pound',$order_pound);[m
[32m+[m		[32m$this->assign('generation',$generation);[m
[32m+[m		[32m$this->assign('order',$data);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/repayment_plan_detail");[m
[32m+[m	[32m}[m
[32m+[m	[32m//根据开始时间结束时间随机每天刷卡时间---有问题[m
[32m+[m[32m      public function get_random_time($day,$count,$begin=5,$end=10){[m
         //如果日期为今天，刷卡时间大于当前小时[m
         $now_h=date('Y-m-d',time());[m
         if($day==$now_h){[m
[31m-           if($now_h<8){[m
[31m-               $begin =8;[m
[32m+[m[32m           if($now_h<6){[m
[32m+[m[32m               $begin =6;[m
            }else{[m
                $begin=date('H',time())+1;[m
            }[m
[36m@@ -599,14 +572,12 @@[m [mclass Userurl extends Controller[m
         $last=$begin;[m
          $step=floor(($end-$begin)/$count)-1;[m
          for ($i=0; $i <$count ; $i++) { [m
[31m-            // $time[$i]=$day.' '.get_hours($last,$last+$step).':'.get_minites();[m
[31m-               $time[$i]=$day.' '.get_hours($begin,$end).':'.get_minites();[m
[32m+[m[32m            $time[$i]=$day.' '.get_hours($last,$last+$step).':'.get_minites();[m
             // $time[$i]['time']=$day.' '.get_hours($last,$last+$step).':'.get_minites();[m
             // $time[$i]['begin']=$last;[m
             // $time[$i]['end']=$last+$step;[m
             $last=$last+$step+1;[m
          }[m
[31m-         sort($time);[m
          // print_r($time);die;[m
          return $time;[m
       }[m
[36m@@ -619,11 +590,9 @@[m [mclass Userurl extends Controller[m
       }[m
       //根据支付的金额获取实际到账金额[m
        //传入单位元，转成分计算，再返回单位元[m
[31m-      public function get_real_money($rate,$fix,$pay,$passageway_rate,$passageway_income){[m
[31m-         //费率向上取整  0,1  0 [m
[32m+[m[32m      public function get_real_money($rate,$fix,$pay){[m
[32m+[m[32m         //费率向上取整[m
           $return['fee']=ceil($pay*100*$rate+$fix*100)/100;[m
[31m-          $return['passageway_fee']=ceil($pay*100*$passageway_rate/100+$passageway_income*100)/100;[m
[31m-          $return['plantform_fee']=$return['fee']-$return['passageway_fee'];[m
           $return['money']=$pay-$return['fee'];[m
           return $return;[m
       }[m
[36m@@ -694,140 +663,143 @@[m [mclass Userurl extends Controller[m
            }[m
            return $arr;[m
       }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [消息][m
[31m-     * @return   [type][m
[31m-     */[m
[31m-     public function notify(){[m
[31m-         $this->checkToken();[m
[31m-        $count=Notice::where(['notice_recieve'=>$this->param['uid'],'notice_status'=>0])->count();[m
[31m-        $this->assign('count',$count);[m
[31m-        return view("Userurl/notify");[m
[31m-     }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [平台公告列表][m
[31m-     * @return   [type][m
[31m-     */[m
[31m-    public function notify_list(){[m
[31m-        $this->checkToken();[m
[31m-        $notice=Notice::where(['notice_recieve'=>$this->param['uid']])->order('notice_createtime desc')->select();[m
[31m-        if(!$notice){[m
[31m-            return view("Userurl/no_data");[m
[31m-        }[m
[31m-        $this->assign('notice',$notice);[m
[31m-        return view("Userurl/notify_list");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-26T16:29:39+0800[m
[31m-     * @version  [version][m
[31m-     * @param    [type]                   $id [announcement_id][m
[31m-     * @return   [type]                       [平台公告详情][m
[31m-     */[m
[31m-    public function notify_list_detail($id){[m
[31m-        $this->checkToken();[m
[31m-        $notice=Notice::get($id);[m
[31m-        $notice->save(['notice_status'=>1]);[m
[31m-        $this->assign('notice',$notice);[m
[31m-        return view("Userurl/notify_list_detail");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [动账交易列表][m
[31m-     * @return   [type][m
[31m-     */[m
[31m-    public function deal_list(){[m
[31m-        // $this->checkToken();[m
[31m-        $this->param['uid']=input("uid");[m
[31m-        $page = empty(input("page"))?1:input("page");[m
[31m-        if($_POST){[m
[31m-            $start = ($page-1)*10;[m
[31m-            $CashOrder=CashOrder::with("passageway")->where(['order_member'=>$this->param['uid'],'order_money' => ['<>' , 0]])->order('order_id desc')->limit($start,10)->select();[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [消息][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m	[32m public function notify(){[m
[32m+[m		[32m $this->checkToken();[m
[32m+[m	[41m [m	[32m$count=Notice::where(['notice_recieve'=>$this->param['uid'],'notice_status'=>0])->count();[m
[32m+[m		[32m$this->assign('count',$count);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/notify");[m
[32m+[m	[32m }[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [平台公告列表][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m	[32mpublic function notify_list(){[m
[32m+[m		[32m$this->checkToken();[m
[32m+[m		[32m$notice=Notice::where(['notice_recieve'=>$this->param['uid']])->order('notice_createtime desc')->select();[m
[32m+[m		[32mif(!$notice){[m
[32m+[m			[32mreturn view("Userurl/no_data");[m
[32m+[m		[32m}[m
[32m+[m		[32m$this->assign('notice',$notice);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/notify_list");[m
[32m+[m	[32m}[m
[32m+[m[32m  public function no_data(){[m
[32m+[m[32m    return view("Userurl/no_data");[m
[32m+[m[32m  }[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-26T16:29:39+0800[m
[32m+[m	[32m * @version  [version][m
[32m+[m	[32m * @param    [type]                   $id [announcement_id][m
[32m+[m	[32m * @return   [type]                       [平台公告详情][m
[32m+[m	[32m */[m
[32m+[m	[32mpublic function notify_list_detail($id){[m
[32m+[m		[32m$this->checkToken();[m
[32m+[m		[32m$notice=Notice::get($id);[m
[32m+[m		[32m$notice->save(['notice_status'=>1]);[m
[32m+[m		[32m$this->assign('notice',$notice);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/notify_list_detail");[m
[32m+[m	[32m}[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [动账交易列表][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m	[32mpublic function deal_list(){[m
[32m+[m		[32m// $this->checkToken();[m
[32m+[m		[32m$this->param['uid']=input("uid");[m
[32m+[m		[32m$page = empty(input("page"))?1:input("page");[m
[32m+[m		[32mif($_POST){[m
[32m+[m			[32m$start = ($page-1)*10;[m
[32m+[m			[32m$CashOrder=CashOrder::with("passageway")->where(['order_member'=>$this->param['uid'],'order_money' => ['<>' , 0]])->order('order_id desc')->limit($start,10)->select();[m
 [m
[31m-            foreach ($CashOrder as $key => $value) {[m
[31m-                $CashOrder[$key]["bank_ons"] = substr($value['order_creditcard'], -4);[m
[31m-                $CashOrder[$key]['add_time'] = date("m-d H:s",strtotime($value['order_add_time']));[m
[31m-            }[m
[31m-            echo json_encode(["data" => $CashOrder, "page" => $page+1]);die;[m
[31m-        }[m
[31m-        $CashOrder=CashOrder::with("passageway")->where(['order_member'=>$this->param['uid'],'order_money' => ['<>' , 0]])->order('order_id desc')->limit(0,10)->select();[m
[31m-        $count = CashOrder::where(['order_member'=>$this->param['uid'],'order_money' => ['<>' , 0]])->order('order_id desc')->count();[m
[31m-            $pages = ceil($count/10);[m
[31m-            #截取银行卡号[m
[31m-        foreach ($CashOrder as $key => $value) {[m
[31m-            $CashOrder[$key]["bank_ons"] = substr($value['order_creditcard'], -4);[m
[31m-            $CashOrder[$key]['add_time'] = date("m-d H:s",strtotime($value['order_add_time']));[m
[31m-        }[m
[31m-        if(!$CashOrder){[m
[31m-            return view("Userurl/no_data");[m
[31m-        }[m
[31m-        $this->assign("pages",$pages);[m
[31m-        $this->assign('data',$CashOrder);[m
[31m-        return view("Userurl/deal_list");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [平台福利列表][m
[31m-     * @return   [type][m
[31m-     */[m
[31m-    public function welfare_list(){[m
[31m-        $this->checkToken();[m
[31m-        //取Recomment内容[m
[31m-        $Recomment=Recomment::all(['recomment_member_id'=>$this->param['uid']]);[m
[31m-        $data=[];[m
[31m-        //转存[m
[31m-        foreach ($Recomment as $k => $v) {[m
[31m-            $data[$k]['recomment_money']=$v['recomment_money'];[m
[31m-            $data[$k]['recomment_desc']=$v['recomment_desc'];[m
[31m-            $data[$k]['recomment_creat_time']=$v['recomment_creat_time'];[m
[31m-        }[m
[31m-        if(!$data){[m
[31m-            return view("Userurl/no_data");[m
[31m-        }[m
[31m-        //Todo 对应事件数据 被推荐用户  操作[m
[31m-        $this->assign('data',$data);[m
[31m-        return view("Userurl/welfare_list");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [注册页面][m
[31m-     * @return   [type][m
[31m-     */[m
[31m-    public function register(){[m
[31m-        $this->param=request()->param();[m
[31m-        //是否携带手机号[m
[31m-        if(!isset($this->param['recomment']))[m
[31m-            return 'miss telephone number';[m
[31m-        $recomment=$this->param['recomment'];[m
[31m-        //手机号格式[m
[31m-        if(!preg_match('/1\d{10}/', $recomment))[m
[31m-            return 'incorrect telephone number';[m
[31m-        $recommentid=Members::get(['member_mobile'=>$recomment]);[m
[31m-        //该手机号是否存在[m
[31m-        if(!$recommentid)[m
[31m-            return 'recomment telephone isnt exist';[m
[31m-        $this->assign('tel',$recomment);[m
[31m-        return view("Userurl/register");[m
[31m-    }[m
[31m-    /**[m
[31m-     * @Author   Star(794633291@qq.com)[m
[31m-     * @DateTime 2017-12-25T14:10:55+0800[m
[31m-     * @version  [下载页面][m
[31m-     * @return   [type][m
[31m-     */[m
[31m-    public function download(){[m
[31m-        $data['android_url']=Appversion::where(['version_type'=>'android','version_state'=>1])->value('version_link');[m
[31m-        $data['ios_url']=Appversion::where(['version_type'=>'ios','version_state'=>1])->value('version_link');[m
[31m-        $this->assign('data',$data);[m
[31m-        return view("Userurl/download");[m
[31m-    }[m
[32m+[m			[32mforeach ($CashOrder as $key => $value) {[m
[32m+[m			[41m [m	[32m$CashOrder[$key]["bank_ons"] = substr($value['order_creditcard'], -4);[m
[32m+[m			[41m [m	[32m$CashOrder[$key]['add_time'] = date("m-d H:s",strtotime($value['order_add_time']));[m
[32m+[m			[32m}[m
[32m+[m			[32mecho json_encode(["data" => $CashOrder, "page" => $page+1]);die;[m
[32m+[m		[32m}[m
[32m+[m		[32m$CashOrder=CashOrder::with("passageway")->where(['order_member'=>$this->param['uid'],'order_money' => ['<>' , 0]])->order('order_id desc')->limit(0,10)->select();[m
[32m+[m		[32m$count = CashOrder::where(['order_member'=>$this->param['uid'],'order_money' => ['<>' , 0]])->order('order_id desc')->count();[m
[32m+[m			[32m$pages = ceil($count/10);[m
[32m+[m			[32m#截取银行卡号[m
[32m+[m		[32mforeach ($CashOrder as $key => $value) {[m
[32m+[m			[32m$CashOrder[$key]["bank_ons"] = substr($value['order_creditcard'], -4);[m
[32m+[m			[32m$CashOrder[$key]['add_time'] = date("m-d H:s",strtotime($value['order_add_time']));[m
[32m+[m		[32m}[m
[32m+[m		[32mif(!$CashOrder){[m
[32m+[m			[32mreturn view("Userurl/no_data");[m
[32m+[m		[32m}[m
[32m+[m		[32m$this->assign("pages",$pages);[m
[32m+[m		[32m$this->assign('data',$CashOrder);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/deal_list");[m
[32m+[m	[32m}[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [平台福利列表][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m	[32mpublic function welfare_list(){[m
[32m+[m		[32m$this->checkToken();[m
[32m+[m		[32m//取Recomment内容[m
[32m+[m		[32m$Recomment=Recomment::all(['recomment_member_id'=>$this->param['uid']]);[m
[32m+[m		[32m$data=[];[m
[32m+[m		[32m//转存[m
[32m+[m		[32mforeach ($Recomment as $k => $v) {[m
[32m+[m			[32m$data[$k]['recomment_money']=$v['recomment_money'];[m
[32m+[m			[32m$data[$k]['recomment_desc']=$v['recomment_desc'];[m
[32m+[m			[32m$data[$k]['recomment_creat_time']=$v['recomment_creat_time'];[m
[32m+[m		[32m}[m
[32m+[m		[32mif(!$data){[m
[32m+[m			[32mreturn view("Userurl/no_data");[m
[32m+[m		[32m}[m
[32m+[m		[32m//Todo 对应事件数据 被推荐用户  操作[m
[32m+[m		[32m$this->assign('data',$data);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/welfare_list");[m
[32m+[m	[32m}[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [注册页面][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m	[32mpublic function register(){[m
[32m+[m		[32m$this->param=request()->param();[m
[32m+[m		[32m//是否携带手机号[m
[32m+[m		[32mif(!isset($this->param['recomment']))[m
[32m+[m			[32mreturn 'miss telephone number';[m
[32m+[m		[32m$recomment=$this->param['recomment'];[m
[32m+[m		[32m//手机号格式[m
[32m+[m		[32mif(!preg_match('/1\d{10}/', $recomment))[m
[32m+[m			[32mreturn 'incorrect telephone number';[m
[32m+[m		[32m$recommentid=Members::get(['member_mobile'=>$recomment]);[m
[32m+[m		[32m//该手机号是否存在[m
[32m+[m		[32mif(!$recommentid)[m
[32m+[m			[32mreturn 'recomment telephone isnt exist';[m
[32m+[m		[32m$this->assign('tel',$recomment);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/register");[m
[32m+[m	[32m}[m
[32m+[m	[32m/**[m
[32m+[m	[32m * @Author   Star(794633291@qq.com)[m
[32m+[m	[32m * @DateTime 2017-12-25T14:10:55+0800[m
[32m+[m	[32m * @version  [下载页面][m
[32m+[m	[32m * @return   [type][m
[32m+[m	[32m */[m
[32m+[m	[32mpublic function download(){[m
[32m+[m		[32m$data['android_url']=Appversion::where(['version_type'=>'android','version_state'=>1])->value('version_link');[m
[32m+[m		[32m$data['ios_url']=Appversion::where(['version_type'=>'ios','version_state'=>1])->value('version_link');[m
[32m+[m		[32m$this->assign('data',$data);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/download");[m
[32m+[m	[32m}[m
 [m
   /**[m
    * @Author   杨成志(3115317085@qq.com)[m
[36m@@ -848,7 +820,7 @@[m [mclass Userurl extends Controller[m
    * @return   [type][m
    */[m
   public function web_marketing_media_library(){[m
[31m-    $this->assign("name",System::getName("sitename"));[m
[32m+[m[41m  [m	[32m$this->assign("name",System::getName("sitename"));[m
     $generalizelist =  Generalize::generalizelist();[m
     $this->assign("generalizelist",$generalizelist);[m
     return view("api/logic/web_marketing_media_library");[m
[36m@@ -870,10 +842,10 @@[m [mclass Userurl extends Controller[m
     $phoneInfo = CustomerService::customerinfo("电话");[m
     $this->assign("phoneInfo",$phoneInfo);[m
 [m
[31m-    [m
[31m-    $server['working_hours'] =  System::getName('working_hours');[m
[31m-    $server['phone'] = System::getName('contact_tel');//公司联系电话[m
[31m-    $this->assign("server",$server);[m
[32m+[m[41m  	[m
[32m+[m[41m  [m	[32m$server['working_hours'] =  System::getName('working_hours');[m
[32m+[m[41m  [m	[32m$server['phone'] = System::getName('contact_tel');//公司联系电话[m
[32m+[m[41m  [m	[32m$this->assign("server",$server);[m
     return $this->fetch("api/logic/web_contact_us");[m
   }[m
   /**[m
[36m@@ -897,11 +869,11 @@[m [mclass Userurl extends Controller[m
    * @return [type] [description][m
    */[m
   public function share_link_list(){[m
[31m-    $this->checkToken();[m
[31m-    $phone=Members::get($this->param['uid']);[m
[31m-    $phone=$phone->member_mobile;[m
[31m-    $url='http://'.$_SERVER['HTTP_HOST'].'/api/userurl/gotoregister/recomment/'.$phone;[m
[31m-    $this->assign('url',$url);[m
[32m+[m	[32m$this->checkToken();[m
[32m+[m	[32m$phone=Members::get($this->param['uid']);[m
[32m+[m	[32m$phone=$phone->member_mobile;[m
[32m+[m	[32m$url='http://'.$_SERVER['HTTP_HOST'].'/api/userurl/gotoregister/recomment/'.$phone;[m
[32m+[m	[32m$this->assign('url',$url);[m
     $list = Share::all();[m
     $this->assign("name",System::getName("sitename"));[m
     $this->assign("list",$list);[m
[36m@@ -913,345 +885,351 @@[m [mclass Userurl extends Controller[m
    * @return [type] [description][m
    */[m
   public function share_link(){[m
[31m-    $this->checkToken();[m
[31m-    $phone=Members::get($this->param['uid']);[m
[31m-    $phone=$phone->member_mobile;[m
[31m-    $url='http://'.$_SERVER['HTTP_HOST'].'/api/userurl/register/recomment/'.$phone;[m
[31m-    $this->assign('url',$url);[m
[32m+[m	[32m$this->checkToken();[m
[32m+[m	[32m$phone=Members::get($this->param['uid']);[m
[32m+[m	[32m$phone=$phone->member_mobile;[m
[32m+[m	[32m$url='http://'.$_SERVER['HTTP_HOST'].'/api/userurl/register/recomment/'.$phone;[m
[32m+[m	[32m$this->assign('url',$url);[m
     return view("Userurl/share_link");[m
   }[m
   #分享的注册页 只有一个按钮的那个[m
   public function gotoregister(){[m
[31m-    $this->param=request()->param();[m
[31m-    #鑫鑫钱柜ngix报错 改用id查询src 兼容以前链接[m
[31m-    if(isset($this->param['share_thumb'])){[m
[31m-        $share_thumb=preg_replace('/~/', '/', $this->param['share_thumb']);[m
[31m-    }else{[m
[31m-        $Share=Share::get($this->param['share_id']);[m
[31m-        $share_thumb=$Share->share_thumb;[m
[31m-    }[m
[31m-    $url='http://'.$_SERVER['HTTP_HOST'].'/api/userurl/register/recomment/'.$this->param['recomment'];[m
[31m-    $this->assign('url',$url);[m
[31m-    $this->assign('share_thumb',$share_thumb);[m
[31m-    return view("Userurl/gotoregister");[m
[32m+[m[41m  [m	[32m$this->param=request()->param();[m
[32m+[m[41m  [m	[32m#鑫鑫钱柜ngix报错 改用id查询src 兼容以前链接[m
[32m+[m[41m  [m	[32mif(isset($this->param['share_thumb'])){[m
[32m+[m	[41m  [m	[32m$share_thumb=preg_replace('/~/', '/', $this->param['share_thumb']);[m
[32m+[m[41m  [m	[32m}else{[m
[32m+[m	[41m  [m	[32m$Share=Share::get($this->param['share_id']);[m
[32m+[m	[41m  [m	[32m$share_thumb=$Share->share_thumb;[m
[32m+[m[41m  [m	[32m}[m
[32m+[m[41m  [m	[32m$url='http://'.$_SERVER['HTTP_HOST'].'/api/userurl/register/recomment/'.$this->param['recomment'];[m
[32m+[m	[32m$this->assign('url',$url);[m
[32m+[m	[32m$this->assign('share_thumb',$share_thumb);[m
[32m+[m[41m  [m	[32mreturn view("Userurl/gotoregister");[m
   }[m
   #费率说明[m
   public function my_rates(){[m
[31m-    // $this->param['uid']=26;[m
[32m+[m[41m  [m	[32m// $this->param['uid']=26;[m
 [m
[31m-    // $passageway=Passageway::where(['passageway_state'=>1,'passageway_also'=>1])->select();[m
[31m-    // var_dump($passageway);die;[m
[31m-     #获取所有通道[m
[31m-    #获取所有税率[m
[31m-    // $also=PassagewayItem::haswhere('passageway',['passageway_state'=>1])->select();[m
[31m-    $also=db('passageway')->where(['passageway_state'=>1])->order('passageway_also')->select();[m
[31m-    foreach ($also as $k => $v) {[m
[31m-        $also[$k]['details']=db('passageway_item')->alias('i')[m
[31m-            ->join('member_group g','i.item_group=g.group_id')[m
[31m-            ->where('i.item_passageway',$v['passageway_id'])->select();[m
[31m-    }[m
[31m-    $this->assign('also',$also);[m
[31m-    return view("Userurl/my_rates");[m
[32m+[m[41m  [m	[32m// $passageway=Passageway::where(['passageway_state'=>1,'passageway_also'=>1])->select();[m
[32m+[m[41m  [m	[32m// var_dump($passageway);die;[m
[32m+[m[41m  [m	[32m #获取所有通道[m
[32m+[m[41m  [m	[32m#获取所有税率[m
[32m+[m[41m  [m	[32m// $also=PassagewayItem::haswhere('passageway',['passageway_state'=>1])->select();[m
[32m+[m[41m  [m	[32m$also=db('passageway')->where(['passageway_state'=>1])->order('passageway_also')->select();[m
[32m+[m[41m  [m	[32mforeach ($also as $k => $v) {[m
[32m+[m[41m  [m		[32m$also[$k]['details']=db('passageway_item')->alias('i')[m
[32m+[m[41m  [m			[32m->join('member_group g','i.item_group=g.group_id')[m
[32m+[m[41m  [m			[32m->where('i.item_passageway',$v['passageway_id'])->select();[m
[32m+[m[41m  [m	[32m}[m
[32m+[m[41m  [m	[32m$this->assign('also',$also);[m
[32m+[m[41m  [m	[32mreturn view("Userurl/my_rates");[m
   }[m
   #盈利模式说明[m
   public function explain(){[m
[31m-        $description=Article::hasWhere('articleCategorys',['category_name'=>'盈利模式说明'])->join("wt_article_data","data_article=article_id")->field("data_text")->find();[m
[31m-        $this->assign('data',$description);[m
[31m-        return view("Userurl/explain");[m
[32m+[m[41m  [m		[32m$description=Article::hasWhere('articleCategorys',['category_name'=>'盈利模式说明'])->join("wt_article_data","data_article=article_id")->field("data_text")->find();[m
[32m+[m[41m  [m		[32m$this->assign('data',$description);[m
[32m+[m	[41m  [m	[32mreturn view("Userurl/explain");[m
   }[m
   #关于我们[m
   public function about_us(){[m
[31m-    $data=Page::get(1);[m
[31m-    $server['weixin']=CustomerService::where('service_title','微信')->find();[m
[31m-    #资格证书[m
[31m-    $datas = Page::get(4);[m
[31m-    $this->assign("datas",$datas);[m
[31m-    $server['qq']=CustomerService::where('service_title','QQ')->find();[m
[32m+[m[41m  [m	[32m$data=Page::get(1);[m
[32m+[m[41m  [m	[32m$server['weixin']=CustomerService::where('service_title','微信')->find();[m
[32m+[m[41m  [m	[32m#资格证书[m
[32m+[m[41m  [m	[32m$datas = Page::get(4);[m
[32m+[m[41m  [m	[32m$this->assign("datas",$datas);[m
[32m+[m[41m  [m	[32m$server['qq']=CustomerService::where('service_title','QQ')->find();[m
 [m
[31m-    $server['tel']=CustomerService::where('service_title','电话')->find();[m
[31m-    $server['company_address'] = System::getName('company_address');[m
[31m-    $server['working_hours'] = System::getName('working_hours');[m
[31m-    $server['phone'] = System::getName('contact_tel');//公司联系电话[m
[31m-    $this->assign('data', $data);[m
[31m-    $this->assign('server', $server);[m
[31m-    return view("Userurl/about_us");[m
[32m+[m[41m  [m	[32m$server['tel']=CustomerService::where('service_title','电话')->find();[m
[32m+[m[41m  [m	[32m$server['company_address'] = System::getName('company_address');[m
[32m+[m[41m  [m	[32m$server['working_hours'] = System::getName('working_hours');[m
[32m+[m[41m  [m	[32m$server['phone'] = System::getName('contact_tel');//公司联系电话[m
[32m+[m[41m  [m	[32m$this->assign('data', $data);[m
[32m+[m[41m  [m	[32m$this->assign('server', $server);[m
[32m+[m[41m  [m	[32mreturn view("Userurl/about_us");[m
   }[m
   /**[m
    * [web_freshman_guide 新手指引][m
    * @return [type] [description][m
    */[m
    public function web_freshman_guide(){[m
[31m-        // $class = NoviceClasss::all();[m
[31m-        // #还款列表[m
[31m-        // foreach ($class as $key => $value) {[m
[31m-        //  $class[$key]['repaymentList'] = MemberNovice::lists($value['novice_class_id']);[m
[31m-        // }[m
[31m-        // $this->assign("class",$class);[m
[31m-        return view("api/logic/web_freshman_guide");[m
[32m+[m[41m   [m		[32m// $class = NoviceClasss::all();[m
[32m+[m[41m   [m		[32m// #还款列表[m
[32m+[m[41m   [m		[32m// foreach ($class as $key => $value) {[m
[32m+[m[41m   [m		[32m// 	$class[$key]['repaymentList'] = MemberNovice::lists($value['novice_class_id']);[m
[32m+[m[41m   [m		[32m// }[m
[32m+[m[41m   [m		[32m// $this->assign("class",$class);[m
[32m+[m[41m    [m	[32mreturn view("api/logic/web_freshman_guide");[m
   }[m
   /**[m
   *@version [instructicons_detail 新手指引详情页面][m
   *@author 杨成志 【3115317085@qq.com】[m
   */[m
   public function instructions_detail(){[m
[31m-    $title = input('title');[m
[31m-    $this->assign("title",$title);[m
[31m-    $info = MemberNovice::where(['novice_name' => $title])->find();[m
[31m-    $this->assign("info",$info);[m
[31m-    return view('api/logic/instructions_detail');[m
[32m+[m[41m  [m	[32m$title = input('title');[m
[32m+[m[41m  [m	[32m$this->assign("title",$title);[m
[32m+[m[41m  [m	[32m$info = MemberNovice::where(['novice_name' => $title])->find();[m
[32m+[m[41m  [m	[32m$this->assign("info",$info);[m
[32m+[m[41m  [m	[32mreturn view('api/logic/instructions_detail');[m
   }[m
   #信用卡说明[m
   public function card_description(){[m
[31m-    $CreditCard = new CreditCard();[m
[31m-    $list = $CreditCard->where(['bank_passageway_id'=>Request::instance()->param('id')])->select();[m
[31m-    $this->assign('list',$list);[m
[31m-    return view("api/logic/card_description");[m
[32m+[m[41m  [m	[32m$CreditCard = new CreditCard();[m
[32m+[m[41m  [m	[32m$list = $CreditCard->where(['bank_passageway_id'=>Request::instance()->param('id')])->select();[m
[32m+[m[41m  [m	[32m$this->assign('list',$list);[m
[32m+[m[41m  [m	[32mreturn view("api/logic/card_description");[m
   }[m
   /**[m
   *@version particulars 收支明细[m
   *@author 杨成志 （3115317085@qq.com）[m
   */[m
   public function particulars($month=null){[m
[31m-        if(!$month)$month=date('Y-m');[m
[32m+[m[41m    [m	[32mif(!$month)$month=date('Y-m');[m
       //月初[m
       $monthstart=strtotime($month);[m
       //月末[m
       $monthend=strtotime(date('Y-m',strtotime('+1 month',strtotime($month))));[m
[31m-      $data=[];[m
[31m-        $data['in']=0;[m
[31m-        $data['out']=0;[m
[31m-        //手动下滑获取数据[m
[31m-        if($_POST){[m
[31m-            $page = isset($_POST['page'])?$_POST['page']:1;[m
[31m-            #获取收支明细数据[m
[31m-            $result = WalletLog::pages(input('uid'),$page,$data,$month,$monthstart,$monthend);[m
[31m-            $list = $result['list'];[m
[31m-            exit(json_encode($list));[m
[31m-        }[m
[31m-       $this->checkToken();[m
[31m-      #获取收支明细数据[m
[31m-        $result = WalletLog::pages($this->param['uid'],1,$data,$month,$monthstart,$monthend);[m
[31m-        //用户id[m
[31m-        $this->assign("uid",$this->param['uid']);[m
[31m-        #当前总共多少页[m
[31m-        $this->assign("allpage" , $result['allpage']);[m
[31m-        $this->assign('data' , $result['data']);[m
[31m-        $this->assign('list' , $result['list']);[m
[31m-        return view("Userurl/particulars");[m
[32m+[m[41m  [m	[32m  $data=[];[m
[32m+[m[41m    [m	[32m$data['in']=0;[m
[32m+[m[41m    [m	[32m$data['out']=0;[m
[32m+[m[41m    [m	[32m//手动下滑获取数据[m
[32m+[m[41m    [m	[32mif($_POST){[m
[32m+[m[41m    [m		[32m$page = isset($_POST['page'])?$_POST['page']:1;[m
[32m+[m[41m    [m		[32m#获取收支明细数据[m
[32m+[m[41m    [m		[32m$result = WalletLog::pages(input('uid'),$page,$data,$month,$monthstart,$monthend);[m
[32m+[m[41m    [m		[32m$list = $result['list'];[m
[32m+[m[41m    [m		[32mexit(json_encode($list));[m
[32m+[m[41m    [m	[32m}[m
[32m+[m[41m  [m	[32m   $this->checkToken();[m
[32m+[m[41m   [m	[32m  #获取收支明细数据[m
[32m+[m[41m    [m	[32m$result = WalletLog::pages($this->param['uid'],1,$data,$month,$monthstart,$monthend);[m
[32m+[m[41m    [m	[32m//用户id[m
[32m+[m[41m    [m	[32m$this->assign("uid",$this->param['uid']);[m
[32m+[m[41m    [m	[32m#当前总共多少页[m
[32m+[m[41m    [m	[32m$this->assign("allpage" , $result['allpage']);[m
[32m+[m[41m    [m	[32m$this->assign('data' , $result['data']);[m
[32m+[m[41m    [m	[32m$this->assign('list' , $result['list']);[m
[32m+[m[41m    [m	[32mreturn view("Userurl/particulars");[m
   }[m
   #账单详情[m
   # log_id  wallet_log_id[m
   public function bills_detail($log_id){[m
[31m-    $this->checkToken();[m
[31m-    $wallet_log=db('wallet_log')->where('log_id',$log_id)->find();[m
[31m-    switch ($wallet_log['log_relation_type']){[m
[31m-        //分润分佣[m
[31m-        case 1:[m
[31m-            $commission=db('commission')->alias('c')[m
[31m-                ->join('member m','c.commission_childen_member=m.member_id')[m
[31m-                ->where('c.commission_id',$wallet_log['log_relation_id'])[m
[31m-                ->find();[m
[31m-            if($commission){[m
[31m-                $tel=$commission['member_mobile'];[m
[31m-                $commission['member_mobile']=substr($tel,0,3).'****'.substr($tel,7);[m
[31m-                $this->assign('commission',$commission);[m
[31m-            }[m
[31m-            break;[m
[31m-        //提现操作[m
[31m-        case 2:[m
[31m-            $withdraw=db('withdraw')->where('withdraw_id',$wallet_log['log_relation_id'])->find();[m
[31m-            if($withdraw)$withdraw['info']=state_info($withdraw['withdraw_state']);[m
[31m-            $this->assign('withdraw',$withdraw);[m
[31m-            break;[m
[31m-            //推荐红包[m
[31m-        case 5:[m
[31m-            $recomment=db('recomment')->alias('r')[m
[31m-                ->join('member m','r.recomment_children_member=m.member_id')[m
[31m-                ->where('r.recomment_id',$wallet_log['log_relation_id'])[m
[31m-                ->find();[m
[31m-            if($recomment){[m
[31m-                $tel=$recomment['member_mobile'];[m
[31m-                $recomment['member_mobile']=substr($tel,0,3).'****'.substr($tel,7);[m
[31m-                $this->assign('recomment',$recomment);[m
[31m-            }[m
[31m-        default:[m
[31m-            # code...[m
[31m-            break;[m
[31m-    }[m
[31m-    $this->assign('wallet_log',$wallet_log);[m
[31m-    return view("Userurl/bills_detail");[m
[32m+[m[41m  [m	[32m$this->checkToken();[m
[32m+[m[41m  [m	[32m$wallet_log=db('wallet_log')->where('log_id',$log_id)->find();[m
[32m+[m[41m  [m	[32mswitch ($wallet_log['log_relation_type']){[m
[32m+[m[41m  [m		[32m//分润分佣[m
[32m+[m[41m  [m		[32mcase 1:[m
[32m+[m[41m  [m			[32m$commission=db('commission')->alias('c')[m
[32m+[m[41m  [m				[32m->join('member m','c.commission_childen_member=m.member_id')[m
[32m+[m[41m  [m				[32m->where('c.commission_id',$wallet_log['log_relation_id'])[m
[32m+[m[41m  [m				[32m->find();[m
[32m+[m[41m  [m			[32mif($commission){[m
[32m+[m	[41m  [m			[32m$tel=$commission['member_mobile'];[m
[32m+[m	[41m  [m			[32m$commission['member_mobile']=substr($tel,0,3).'****'.substr($tel,7);[m
[32m+[m	[41m  [m			[32m$this->assign('commission',$commission);[m
[32m+[m[41m  [m			[32m}[m
[32m+[m[41m  [m			[32mbreak;[m
[32m+[m[41m  [m		[32m//提现操作[m
[32m+[m[41m  [m		[32mcase 2:[m
[32m+[m[41m  [m			[32m$withdraw=db('withdraw')->where('withdraw_id',$wallet_log['log_relation_id'])->find();[m
[32m+[m[41m  [m			[32mif($withdraw)$withdraw['info']=state_info($withdraw['withdraw_state']);[m
[32m+[m[41m  [m			[32m$this->assign('withdraw',$withdraw);[m
[32m+[m[41m  [m			[32mbreak;[m
[32m+[m[41m  [m			[32m//推荐红包[m
[32m+[m[41m  [m		[32mcase 5:[m
[32m+[m[41m  [m			[32m$recomment=db('recomment')->alias('r')[m
[32m+[m[41m  [m				[32m->join('member m','r.recomment_children_member=m.member_id')[m
[32m+[m[41m  [m				[32m->where('r.recomment_id',$wallet_log['log_relation_id'])[m
[32m+[m[41m  [m				[32m->find();[m
[32m+[m[41m  [m			[32mif($recomment){[m
[32m+[m	[41m  [m			[32m$tel=$recomment['member_mobile'];[m
[32m+[m	[41m  [m			[32m$recomment['member_mobile']=substr($tel,0,3).'****'.substr($tel,7);[m
[32m+[m	[41m [m			[32m$this->assign('recomment',$recomment);[m
[32m+[m[41m  [m			[32m}[m
[32m+[m[41m  [m		[32mdefault:[m
[32m+[m[41m  [m			[32m# code...[m
[32m+[m[41m  [m			[32mbreak;[m
[32m+[m[41m  [m	[32m}[m
[32m+[m[41m  [m	[32m$this->assign('wallet_log',$wallet_log);[m
[32m+[m[41m  [m	[32mreturn view("Userurl/bills_detail");[m
   }[m
   # 荣邦 开通快捷支付不返回html时 调用本页面 [m
   # memberId 用户id passwayId 通道id[m
   # treatycode 协议号 smsseq 短信验证码流水号[m
   public function passway_rongbang_openpay($memberId,$passwayId,$treatycode,$smsseq){[m
[31m-    if(request()->ispost()){[m
[31m-        $authcode=request()->param()['authcode'];[m
[31m-        if($authcode){[m
[31m-            $Membernets=new con\Membernets($memberId,$passwayId);[m
[31m-            $result=$Membernets->rongbang_confirm_openpay($treatycode,$smsseq,$authcode);[m
[31m-            return is_array($result) ? 1 : $result;[m
[31m-          }else{[m
[31m-            return 2;[m
[31m-          }[m
[31m-    }[m
[31m-    $this->assign('memberId',$memberId);[m
[31m-    $this->assign('passwayId',$passwayId);[m
[31m-    $this->assign('treatycode',$treatycode);[m
[31m-    $this->assign('smsseq',$smsseq);[m
[31m-    return view("Userurl/passway_rongbang_openpay");[m
[32m+[m[41m  [m	[32mif(request()->ispost()){[m
[32m+[m[41m  [m		[32m$authcode=request()->param()['authcode'];[m
[32m+[m[41m  [m		[32mif($authcode){[m
[32m+[m		[41m  [m	[32m$Membernets=new con\Membernets($memberId,$passwayId);[m
[32m+[m		[41m  [m	[32m$result=$Membernets->rongbang_confirm_openpay($treatycode,$smsseq,$authcode);[m
[32m+[m		[41m  [m	[32mreturn $result ? 1 : 3;[m
[32m+[m		[32m  }else{[m
[32m+[m		[41m  [m	[32mreturn 2;[m
[32m+[m		[32m  }[m
[32m+[m[41m  [m	[32m}[m
[32m+[m[41m  [m	[32m$this->assign('memberId',$memberId);[m
[32m+[m[41m  [m	[32m$this->assign('passwayId',$passwayId);[m
[32m+[m[41m  [m	[32m$this->assign('treatycode',$treatycode);[m
[32m+[m[41m  [m	[32m$this->assign('smsseq',$smsseq);[m
[32m+[m[41m  [m	[32mreturn view("Userurl/passway_rongbang_openpay");[m
   }[m
   # 荣邦 申请快捷支付订单不返回html时 调用本页面 [m
   # memberId 用户id passwayId 通道id[m
   # ordercode 订单号 card_id 卡号[m
 [m
   public function passway_rongbang_pay($memberId,$passwayId,$ordercode,$card_id){[m
[31m-    if(request()->ispost()){[m
[31m-        $authcode=request()->param()['authcode'];[m
[31m-        if($authcode){[m
[31m-            $Membernets=new con\Membernets($memberId,$passwayId);[m
[31m-            $result=$Membernets->rongbang_confirm_pay($ordercode,$card_id,$authcode);[m
[31m-            return is_array($result) ? 1 : $result;[m
[31m-          }else{[m
[31m-            return 2;[m
[31m-          }[m
[31m-    }[m
[31m-    #用户信息[m
[31m-    $info = Members::with("memberCashcard")->where(['member_id' => $memberId])->find();[m
[31m-    $money=db('cash_order')->where('order_thead_no',$ordercode)->value('order_money');[m
[31m-    $creditcard = MemberCreditcard::where(['card_id' => $card_id])->find();[m
[31m-    $this->assign("creditcard",$creditcard);[m
[31m-    $this->assign("member_info",$info);[m
[31m-    $this->assign('memberId',$memberId);[m
[31m-    $this->assign('money',$money);[m
[31m-    $this->assign('passwayId',$passwayId);[m
[31m-    $this->assign('ordercode',$ordercode);[m
[31m-    $this->assign('card_id',$card_id);[m
[31m-    return view("Userurl/passway_rongbang_pay");[m
[32m+[m[41m  [m	[32mif(request()->ispost()){[m
[32m+[m[41m  [m		[32m$authcode=request()->param()['authcode'];[m
[32m+[m[41m  [m		[32mif($authcode){[m
[32m+[m		[41m  [m	[32m$Membernets=new con\Membernets($memberId,$passwayId);[m
[32m+[m		[41m  [m	[32m$result=$Membernets->rongbang_confirm_pay($ordercode,$card_id,$authcode);[m
[32m+[m		[41m  [m	[32mreturn is_array($result) ? 1 : $result;[m
[32m+[m		[32m  }else{[m
[32m+[m		[41m  [m	[32mreturn 2;[m
[32m+[m		[32m  }[m
[32m+[m[41m  [m	[32m}[m
[32m+[m[41m  [m	[32m#用户信息[m
[32m+[m[41m  [m	[32m$info = Members::with("memberCashcard")->where(['member_id' => $memberId])->find();[m
[32m+[m[41m  [m	[32m$money=db('cash_order')->where('order_thead_no',$ordercode)->value('order_money');[m
[32m+[m[41m  [m	[32m$creditcard = MemberCreditcard::where(['card_id' => $card_id])->find();[m
[32m+[m[41m  [m	[32m$this->assign("creditcard",$creditcard);[m
[32m+[m[41m  [m	[32m$this->assign("member_info",$info);[m
[32m+[m[41m  [m	[32m$this->assign('memberId',$memberId);[m
[32m+[m[41m  [m	[32m$this->assign('money',$money);[m
[32m+[m[41m  [m	[32m$this->assign('passwayId',$passwayId);[m
[32m+[m[41m  [m	[32m$this->assign('ordercode',$ordercode);[m
[32m+[m[41m  [m	[32m$this->assign('card_id',$card_id);[m
[32m+[m[41m  [m	[32mreturn view("Userurl/passway_rongbang_pay");[m
   }[m
 [m
   #荣邦支付回调[m
   public function passway_rongbang_paycallback(){[m
[31m-    $param=request()->param();[m
[31m-    #荣邦通道键位[m
[31m-    $passageway_no=db('passageway')->column("passageway_id,passageway_no");[m
[31m-    $userinfo=db('member_net')->where('net_member_id',$param['member_id'])[m
[31m-        ->value($passageway_no[$param['passageway_id']]);[m
[31m-    // $userinfo="402628739,1756961550411722,9abphqw0bcz2vr3r,zeo3qvxb0nwuobk5619hss25h1dsremg,许成成11599";[m
[31m-    #信息顺序 0、appid 1、companycode 2、secretkey 3、session 4、companyname[m
[31m-      $userinfo=explode(',', $userinfo);[m
[31m-    $key=$userinfo[2];[m
[31m-    // return rongbang_aes_decode($key,rongbang_aes($key,$param['test']));[m
[31m-    $data = rongbang_aes_decode($key,$param['Data']);[m
[31m-    // var_dump($data);die;[m
[31m-    if($data=='err'){[m
[31m-        #失败日志[m
[31m-        trace("rongbang_aes_decode_err");[m
[31m-    }else{[m
[31m-        $data=json_decode($data,1);[m
[31m-            $cash_order=CashOrder::where('order_no',$param['order_no'])->find();[m
[31m-        if($data['respcode']==2){[m
[31m-          #查看是否有该订单的分润记录[m
[31m-          $hasCommission=db('commission')->where(['commission_from'=>$cash_order->order_id,'commission_type'=>1])->count();[m
[31m-            #仅对待支付状态下的订单进行更新并分润[m
[31m-            if($cash_order->order_state!=2 && $hasCommission == 0){[m
[31m-                $cash_order->order_state=2;[m
[31m-                //分润[m
[31m-                $fenrun= new con\Commission();[m
[31m-                $fenrun_result=$fenrun->MemberFenRun($param['member_id'],$cash_order->order_money,$param['passageway_id'],1,'快捷支付手续费分润',$cash_order->order_id);[m
[31m-            $member=Members::get($param['member_id']);[m
[31m-            $passway=Passageway::get($param['passageway_id']);[m
[31m-            $passwayitem=PassagewayItem::get(['item_group'=>$member->member_group_id,'item_passageway'=>$passway->passageway_id]);[m
[31m-          if($fenrun_result['code']=="200"){[m
[31m-            $cash_order->order_fen=$fenrun_result['leftmoney'];[m
[31m-            $cash_order->order_buckle=$passwayitem->item_charges/100;[m
[31m-            $cash_order->order_platform=$cash_order->order_charge-($cash_order->order_money*$passway->passageway_rate/100)+$passwayitem->item_charges/100-$passway->passageway_income;[m
[31m-          }else{[m
[31m-            $cash_order->order_fen=-1;[m
[31m-            $cash_order->order_buckle=$passwayitem->item_charges/100;[m
[31m-            $cash_order->order_platform=$cash_order->order_charge-($cash_order->order_money*$passway->passageway_rate/100)+$passwayitem->item_charges/100-$passway->passageway_income;[m
[31m-          }[m
[31m-          $cash_order->save();[m
[31m-            }else{[m
[31m-                trace("rongbang_repeat_request,not fenrun");[m
[31m-            }[m
[31m-        }else{[m
[31m-            $cash_order->order_state=-1;[m
[31m-            $cash_order->order_desc.=$data['respmsg'];[m
[31m-            $cash_order->save();[m
[31m-        }[m
[31m-    }[m
[31m-    //按文档要求返回[m
[31m-    return json_encode(['message'=>'ok','response'=>'00']);[m
[32m+[m[41m  [m	[32m$param=request()->param();[m
[32m+[m[41m  [m	[32m#荣邦通道键位[m
[32m+[m[41m  [m	[32m$passageway_no=db('passageway')->column("passageway_id,passageway_no");[m
[32m+[m[41m  [m	[32m$userinfo=db('member_net')->where('net_member_id',$param['member_id'])[m
[32m+[m[41m  [m		[32m->value($passageway_no[$param['passageway_id']]);[m
[32m+[m[41m  [m	[32m// $userinfo="402628739,1756961550411722,9abphqw0bcz2vr3r,zeo3qvxb0nwuobk5619hss25h1dsremg,许成成11599";[m
[32m+[m	[32m#信息顺序 0、appid 1、companycode 2、secretkey 3、session 4、companyname[m
[32m+[m	[32m  $userinfo=explode(',', $userinfo);[m
[32m+[m[41m  [m	[32m$key=$userinfo[2];[m
[32m+[m[41m  [m	[32m// return rongbang_aes_decode($key,rongbang_aes($key,$param['test']));[m
[32m+[m[41m  [m	[32m$data = rongbang_aes_decode($key,$param['Data']);[m
[32m+[m[41m  [m	[32m// var_dump($data);die;[m
[32m+[m[41m  [m	[32mif($data=='err'){[m
[32m+[m[41m  [m		[32m#失败日志[m
[32m+[m[41m  [m		[32mtrace("rongbang_aes_decode_err");[m
[32m+[m[41m  [m	[32m}else{[m
[32m+[m[41m  [m		[32m$data=json_decode($data,1);[m
[32m+[m[41m  [m		[32mif($data['respcode']==2){[m
[32m+[m[41m  [m			[32m$cash_order=CashOrder::where('order_no',$param['order_no'])->find();[m
[32m+[m[41m  [m			[32m#仅对待支付状态下的订单进行更新并分润[m
[32m+[m[41m  [m			[32mif($cash_order->order_state==1){[m
[32m+[m[41m  [m				[32m$cash_order->order_state=2;[m
[32m+[m[41m  [m				[32m$cash_order->save();[m
[32m+[m				[32m//分润[m
[32m+[m			[32m    $fenrun= new con\Commission();[m
[32m+[m			[32m    $fenrun_result=$fenrun->MemberFenRun($param['member_id'],$data['amount'],$param['passageway_id'],1,'交易手续费分润',$cash_order->order_id);[m
[32m+[m[41m  [m			[32m}else{[m
[32m+[m[41m  [m				[32mtrace("rongbang_repeat_request,not fenrun");[m
[32m+[m[41m  [m			[32m}[m
[32m+[m[41m  [m		[32m}else{[m
[32m+[m			[32m$cash_order->order_state=-1;[m
[32m+[m			[32m$cash_order->order_desc.=$data['respmsg'];[m
[32m+[m			[32m$cash_order->save();[m
[32m+[m[41m  [m		[32m}[m
[32m+[m[41m  [m	[32m}[m
[32m+[m[41m  [m	[32m//按文档要求返回[m
[32m+[m[41m  [m	[32mreturn json_encode(['message'=>'ok','response'=>'00']);[m
   }[m
   #为无需短信确认的情况 直接显示一个成功页面[m
   public function passway_success(){[m
[31m-    return view("Userurl/passway_success");[m
[32m+[m[41m  [m	[32mreturn view("Userurl/passway_success");[m
   }[m
   # 开通快捷支付 前台回调成功页面[m
   public function passway_open_success(){[m
[31m-    return view("Userurl/passway_open_success");[m
[32m+[m[41m  [m	[32mreturn view("Userurl/passway_open_success");[m
   }[m
   #取消还款计划【整体】[m
   public function cancel_repayment($generation_id){[m
[31m-    $membernet=new con\Membernet();[m
[31m-    return json_encode($membernet->cancle_plan($generation_id));[m
[32m+[m[41m  [m	[32m$membernet=new con\Membernet();[m
[32m+[m[41m  [m	[32mreturn json_encode($membernet->cancle_plan($generation_id));[m
   }[m
   //重新执行某个计划[m
   public function reset_one_repayment($plan_id){[m
[31m-        $membernet=new con\Membernet();[m
[31m-        $res=$membernet->action_single_plan($plan_id);[m
[31m-        echo $res;die;[m
[32m+[m[41m  [m		[32m$membernet=new con\Membernet();[m
[32m+[m[41m  [m		[32m$res=$membernet->action_single_plan($plan_id);[m
[32m+[m[41m  [m		[32mreturn $res;die;[m
   }[m
   //代还，用户签约界面[m
   public function signed($passageway_id,$cardId,$order_no){[m
[31m-        #信用卡信息[m
[31m-        $data['MemberCreditcard']=$MemberCreditcard=MemberCreditcard::where(['card_id'=>$cardId])->find();[m
[31m-        #通道信息[m
[31m-        $data['passageway']=$passageway=Passageway::get($passageway_id);[m
[31m-        #通道入网信息[m
[31m-        $member_net=MemberNet::where(['net_member_id'=>$MemberCreditcard['card_member_id']])->find();[m
[31m-        #用户基本信息[m
[31m-        $data['Members']=$Members=Members::haswhere('memberLogin','')->where(['member_id'=>$MemberCreditcard['card_member_id']])->find();[m
[31m-        #登录信息[m
[31m-        // if(!$MemberCreditcard || !$passageway || $member_net){[m
[31m-        //  exit('获取信息失败');[m
[31m-        // }[m
[31m-        $this->assign('order_no',$order_no);[m
[31m-        $this->assign('passageway_id',$passageway_id);[m
[31m-        $this->assign('data',$data);[m
[31m-        return view("Userurl/signed");[m
[32m+[m[41m  [m		[32m#信用卡信息[m
[32m+[m[41m  [m		[32m$data['MemberCreditcard']=$MemberCreditcard=MemberCreditcard::where(['card_id'=>$cardId])->find();[m
[32m+[m[41m  [m		[32m#通道信息[m
[32m+[m[41m  [m		[32m$data['passageway']=$passageway=Passageway::get($passageway_id);[m
[32m+[m[41m  [m		[32m#通道入网信息[m
[32m+[m[41m  [m		[32m$member_net=MemberNet::where(['net_member_id'=>$MemberCreditcard['card_member_id']])->find();[m
[32m+[m[41m  [m		[32m#用户基本信息[m
[32m+[m[41m  [m		[32m$data['Members']=$Members=Members::haswhere('memberLogin','')->where(['member_id'=>$MemberCreditcard['card_member_id']])->find();[m
[32m+[m[41m  [m		[32m#登录信息[m
[32m+[m[41m  [m		[32m// if(!$MemberCreditcard || !$passageway || $member_net){[m
[32m+[m[41m  [m		[32m// 	exit('获取信息失败');[m
[32m+[m[41m  [m		[32m// }[m
[32m+[m[41m  [m		[32m$this->assign('order_no',$order_no);[m
[32m+[m[41m  [m		[32m$this->assign('passageway_id',$passageway_id);[m
[32m+[m[41m  [m		[32m$this->assign('data',$data);[m
[32m+[m[41m  [m		[32mreturn view("Userurl/signed");[m
[32m+[m[32m  }[m
[32m+[m[32m  public function signed_huilian($passageway_id,$cardId,$order_no){[m
[32m+[m[32m      #信用卡信息[m
[32m+[m[32m      $data['MemberCreditcard']=$MemberCreditcard=MemberCreditcard::where(['card_id'=>$cardId])->find();[m
[32m+[m[32m      #通道信息[m
[32m+[m[32m      $data['passageway']=$passageway=Passageway::get($passageway_id);[m
[32m+[m[32m      #通道入网信息[m
[32m+[m[32m      $member_net=MemberNet::where(['net_member_id'=>$MemberCreditcard['card_member_id']])->find();[m
[32m+[m[32m      #用户基本信息[m
[32m+[m[32m      $data['Members']=$Members=Members::haswhere('memberLogin','')->where(['member_id'=>$MemberCreditcard['card_member_id']])->find();[m
[32m+[m[32m      $data['merId']=$data['Members']['memberNet'][$data['passageway']['passageway_no']];[m
[32m+[m[32m      var_dump($data['merId']);die;[m
[32m+[m[32m      #登录信息[m
[32m+[m[32m      // if(!$MemberCreditcard || !$passageway || $member_net){[m
[32m+[m[32m      //  exit('获取信息失败');[m
[32m+[m[32m      // }[m
[32m+[m[32m      $this->assign('order_no',$order_no);[m
[32m+[m[32m      $this->assign('passageway_id',$passageway_id);[m
[32m+[m[32m      $this->assign('data',$data);[m
[32m+[m[32m      return view("Userurl/signed_huilian");[m
   }[m
   #金易付验证码页面[m
   public function jinyifu($memberId,$passagewayId,$cardId,$price){[m
 [m
[31m-    if(request()->ispost()){[m
[31m-        // var_dump(Request::instance()->post('passagewayId'));die;[m
[31m-        $jinyifu=new \app\index\controller\CashOut(Request::instance()->post('memberId'),Request::instance()->post('passwayId'),Request::instance()->post('cardId'));[m
[31m-        $res=$jinyifu->jinyifu_pay(Request::instance()->post());[m
[32m+[m[41m  [m	[32mif(request()->ispost()){[m
[32m+[m[41m  [m		[32m// var_dump(Request::instance()->post('passagewayId'));die;[m
[32m+[m[41m  [m		[32m$jinyifu=new \app\index\controller\CashOut(Request::instance()->post('memberId'),Request::instance()->post('passwayId'),Request::instance()->post('cardId'));[m
[32m+[m[41m  [m		[32m$res=$jinyifu->jinyifu_pay(Request::instance()->post());[m
 [m
[31m-        return $res;[m
[31m-    }[m
[31m-    //$member=Members::with('memberCashcard,memberCreditcard')->where(['member_id'=>$memberId,'card_id'])->find();[m
[31m-    $info=Members::haswhere('memberCreditcard',['card_id'=>$cardId])->where(['member_id'=>$memberId])->find();[m
[31m-    // //var_dump($info::getLastSql());[m
[31m-    // dump($info->memberCreditcard->card_bankname);[m
[31m-    // dump($info->memberCashcard->card_bankname);[m
[31m-    // die;[m
[32m+[m[41m  [m		[32mreturn $res;[m
[32m+[m[41m  [m	[32m}[m
[32m+[m[41m  [m	[32m//$member=Members::with('memberCashcard,memberCreditcard')->where(['member_id'=>$memberId,'card_id'])->find();[m
[32m+[m[41m  [m	[32m$info=Members::haswhere('memberCreditcard',['card_id'=>$cardId])->where(['member_id'=>$memberId])->find();[m
[32m+[m[41m  [m	[32m// //var_dump($info::getLastSql());[m
[32m+[m[41m  [m	[32m// dump($info->memberCreditcard->card_bankname);[m
[32m+[m[41m  [m	[32m// dump($info->memberCashcard->card_bankname);[m
[32m+[m[41m  [m	[32m// die;[m
 [m
[31m-    $this->assign('info',$info);[m
[31m-    $this->assign('price',$price);[m
[31m-    $this->assign('passagewayId',$passagewayId);[m
[32m+[m[41m  [m	[32m$this->assign('info',$info);[m
[32m+[m[41m  [m	[32m$this->assign('price',$price);[m
[32m+[m[41m  [m	[32m$this->assign('passagewayId',$passagewayId);[m
 [m
[31m-    return view("Userurl/jinyifu");[m
[32m+[m[41m  [m	[32mreturn view("Userurl/jinyifu");[m
   }[m
 [m
   #金易付发送验证码[m
   public function jinyifu_sms(){[m
[31m-    // var_dump(Request::instance()->param('phone'));die;[m
[31m-     #验证手机/发送对象是否存在[m
[31m-         if(!phone_check(Request::instance()->param('phone')))[m
[31m-             return ['code'=>401];[m
[32m+[m[41m  [m	[32m// var_dump(Request::instance()->param('phone'));die;[m
[32m+[m[41m  [m	[32m #验证手机/发送对象是否存在[m
[32m+[m[41m      [m	[32m if(!phone_check(Request::instance()->param('phone')))[m
[32m+[m[41m      [m	[41m [m	[32m return ['code'=>401];[m
            #随机一个验证码[m
            $code=verify_code(System::getName('code_number'));[m
            // var_dump($code);die;[m
[36m@@ -1275,73 +1253,34 @@[m [mclass Userurl extends Controller[m
 [m
   #H5有积分前台通知地址[m
   public function H5youjifen($tradeNo){[m
[31m-[m
[31m-    //   echo "666";[m
[31m-    //   // echo str_pad("",4096);[m
[31m-    // {//断开连接的代码    [m
[31m-    //     $size=ob_get_length();    [m
[31m-    //     header("Content-Length: $size");  //告诉浏览器数据长度,浏览器接收到此长度数据后就不再接收数据  [m
[31m-    //     header("Connection: Close");      //告诉浏览器关闭当前连接,即为短连接  [m
[31m-    //     ob_flush();    [m
[31m-    //     flush();    [m
[31m-    // }    [m
[31m-      sleep(3);[m
[31m-      // var_dump(132);die;[m
[31m-    $order=CashOrder::get(['order_no'=>$tradeNo]);[m
[31m-    $passway=Passageway::get($order->order_passway);[m
[31m-    $member=Members::get($order->order_member);[m
[31m-[m
[31m-    #查询订单是否成功[m
[31m-    $url="http://kjnq.jct8.com/quickpay/Query/".$passway->passageway_mech."/".$tradeNo;[m
[31m-    $curl = curl_init(); // 启动一个CURL会话[m
[31m-    curl_setopt($curl, CURLOPT_URL, $url);[m
[31m-    curl_setopt($curl, CURLOPT_HEADER, 0);[m
[31m-    curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);[m
[31m-    curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false); // 跳过证书检查[m
[31m-    $data = curl_exec($curl);     //返回api的json对象[m
[31m-    //关闭URL请求[m
[31m-    curl_close($curl);[m
[31m-    $return=json_decode($data,true);[m
[31m-    // var_dump($return);die;[m
[31m-    if($return['code']=='00'){[m
[31m-      if(isset($return['payStatus']) && $return['payStatus']=='Y'){[m
[31m-         $passwayitem=PassagewayItem::get(['item_group'=>$member->member_group_id,'item_passageway'=>$passway->passageway_id]);[m
[31m-         $Commission_info=Commissions::where(['commission_from'=>$order->order_id,'commission_type'=>1])->find();[m
[31m-         if(!$Commission_info){[m
[31m-                $fenrun= new \app\api\controller\Commission();[m
[31m-                $fenrun_result=$fenrun->MemberFenRun($order->order_member,$order->order_money,$order->order_passway,1,'套现手续费分润',$order->order_id);[m
[31m-         }else{[m
[31m-            $fenrun_result['code']=-1;[m
[31m-         }[m
[31m-         $order->order_state=2;[m
[31m-[m
[31m-      }else{[m
[31m-        $order->order_state=-1;[m
[31m-         $fenrun_result['code']=-1;[m
[31m-      }[m
[31m-[m
[31m-    }elseif($return['code']=='01'){[m
[31m-      $order->order_state=-1;[m
[31m-       $fenrun_result['code']=-1;[m
[31m-    }[m
[32m+[m[41m  [m	[32m$order=CashOrder::get(['order_no'=>$tradeNo]);[m
[32m+[m[41m  [m	[32m$passway=Passageway::get($order->order_passway);[m
[32m+[m[41m  [m	[32m$member=Member::get($order->order_member);[m
[32m+[m[41m  [m	[32m#通道费率[m
[32m+[m[32m     $passwayitem=PassagewayItem::get(['item_group'=>$member->member_group_id,'item_passageway'=>$passway->passageway_id]);[m
[32m+[m[41m  [m	[32m $Commission_info=Commissions::where(['commission_from'=>$order->order_id,'commission_type'=>1])->find();[m
[32m+[m[32m     if(!$Commission_info){[m
[32m+[m[32m            $fenrun= new \app\api\controller\Commission();[m
[32m+[m[32m            $fenrun_result=$fenrun->MemberFenRun($order->order_member,$order->order_money,$order->order_passway,1,'套现手续费分润',$order->order_id);[m
[32m+[m[32m     }else{[m
[32m+[m[32m        $fenrun_result['code']=-1;[m
[32m+[m[32m     }[m
 [m
      if($fenrun_result['code']=="200")[m
      {[m
[31m-         $order->order_fen=$fenrun_result['leftmoney'];[m
[32m+[m		[32m $order->order_fen=$fenrun_result['leftmoney'];[m
          $order->order_buckle=$passwayitem->item_charges/100;[m
          $order->order_platform=$order->order_charge-($order->order_money*$passway->passageway_rate/100)+$passwayitem->item_charges-$passway->passageway_income;[m
      }[m
[31m-        else    [m
[32m+[m		[32melse[m[41m	[m
      {[m
[31m-             $order->order_fen=-1;[m
[32m+[m			[32m $order->order_fen=-1;[m
      }[m
 [m
       $res = $order->save();[m
[31m-     if ($res) {[m
[31m-      $this->assign('data',$fenrun_result);[m
[31m-      $this->assign('url',$url);[m
[31m-        return view("Userurl/H5youjifen");[m
[31m-     }[m
[32m+[m	[32m if ($res) {[m
[32m+[m	[41m [m	[32mreturn view("Userurl/H5youjifen");[m
[32m+[m	[32m }[m
   }[m
 [m
   public function parents($phone){[m
[36m@@ -1382,48 +1321,4 @@[m [mclass Userurl extends Controller[m
     $this->assign("list",$list);[m
     return view("Userurl/credit_card");[m
   }[m
[31m-[m
[31m-[m
[31m-    public function get_team($id){[m
[31m-      $parent=$this->get($id);[m
[31m-        // 输出Excel文件头，可把user.csv换成你要的文件名  [m
[31m-  header('Content-Type: application/vnd.ms-excel');  [m
[31m-  header('Content-Disposition: attachment;filename="user.csv"');  [m
[31m-  header('Cache-Control: max-age=0');     [m
[31m-  // 从数据库中获取数据，为了节省内存，不要把数据一次性读到内存，从句柄中一行一行读即可      [m
[31m-  // 打开PHP文件句柄，php://output 表示直接输出到浏览器  [m
[31m- $fp = fopen('php://output', 'a');    [m
[31m- // 输出Excel列名信息  [m
[31m- $head = array('姓名');  [m
[31m- // foreach ($head as $i => $v) {  [m
[31m-     // CSV的Excel支持GBK编码，一定要转换，否则乱码  [m
[31m-     $head[0] = iconv('utf-8', 'gbk', $head[0]);  [m
[31m- // }    [m
[31m- // 将数据通过fputcsv写到文件句柄  [m
[31m- fputcsv($fp, $head);   [m
[31m- // 计数器   [m
[31m- // 每隔$limit行，刷新一下输出buffer，不要太大，也不要太小  [m
[31m-   [m
[31m- // 逐行取出数据，不浪费内存  [m
[31m- foreach ($parent as $key => $value) {[m
[31m-         ob_flush();  [m
[31m-         flush();  [m
[31m-         $row[0] = iconv('utf-8', 'gbk', $value['member_nick']);  [m
[31m-     fputcsv($fp, $row);  [m
[31m- }[m
[31m-[m
[31m-      [m
[31m-    }[m
[31m-    public function get($id){[m
[31m-        $parent=MemberRelation::with('member')->where(['relation_parent_id'=>$id])->select();[m
[31m-        $data=[];[m
[31m-        foreach ($parent as $key => $value) {[m
[31m-            $re=$this->get($value['relation_member_id']);[m
[31m-[m
[31m-              $data=array_merge($data,$re);[m
[31m-[m
[31m-        }[m
[31m-              $data=array_merge($data,$parent);[m
[31m-        return $data;[m
[31m-      }[m
 }[m
\ No newline at end of file[m
